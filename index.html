<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Restaurant Oracle</title>
    
    <!-- Supabase setup will be done inline in main script using dynamic import -->
    
    <!-- Web App Icons -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Restaurant Oracle">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Restaurant Oracle">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Smart Kitchen Management">
    <link rel="manifest" href="manifest.json">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root{--font-size:14px;--font-scale:1}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0a0a1a,#1a1a3a);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
        
        /* Login Screen - Warm Coral/Peach Theme with Dark Mode inputs */
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:40px 20px;position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#f5c97a 0%,#f5a76c 25%,#e8846b 50%,#e07b65 75%,#d4725f 100%)}
        .login-screen.hidden{display:none}
        .login-logo{width:100%;max-width:340px;height:auto;margin-bottom:16px;border-radius:20px}
        .login-title{font-size:28px;font-weight:700;color:#2d3436;margin-bottom:8px;text-shadow:0 1px 2px rgba(0,0,0,.1)}
        .login-subtitle{font-size:14px;color:#4a3f3a;margin-bottom:32px;text-align:center}
        .login-box{width:100%;max-width:340px;background:rgba(30,30,50,.95);border:1px solid rgba(232,132,107,.3);border-radius:20px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
        .login-tabs{display:flex;margin-bottom:20px;background:rgba(0,0,0,.3);border-radius:10px;padding:4px}
        .login-tab{flex:1;padding:10px;text-align:center;font-size:14px;font-weight:600;color:#a0aec0;cursor:pointer;border-radius:8px;transition:all .2s}
        .login-tab.active{background:linear-gradient(135deg,#e8846b,#f5a76c);color:#fff}
        .login-form{display:none}
        .login-form.active{display:block}
        .login-input{width:100%;padding:14px 16px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#e0e6ed;font-size:14px;margin-bottom:12px}
        .login-input:focus{outline:none;border-color:#e8846b;box-shadow:0 0 0 3px rgba(232,132,107,.3)}
        .login-input::placeholder{color:#636e72}
        .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#e8846b,#f5a76c);border:none;border-radius:10px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s}
        .login-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(232,132,107,.4)}
        .login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .login-error{background:rgba(214,48,49,.2);color:#ff7675;padding:12px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none}
        .login-error.show{display:block}
        .login-success{background:rgba(0,184,148,.2);color:#00b894;padding:12px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none}
        .login-success.show{display:block}
        .login-divider{text-align:center;color:#636e72;font-size:12px;margin:20px 0;position:relative}
        .login-divider::before,.login-divider::after{content:'';position:absolute;top:50%;width:40%;height:1px;background:rgba(255,255,255,.1)}
        .login-divider::before{left:0}
        .login-divider::after{right:0}
        .sync-status{position:fixed;bottom:20px;right:20px;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;display:none;z-index:1000}
        .sync-status.syncing{display:block;background:rgba(253,203,110,.2);color:#fdcb6e}
        .sync-status.synced{display:block;background:rgba(0,184,148,.2);color:#00b894}
        .sync-status.offline{display:block;background:rgba(214,48,49,.2);color:#ff7675}
        .sync-status.unsaved{display:block;background:rgba(116,185,255,.2);color:#74b9ff}
        .user-menu{position:relative}
        .user-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#00b894,#00cec9);border:none;color:#fff;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .user-dropdown{position:absolute;top:44px;right:0;background:#2d2d4a;border-radius:12px;padding:8px;min-width:180px;box-shadow:0 10px 40px rgba(0,0,0,.5);display:none;z-index:50}
        .user-dropdown.open{display:block}
        .user-dropdown-item{padding:10px 12px;border-radius:8px;font-size:13px;color:#e0e6ed;cursor:pointer;display:flex;align-items:center;gap:8px}
        .user-dropdown-item:hover{background:rgba(255,255,255,.1)}
        .user-dropdown-item.logout{color:#ff7675}
        .user-dropdown-header{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:4px}
        .user-dropdown-name{font-weight:600;color:#e0e6ed;font-size:14px}
        .user-dropdown-email{font-size:11px;color:#a0aec0;margin-top:2px}
        
        .phone{width:390px;height:844px;background:#1a1a2e;border-radius:44px;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,.5),0 0 0 12px #2a2a3e;display:flex;flex-direction:column;position:relative}
        .phone.hidden{display:none}
        .status{height:50px;display:flex;justify-content:space-between;align-items:flex-end;padding:0 28px 8px;font-size:calc(14px * var(--font-scale));font-weight:600;color:#e0e6ed}
        .header{padding:12px 20px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
        .header h1{font-size:calc(20px * var(--font-scale));color:#e0e6ed}
        .header p{font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-top:2px}
        .content{flex:1;overflow-y:auto;padding:16px;font-size:calc(var(--font-size) * var(--font-scale))}
        .content::-webkit-scrollbar{width:4px}
        .content::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
        .tabs-container{display:flex;align-items:center;border-top:1px solid rgba(255,255,255,.1);position:relative;background:#1a1a2e}
        .tabs-wrap{flex:1;overflow-x:scroll;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;scroll-behavior:smooth}
        .tabs-wrap::-webkit-scrollbar{display:none}
        .tabs{display:flex;padding:8px 4px 30px;width:max-content;gap:4px}
        .tab{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 12px;cursor:pointer;border-radius:10px;min-width:65px;flex-shrink:0}
        .scroll-hint{width:28px;height:60px;display:flex;align-items:center;justify-content:center;background:#1a1a2e;color:#a29bfe;font-size:28px;font-weight:bold;cursor:pointer;flex-shrink:0;border:none;padding-bottom:20px}
        .scroll-hint:hover{color:#fff;background:rgba(108,92,231,.3)}
        .scroll-hint.scroll-left{border-right:1px solid rgba(255,255,255,.1)}
        .scroll-hint.scroll-right{border-left:1px solid rgba(255,255,255,.1)}
        .tab:hover{background:rgba(255,255,255,.05)}
        .tab span:first-child{font-size:calc(28px * var(--font-scale));opacity:.85;transition:all .2s}
        .tab span:last-child{font-size:calc(10px * var(--font-scale));font-weight:600;color:#a0aec0;white-space:nowrap}
        .tab.active span:first-child{opacity:1;transform:scale(1.1)}
        .tab.active span:last-child{font-weight:700}
        .tab[data-t="inventory"].active span:last-child{color:#a29bfe}
        .tab[data-t="shopping"].active span:last-child{color:#e17055}
        .tab[data-t="prep"].active span:last-child{color:#fd79a8}
        .tab[data-t="ingredients"].active span:last-child{color:#00b894}
        .tab[data-t="recipes"].active span:last-child{color:#fdcb6e}
        .tab[data-t="menu"].active span:last-child{color:#74b9ff}
        .tab[data-t="log"].active span:last-child{color:#81ecec}
        .tab[data-t="admin"].active span:last-child{color:#b2bec3}
        .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;margin-bottom:10px}
        .card:hover{border-color:rgba(255,255,255,.2)}
        .card-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .card-t{font-size:calc(15px * var(--font-scale));font-weight:600;color:#e0e6ed}
        .card-s{font-size:calc(11px * var(--font-scale));color:#a0aec0}
        .card-cnt{font-size:calc(11px * var(--font-scale));color:#a0aec0;background:rgba(0,0,0,.2);padding:4px 8px;border-radius:6px}
        .sec{font-size:calc(12px * var(--font-scale));font-weight:700;color:#a29bfe;margin:16px 0 8px;display:flex;align-items:center;gap:6px}
        .sec.ing{color:#00b894}
        .sec.prep{color:#fd79a8}
        .sec.menu{color:#74b9ff}
        .sec.log{color:#81ecec}
        .btn{padding:10px 16px;border-radius:10px;font-weight:600;font-size:calc(13px * var(--font-scale));cursor:pointer;border:none;transition:all .2s}
        .btn-p{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff}
        .btn-p:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,92,231,.4)}
        .btn-s{background:rgba(255,255,255,.1);color:#e0e6ed}
        .btn-s:hover{background:rgba(255,255,255,.15)}
        .btn-sm{padding:6px 10px;font-size:calc(11px * var(--font-scale))}
        .btn-d{background:rgba(214,48,49,.2);color:#d63031}
        .form-g{margin-bottom:12px}
        .form-l{display:block;font-size:calc(11px * var(--font-scale));font-weight:600;color:#a0aec0;margin-bottom:4px}
        .form-i{width:100%;padding:10px 12px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e0e6ed;font-size:calc(13px * var(--font-scale))}
        .form-i:focus{outline:none;border-color:#a29bfe}
        .form-i::placeholder{color:#636e72}
        select.form-i{cursor:pointer}
        select.form-i optgroup{background:#2d2d4a;color:#a29bfe;font-weight:700;padding:4px 0}
        select.form-i option{background:#1a1a2e;color:#e0e6ed;padding:8px}
        .header-add{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:#fff;font-size:22px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(108,92,231,.4);display:flex;align-items:center;justify-content:center;transition:all .2s}
        .header-add:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(108,92,231,.5)}
        .header-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#a0aec0;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .header-btn:hover:not(:disabled){background:rgba(255,255,255,.2);color:#e0e6ed}
        .header-btn:disabled{cursor:not-allowed;opacity:0.4}
        .font-control-bar{display:none;margin-top:10px;padding:10px 12px;background:rgba(0,0,0,.2);border-radius:8px;align-items:center;gap:10px}
        .font-control-bar.open{display:flex}
        .font-control-bar input[type="range"]{flex:1;accent-color:#a29bfe;height:4px}
        .modal-o{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center}
        .modal-o.open{display:flex}
        .modal{background:#1a1a2e;border-radius:20px;padding:20px;width:340px;max-height:80vh;overflow-y:auto}
        .modal-t{font-size:calc(18px * var(--font-scale));font-weight:700;color:#e0e6ed;margin-bottom:16px}
        .del-btn{background:none;border:none;color:#d63031;cursor:pointer;padding:4px;font-size:calc(16px * var(--font-scale))}
        .del-btn:hover{opacity:.7}
        .shop-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,.2);border-radius:10px;margin-bottom:8px}
        .shop-item.checked{opacity:.5}
        .shop-check{width:24px;height:24px;border-radius:6px;border:2px solid #e17055;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;font-size:calc(14px * var(--font-scale))}
        .shop-check.checked{background:#e17055;color:#fff}
        .shop-info{flex:1}
        .shop-name{font-size:calc(14px * var(--font-scale));color:#e0e6ed;font-weight:600}
        .shop-meta{font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-top:2px}
        .shop-qty{font-size:calc(16px * var(--font-scale));font-weight:700;color:#e17055}
        .shop-undo{background:none;border:none;color:#fdcb6e;cursor:pointer;font-size:calc(12px * var(--font-scale));padding:4px 8px;border-radius:4px}
        .shop-undo:hover{background:rgba(253,203,110,.2)}
        .rec-ing{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:rgba(0,0,0,.2);border-radius:6px;margin-bottom:4px}
        .rec-ing-name{font-size:calc(12px * var(--font-scale));color:#e0e6ed}
        .archive-header{margin-top:24px;padding:12px;background:rgba(0,0,0,.3);border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
        .archive-header span{color:#636e72;font-size:calc(12px * var(--font-scale));font-weight:600}
        .log-item{padding:10px 12px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:6px;border-left:3px solid #81ecec}
        .log-item .log-action{font-size:calc(13px * var(--font-scale));color:#e0e6ed;font-weight:500}
        .log-item .log-meta{font-size:calc(10px * var(--font-scale));color:#a0aec0;margin-top:4px}
        .standalone-badge{background:rgba(253,203,110,.2);color:#fdcb6e;font-size:calc(9px * var(--font-scale));padding:2px 6px;border-radius:4px;font-weight:600}
        .min-qty-badge{background:rgba(0,184,148,.2);color:#00b894;font-size:calc(9px * var(--font-scale));padding:2px 6px;border-radius:4px;margin-left:4px}
        .sub-area{margin-left:12px;padding-left:12px;border-left:2px solid rgba(255,255,255,.1)}
        .add-toggle{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;margin-top:8px;border-radius:6px;background:rgba(108,92,231,.1);cursor:pointer;transition:background .2s}
        .add-toggle:hover{background:rgba(108,92,231,.2)}
        .add-toggle-t{font-size:calc(12px * var(--font-scale));color:#a29bfe;font-weight:500}
        .add-form{display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.1)}
        .add-form.open{display:block}
        .inv-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:background .2s}
        .inv-item:hover{background:rgba(108,92,231,.2)}
        .inv-item-name{font-size:calc(13px * var(--font-scale));color:#e0e6ed}
        .inv-item-sub{font-size:calc(10px * var(--font-scale));color:#a0aec0;margin-left:4px}
        .inv-item-controls{display:flex;align-items:center;gap:6px}
        .status-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:calc(10px * var(--font-scale));font-weight:600}
        .status-stocked{background:rgba(0,184,148,.2);color:#00b894}
        .status-low{background:rgba(253,203,110,.2);color:#fdcb6e}
        .status-critical{background:rgba(214,48,49,.2);color:#d63031}
        .section-label{font-size:calc(10px * var(--font-scale));font-weight:700;color:#a0aec0;margin:12px 0 6px;padding-left:4px}
        .recipe-comp{padding:8px;background:rgba(0,0,0,.15);border-radius:6px;margin-bottom:4px;border-left:2px solid}
        .recipe-comp.ing{border-color:#00b894}
        .recipe-comp.prep{border-color:#fd79a8}
        .recipe-comp.rec{border-color:#fdcb6e}
    </style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="login-screen">
    <img src="icon.png" alt="Restaurant Oracle" class="login-logo">
    <div class="login-title">Restaurant Oracle</div>
    <div class="login-subtitle">Smart Kitchen Management for LaChona</div>
    <div class="login-box">
        <div class="login-tabs">
            <div class="login-tab active" onclick="switchLoginTab('signin')">Sign In</div>
            <div class="login-tab" onclick="switchLoginTab('signup')">Sign Up</div>
        </div>
        <div class="login-error" id="login-error"></div>
        <div class="login-success" id="login-success"></div>
        
        <!-- Sign In Form -->
        <div class="login-form active" id="signin-form">
            <input type="email" class="login-input" id="signin-email" placeholder="Email address">
            <input type="password" class="login-input" id="signin-password" placeholder="Password">
            <button class="login-btn" onclick="signIn()" id="signin-btn">Sign In</button>
            <div style="text-align:center;margin-top:12px">
                <a href="#" onclick="showResetPassword();return false;" style="color:#f5a76c;font-size:13px;text-decoration:none">Forgot Password?</a>
            </div>
        </div>
        
        <!-- Reset Password Form -->
        <div class="login-form" id="reset-form">
            <p style="color:#a0aec0;font-size:13px;margin-bottom:16px;text-align:center">Enter your email and we'll send you a link to reset your password.</p>
            <input type="email" class="login-input" id="reset-email" placeholder="Email address">
            <button class="login-btn" onclick="sendResetEmail()" id="reset-btn">Send Reset Link</button>
            <div style="text-align:center;margin-top:12px">
                <a href="#" onclick="switchLoginTab('signin');return false;" style="color:#a0aec0;font-size:13px;text-decoration:none">‚Üê Back to Sign In</a>
            </div>
        </div>
        
        <!-- Update Password Form (shown after clicking reset link) -->
        <div class="login-form" id="update-password-form">
            <p style="color:#a0aec0;font-size:13px;margin-bottom:16px;text-align:center">Enter your new password below.</p>
            <input type="password" class="login-input" id="new-password" placeholder="New password (min 6 characters)">
            <input type="password" class="login-input" id="confirm-password" placeholder="Confirm new password">
            <button class="login-btn" onclick="updatePassword()" id="update-password-btn">Update Password</button>
        </div>
        
        <!-- Sign Up Form -->
        <div class="login-form" id="signup-form">
            <input type="text" class="login-input" id="signup-name" placeholder="Your name">
            <input type="email" class="login-input" id="signup-email" placeholder="Email address">
            <input type="password" class="login-input" id="signup-password" placeholder="Password (min 6 characters)">
            <button class="login-btn" onclick="signUp()" id="signup-btn">Create Account</button>
        </div>
    </div>
</div>

<!-- Sync Status Indicator -->
<div class="sync-status" id="sync-status"></div>

<!-- Main App -->
<div class="phone hidden" id="app-container">
    <div class="status"><span>Restaurant Oracle</span><span id="connection-status"></span></div>
    <div class="header">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <h1 id="hdr-t">üì¶ Inventory</h1>
                <p id="hdr-s">Items</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <button class="header-btn" id="undo-btn" onclick="undoAction()" title="Undo" disabled>‚Ü©</button>
                <button class="header-btn" id="font-btn" onclick="toggleFontControl()" title="Text Size">üî§</button>
                <div class="user-menu">
                    <button class="user-btn" id="user-btn" onclick="toggleUserMenu()">?</button>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-name" id="user-name">User</div>
                            <div class="user-dropdown-email" id="user-email">user@email.com</div>
                        </div>
                        <div class="user-dropdown-item" onclick="syncNow()">üîÑ Sync Now</div>
                        <div class="user-dropdown-item" onclick="exportData()">üì§ Export Backup</div>
                        <div class="user-dropdown-item logout" onclick="signOut()">üö™ Sign Out</div>
                    </div>
                </div>
                <button class="header-add" id="fab" onclick="openAdd()">+</button>
            </div>
        </div>
        <div class="font-control-bar" id="font-control-bar">
            <span style="font-size:calc(11px * var(--font-scale));color:#a0aec0">Text Size:</span>
            <input type="range" min="0.8" max="1.4" step="0.1" value="1" id="font-slider" onchange="setFontScale(this.value)">
            <span id="font-scale-val" style="font-size:calc(12px * var(--font-scale));color:#e0e6ed;min-width:36px">100%</span>
        </div>
    </div>
    <div class="content" id="content"></div>
    <div class="tabs-container">
        <div class="scroll-hint scroll-left" id="scroll-left" onclick="scrollTabs(-1)">‚Äπ</div>
        <div class="tabs-wrap" id="tabs-wrap">
            <div class="tabs">
                <div class="tab active" data-t="inventory" onclick="go('inventory')"><span>üì¶</span><span>Inventory</span></div>
                <div class="tab" data-t="shopping" onclick="go('shopping')"><span>üõí</span><span>Shopping</span></div>
                <div class="tab" data-t="prep" onclick="go('prep')"><span>üë®‚Äçüç≥</span><span>Prep</span></div>
                <div class="tab" data-t="ingredients" onclick="go('ingredients')"><span>ü•¨</span><span>Ingredients</span></div>
                <div class="tab" data-t="recipes" onclick="go('recipes')"><span>üìñ</span><span>Recipes</span></div>
                <div class="tab" data-t="menu" onclick="go('menu')"><span>üçΩÔ∏è</span><span>Menu</span></div>
                <div class="tab" data-t="log" onclick="go('log')"><span>üìã</span><span>Log</span></div>
                <div class="tab" data-t="admin" onclick="go('admin')"><span>‚öôÔ∏è</span><span>Admin</span></div>
            </div>
        </div>
        <div class="scroll-hint scroll-right" id="scroll-right" onclick="scrollTabs(1)">‚Ä∫</div>
    </div>
    <div class="modal-o" id="modal-o"><div class="modal" id="modal"></div></div>
</div>
<script>
// ==================== SUPABASE CONFIG ====================
var SUPABASE_URL='https://quoqhfbibsmsdicrddym.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1b3FoZmJpYnNtc2RpY3JkZHltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njc5MDUsImV4cCI6MjA4NDI0MzkwNX0.DaqF9ToMtgqdNZJfpj-nueGJBeQSq_Gutkl2bXhqhpo';
var supabase=null;
var currentAuthUser=null;
var isOnline=navigator.onLine;
var syncQueue=[];
var realtimeChannel=null;

// Initialize Supabase using dynamic import
async function initSupabase(){
    try{
        console.log('Loading Supabase library...');
        var module = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        supabase = module.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase initialized successfully');
        return true;
    }catch(e){
        console.error('Supabase init error:', e);
        return false;
    }
}

// ==================== AUTH FUNCTIONS ====================
function switchLoginTab(tab){
    document.querySelectorAll('.login-tab').forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.login-form').forEach(function(f){f.classList.remove('active');});
    if(tab==='signin'||tab==='signup'){
        document.querySelector('.login-tab:nth-child('+(tab==='signin'?'1':'2')+')').classList.add('active');
    }
    document.getElementById(tab+'-form').classList.add('active');
    hideLoginMessages();
}

function showResetPassword(){
    document.querySelectorAll('.login-tab').forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.login-form').forEach(function(f){f.classList.remove('active');});
    document.getElementById('reset-form').classList.add('active');
    // Pre-fill email if already entered
    var signinEmail=document.getElementById('signin-email').value.trim();
    if(signinEmail){
        document.getElementById('reset-email').value=signinEmail;
    }
    hideLoginMessages();
}

async function sendResetEmail(){
    hideLoginMessages();
    var email=document.getElementById('reset-email').value.trim();
    
    if(!email){
        showLoginError('Please enter your email address');
        return;
    }
    
    document.getElementById('reset-btn').disabled=true;
    document.getElementById('reset-btn').textContent='Sending...';
    
    try{
        var result=await supabase.auth.resetPasswordForEmail(email,{
            redirectTo:window.location.origin+window.location.pathname
        });
        if(result.error)throw result.error;
        showLoginSuccess('Password reset link sent! Check your email.');
        setTimeout(function(){
            switchLoginTab('signin');
        },3000);
    }catch(err){
        showLoginError(err.message||'Failed to send reset email');
    }
    
    document.getElementById('reset-btn').disabled=false;
    document.getElementById('reset-btn').textContent='Send Reset Link';
}

function hideLoginMessages(){
    document.getElementById('login-error').classList.remove('show');
    document.getElementById('login-success').classList.remove('show');
}

function showLoginError(msg){
    var el=document.getElementById('login-error');
    el.textContent=msg;
    el.classList.add('show');
}

function showLoginSuccess(msg){
    var el=document.getElementById('login-success');
    el.textContent=msg;
    el.classList.add('show');
}

async function signIn(){
    hideLoginMessages();
    var email=document.getElementById('signin-email').value.trim();
    var password=document.getElementById('signin-password').value;
    
    if(!email||!password){
        showLoginError('Please enter email and password');
        return;
    }
    
    document.getElementById('signin-btn').disabled=true;
    document.getElementById('signin-btn').textContent='Signing in...';
    
    try{
        var result=await supabase.auth.signInWithPassword({email:email,password:password});
        if(result.error)throw result.error;
        // Auth state change will handle the rest
    }catch(err){
        showLoginError(err.message||'Sign in failed');
        document.getElementById('signin-btn').disabled=false;
        document.getElementById('signin-btn').textContent='Sign In';
    }
}

async function signUp(){
    hideLoginMessages();
    var name=document.getElementById('signup-name').value.trim();
    var email=document.getElementById('signup-email').value.trim();
    var password=document.getElementById('signup-password').value;
    
    if(!name||!email||!password){
        showLoginError('Please fill in all fields');
        return;
    }
    if(password.length<6){
        showLoginError('Password must be at least 6 characters');
        return;
    }
    
    document.getElementById('signup-btn').disabled=true;
    document.getElementById('signup-btn').textContent='Creating account...';
    
    try{
        var result=await supabase.auth.signUp({
            email:email,
            password:password,
            options:{data:{name:name}}
        });
        if(result.error)throw result.error;
        
        // Check if this is the first user (make them owner)
        var existingMembers = await supabase.from('team_members').select('id').limit(1);
        var isFirstUser = !existingMembers.data || existingMembers.data.length === 0;
        
        // Add to team_members table
        if(result.data.user){
            await supabase.from('team_members').insert({
                user_id:result.data.user.id,
                name:name,
                email:email,
                role: isFirstUser ? 'owner' : 'employee'
            });
        }
        
        showLoginSuccess('Account created!' + (isFirstUser ? ' You are the Owner.' : '') + ' Check your email to confirm, then sign in.');
        switchLoginTab('signin');
    }catch(err){
        showLoginError(err.message||'Sign up failed');
    }
    
    document.getElementById('signup-btn').disabled=false;
    document.getElementById('signup-btn').textContent='Create Account';
}

async function signOut(){
    try{
        await supabase.auth.signOut();
        currentAuthUser=null;
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('user-dropdown').classList.remove('open');
    }catch(err){
        console.error('Sign out error:',err);
    }
}

function toggleUserMenu(){
    document.getElementById('user-dropdown').classList.toggle('open');
}

// Close user menu when clicking outside
document.addEventListener('click',function(e){
    if(!e.target.closest('.user-menu')){
        document.getElementById('user-dropdown').classList.remove('open');
    }
});

async function onAuthStateChange(event,session){
    console.log('Auth event:', event, 'Session:', !!session);
    
    // Check URL for recovery tokens (type=recovery in hash or query)
    var hashParams = new URLSearchParams(window.location.hash.substring(1));
    var queryParams = new URLSearchParams(window.location.search);
    var isRecoveryInUrl = hashParams.get('type') === 'recovery' || queryParams.get('type') === 'recovery';
    
    // Handle password recovery - show update password form
    // This must be checked FIRST, even if session exists
    if(event === 'PASSWORD_RECOVERY' || isRecoveryInUrl || window.isPasswordRecovery){
        window.isPasswordRecovery = true;
        console.log('Password recovery mode activated');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        // Show update password form
        document.querySelectorAll('.login-tab').forEach(function(t){t.classList.remove('active');});
        document.querySelectorAll('.login-form').forEach(function(f){f.classList.remove('active');});
        document.getElementById('update-password-form').classList.add('active');
        showLoginSuccess('Please enter your new password.');
        return;
    }
    
    if(session&&session.user){
        currentAuthUser=session.user;
        
        // Update UI
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        
        var userName=session.user.user_metadata?.name||session.user.email.split('@')[0];
        document.getElementById('user-name').textContent=userName;
        document.getElementById('user-email').textContent=session.user.email;
        document.getElementById('user-btn').textContent=userName.charAt(0).toUpperCase();
        
        // Load data from Supabase
        await loadFromSupabase();
        
        // Setup real-time sync
        setupRealtimeSync();
        
        render();
    }else{
        currentAuthUser=null;
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        
        // Cleanup realtime
        if(realtimeChannel){
            supabase.removeChannel(realtimeChannel);
            realtimeChannel=null;
        }
    }
}

async function updatePassword(){
    hideLoginMessages();
    var newPassword=document.getElementById('new-password').value;
    var confirmPassword=document.getElementById('confirm-password').value;
    
    if(!newPassword||!confirmPassword){
        showLoginError('Please fill in both password fields');
        return;
    }
    if(newPassword.length<6){
        showLoginError('Password must be at least 6 characters');
        return;
    }
    if(newPassword!==confirmPassword){
        showLoginError('Passwords do not match');
        return;
    }
    
    document.getElementById('update-password-btn').disabled=true;
    document.getElementById('update-password-btn').textContent='Updating...';
    
    try{
        var result=await supabase.auth.updateUser({password:newPassword});
        if(result.error)throw result.error;
        showLoginSuccess('Password updated successfully! Signing you in...');
        // Clear the recovery flag
        window.isPasswordRecovery = false;
        // Clear the hash from URL
        history.replaceState(null,'',window.location.pathname);
        // Reload after a moment to complete sign in
        setTimeout(function(){
            window.location.reload();
        }, 1500);
    }catch(err){
        showLoginError(err.message||'Failed to update password');
        document.getElementById('update-password-btn').disabled=false;
        document.getElementById('update-password-btn').textContent='Update Password';
    }
}

// ==================== SUPABASE DATA FUNCTIONS ====================
async function loadFromSupabase(){
    showSyncStatus('syncing');
    try{
        // Load all tables
        var [areas,cats,menuCats,units,ings,inv,shopping,preps,recs,menus,log]=await Promise.all([
            supabase.from('areas').select('*').order('id'),
            supabase.from('cats').select('*').order('id'),
            supabase.from('menu_cats').select('*').order('id'),
            supabase.from('units').select('*').order('id'),
            supabase.from('ings').select('*').order('id'),
            supabase.from('inv').select('*').order('id'),
            supabase.from('shopping').select('*').order('id'),
            supabase.from('preps').select('*').order('id'),
            supabase.from('recs').select('*').order('id'),
            supabase.from('menus').select('*').order('id'),
            supabase.from('log').select('*').order('created_at',{ascending:false}).limit(100)
        ]);
        
        // Check if database has data, if not, migrate from localStorage/defaults
        if(!areas.data||areas.data.length===0){
            console.log('Database empty, migrating initial data...');
            await migrateToSupabase();
            return loadFromSupabase(); // Reload after migration
        }
        
        // Map database fields to local format
        D.areas=areas.data.map(mapAreaFromDb);
        D.cats=cats.data||[];
        D.menuCats=(menuCats.data||[]).map(function(c){return{id:c.id,name:c.name};});
        D.units=units.data||[];
        D.ings=(ings.data||[]).map(mapIngFromDb);
        D.inv=(inv.data||[]).map(mapInvFromDb);
        D.shopping=(shopping.data||[]).map(mapShoppingFromDb);
        D.preps=(preps.data||[]).map(mapPrepFromDb);
        D.recs=(recs.data||[]).map(mapRecFromDb);
        D.menus=(menus.data||[]).map(mapMenuFromDb);
        D.log=(log.data||[]).map(mapLogFromDb);
        
        // Load settings
        var settings=await supabase.from('settings').select('*');
        if(settings.data){
            settings.data.forEach(function(s){
                if(s.key==='autoAddToInv')D.autoAddToInv=s.value?1:0;
            });
        }
        
        showSyncStatus('synced');
    }catch(err){
        console.error('Load from Supabase error:',err);
        showSyncStatus('offline');
        // Fall back to localStorage
        loadAllDataLocal();
    }
}

// Field mapping functions (database snake_case to local camelCase)
function mapAreaFromDb(a){return{id:a.id,name:a.name,sections:a.sections||[],prep:a.prep||0};}
function mapIngFromDb(i){return{id:i.id,name:i.name,catId:i.cat_id,areaId:i.area_id,subArea:i.sub_area||'',defUnit:i.unit||'ea',archived:i.archived||0,standalone:0,minQty:i.par||0,cost:i.cost||0};}
function mapInvFromDb(i){return{id:i.id,areaId:i.area_id,subArea:i.sub_area||'',ingId:i.ing_id,qty:i.qty||0,unit:i.unit||'ea'};}
function mapShoppingFromDb(s){return{id:s.id,ingId:s.ing_id,qty:s.qty||0,unit:s.unit||'ea',checked:s.checked||0,savedForLater:s.saved_for_later||0};}
function mapPrepFromDb(p){return{id:p.id,name:p.name,recId:p.rec_id,onHand:p.on_hand||0,tgt:p.tgt||0,unit:p.unit||'batch',areaId:p.area_id};}
function mapRecFromDb(r){return{id:r.id,name:r.name,group:r.group_name||'',catId:r.cat_id,yield:r.yield||1,shelfLife:r.shelf_life||'',notes:r.notes||'',ings:r.ings||[],preps:r.preps||[],subRecs:r.sub_recs||[],photos:r.photos||[],videos:r.videos||[],archived:r.archived||0};}
function mapMenuFromDb(m){return{id:m.id,name:m.name,catId:m.cat_id,tgt:m.tgt||0,unitId:m.unit_id,ings:m.ings||[],preps:m.preps||[],recIds:m.rec_ids||[],archived:m.archived||0};}
function mapLogFromDb(l){return{id:l.id,action:l.action,location:l.location||'',detail:l.detail||'',user:l.user_name||'',time:l.created_at};}

// Mapping functions for saving (local camelCase to database snake_case)
function mapAreaToDb(a){return{id:a.id,name:a.name,sections:a.sections,prep:a.prep};}
function mapIngToDb(i){return{id:i.id,name:i.name,cat_id:i.catId,area_id:i.areaId,sub_area:i.subArea,unit:i.defUnit,archived:i.archived,par:i.minQty,cost:i.cost||0};}
function mapInvToDb(i){return{id:i.id,area_id:i.areaId,sub_area:i.subArea,ing_id:i.ingId,qty:i.qty,unit:i.unit};}
function mapShoppingToDb(s){return{id:s.id,ing_id:s.ingId,qty:s.qty,unit:s.unit,checked:s.checked,saved_for_later:s.savedForLater};}
function mapPrepToDb(p){return{id:p.id,name:p.name,rec_id:p.recId,on_hand:p.onHand,tgt:p.tgt,unit:p.unit,area_id:p.areaId};}
function mapRecToDb(r){return{id:r.id,name:r.name,group_name:r.group,cat_id:r.catId,yield:r.yield,shelf_life:r.shelfLife,notes:r.notes,ings:r.ings,preps:r.preps,sub_recs:r.subRecs,photos:r.photos,videos:r.videos,archived:r.archived};}
function mapMenuToDb(m){return{id:m.id,name:m.name,cat_id:m.catId,tgt:m.tgt,unit_id:m.unitId,ings:m.ings,preps:m.preps,rec_ids:m.recIds,archived:m.archived};}

async function migrateToSupabase(){
    console.log('Migrating data to Supabase...');
    showSyncStatus('syncing');
    
    try{
        // Insert default/localStorage data into Supabase
        if(D.areas.length)await supabase.from('areas').upsert(D.areas.map(mapAreaToDb));
        if(D.cats.length)await supabase.from('cats').upsert(D.cats);
        if(D.menuCats.length)await supabase.from('menu_cats').upsert(D.menuCats.map(function(c){return{id:c.id,name:c.name};}));
        if(D.units.length)await supabase.from('units').upsert(D.units);
        if(D.ings.length)await supabase.from('ings').upsert(D.ings.map(mapIngToDb));
        if(D.inv.length)await supabase.from('inv').upsert(D.inv.map(mapInvToDb));
        if(D.shopping.length)await supabase.from('shopping').upsert(D.shopping.map(mapShoppingToDb));
        if(D.preps.length)await supabase.from('preps').upsert(D.preps.map(mapPrepToDb));
        if(D.recs.length)await supabase.from('recs').upsert(D.recs.map(mapRecToDb));
        if(D.menus.length)await supabase.from('menus').upsert(D.menus.map(mapMenuToDb));
        
        console.log('Migration complete!');
        showSyncStatus('synced');
    }catch(err){
        console.error('Migration error:',err);
        showSyncStatus('offline');
    }
}

async function saveToSupabase(table,data,isDelete){
    if(!supabase||!currentAuthUser){
        saveAllDataLocal();
        return;
    }
    
    showSyncStatus('syncing');
    
    try{
        if(isDelete){
            await supabase.from(table).delete().eq('id',data.id);
        }else{
            await supabase.from(table).upsert(data);
        }
        showSyncStatus('synced');
    }catch(err){
        console.error('Save to Supabase error:',err);
        showSyncStatus('offline');
        // Queue for later
        syncQueue.push({table:table,data:data,isDelete:isDelete});
        saveAllDataLocal();
    }
}

async function syncNow(){
    if(!supabase||!currentAuthUser){
        alert('Not connected to cloud. Please sign in.');
        return;
    }
    
    showSyncStatus('syncing');
    
    try{
        // Save all current data to Supabase
        await Promise.all([
            supabase.from('areas').upsert(D.areas.map(mapAreaToDb)),
            supabase.from('cats').upsert(D.cats),
            supabase.from('menu_cats').upsert(D.menuCats.map(function(c){return{id:c.id,name:c.name};})),
            supabase.from('units').upsert(D.units),
            supabase.from('ings').upsert(D.ings.map(mapIngToDb)),
            supabase.from('inv').upsert(D.inv.map(mapInvToDb)),
            supabase.from('shopping').upsert(D.shopping.map(mapShoppingToDb)),
            supabase.from('preps').upsert(D.preps.map(mapPrepToDb)),
            supabase.from('recs').upsert(D.recs.map(mapRecToDb)),
            supabase.from('menus').upsert(D.menus.map(mapMenuToDb)),
            supabase.from('settings').upsert({id:1,key:'autoAddToInv',value:D.autoAddToInv?true:false})
        ]);
        showSyncStatus('synced');
    }catch(err){
        console.error('Sync error:',err);
        showSyncStatus('offline');
        alert('Sync failed: '+err.message);
    }
}

function setupRealtimeSync(){
    // Disabled for now - causes performance issues with reload loops
    // Users can manually sync with "Sync Now" button or refresh the page
    // Real-time sync will be re-enabled in a future update with smarter merging
    console.log('Real-time sync disabled for performance');
    return;
    
    /*
    if(!supabase||realtimeChannel)return;
    
    realtimeChannel=supabase.channel('db-changes')
        .on('postgres_changes',{event:'*',schema:'public'},function(payload){
            console.log('Realtime update:',payload);
            // Reload data on any change
            loadFromSupabase().then(render);
        })
        .subscribe();
    */
}

function showSyncStatus(status){
    var el=document.getElementById('sync-status');
    el.className='sync-status '+status;
    if(status==='syncing')el.textContent='‚è≥ Syncing...';
    else if(status==='synced')el.textContent='‚úì Synced';
    else if(status==='offline')el.textContent='‚ö† Offline';
    else if(status==='unsaved')el.textContent='‚óè Unsaved';
    
    // Hide after 2 seconds if synced
    if(status==='synced'){
        setTimeout(function(){el.className='sync-status';},2000);
    }
}

// Online/offline handling
window.addEventListener('online',function(){
    isOnline=true;
    // Don't auto-sync, let user do it manually
});
window.addEventListener('offline',function(){
    isOnline=false;
    showSyncStatus('offline');
});

// ==================== DATA ====================
var D={
    fontScale:1,
    autoAddToInv:0,
    currentUser:{id:1,name:'Owner',role:'owner'},
    users:[{id:1,name:'Owner',role:'owner',email:'owner@lachona.com',phone:''},{id:2,name:'Maria',role:'employee',email:'maria@lachona.com',phone:''}],
    areas:[
        {id:1,name:'Oven Fridge',sections:[],prep:1},
        {id:2,name:'Dairy Fridge',sections:[],prep:1},
        {id:3,name:'Prep Fridge',sections:['Left','Middle','Right'],prep:1},
        {id:4,name:'Main Prep Table',sections:[],prep:1},
        {id:5,name:'Oven Prep Table',sections:[],prep:1},
        {id:6,name:'Dishwasher',sections:[],prep:0},
        {id:7,name:'Sheeter',sections:[],prep:0},
        {id:8,name:'Freezer',sections:[],prep:1},
        {id:9,name:'Hallway Fridge',sections:[],prep:1},
        {id:10,name:'Stairs',sections:[],prep:0},
        {id:11,name:'Wine Display',sections:['Left Column','Top Row','Right Column'],prep:0},
        {id:12,name:'Left Wine Fridge',sections:[],prep:1},
        {id:13,name:'Right Wine Fridge',sections:[],prep:1}
    ],
    cats:[{id:1,name:'Meat'},{id:2,name:'Produce'},{id:3,name:'Dairy'},{id:4,name:'Dry Goods'},{id:5,name:'Liquids'},{id:6,name:'Supplies'},{id:7,name:'Bar/Spirits'},{id:8,name:'Bar/Wine'},{id:9,name:'Bar/Mixers'}],
    menuCats:[{id:1,name:'Empanadas'},{id:2,name:'Ensalada'},{id:3,name:'Tapas'},{id:4,name:'Soup'},{id:5,name:'Desserts'},{id:6,name:'Red Wine'},{id:7,name:'White & Sparkling'},{id:8,name:'Cocktails'},{id:9,name:'Brunch'},{id:10,name:'Beverages'},{id:11,name:'Sides'}],
    units:[
        {id:1,name:'each',abbr:'ea'},{id:2,name:'pound',abbr:'lb'},{id:3,name:'ounce',abbr:'oz'},{id:4,name:'gram',abbr:'g'},{id:5,name:'kilogram',abbr:'kg'},
        {id:6,name:'cup',abbr:'cup'},{id:7,name:'tablespoon',abbr:'tbsp'},{id:8,name:'teaspoon',abbr:'tsp'},{id:9,name:'fluid ounce',abbr:'fl oz'},{id:10,name:'milliliter',abbr:'ml'},
        {id:11,name:'liter',abbr:'L'},{id:12,name:'gallon',abbr:'gal'},{id:13,name:'quart',abbr:'qt'},{id:14,name:'pint',abbr:'pt'},{id:15,name:'bunch',abbr:'bunch'},
        {id:16,name:'head',abbr:'head'},{id:17,name:'clove',abbr:'clove'},{id:18,name:'slice',abbr:'slice'},{id:19,name:'piece',abbr:'pc'},{id:20,name:'package',abbr:'pkg'},
        {id:21,name:'can',abbr:'can'},{id:22,name:'jar',abbr:'jar'},{id:23,name:'bottle',abbr:'btl'},{id:24,name:'box',abbr:'box'},{id:25,name:'bag',abbr:'bag'},
        {id:26,name:'case',abbr:'case'},{id:27,name:'dozen',abbr:'doz'},{id:28,name:'half dozen',abbr:'1/2 doz'},{id:29,name:'bottle wine',abbr:'btl'},{id:30,name:'batch',abbr:'batch'},
        {id:31,name:'portion',abbr:'portion'},{id:32,name:'serving',abbr:'srv'},{id:33,name:'sheet',abbr:'sheet'},{id:34,name:'rack',abbr:'rack'},{id:35,name:'tray',abbr:'tray'},
        {id:36,name:'pan',abbr:'pan'},{id:37,name:'hotel pan',abbr:'hotel'},{id:38,name:'half hotel',abbr:'1/2 hotel'},{id:39,name:'third hotel',abbr:'1/3 hotel'},{id:40,name:'sixth hotel',abbr:'1/6 hotel'},
        {id:41,name:'cambro',abbr:'cambro'},{id:42,name:'lexan',abbr:'lexan'},{id:43,name:'quart container',abbr:'qt cont'},{id:44,name:'pint container',abbr:'pt cont'},{id:45,name:'deli container',abbr:'deli'},
        {id:46,name:'squeeze bottle',abbr:'squeeze'},{id:47,name:'roll',abbr:'roll'},{id:48,name:'sleeve',abbr:'sleeve'},{id:49,name:'stick',abbr:'stick'},{id:50,name:'bar',abbr:'bar'},
        {id:51,name:'cube',abbr:'cube'},{id:52,name:'pack',abbr:'pack'}
    ],
    ings:[],
    inv:[],
    shopping:[],
    preps:[],
    recs:[],
    menus:[],
    log:[]
};

var tab='inventory',nid=300,exp={},addOpen={},pendingPurchase=null,archiveOpen={ings:0,recs:0,menus:0};
var undoHistory=[];

// ==================== UNDO SYSTEM ====================
function saveState(actionName){
    var state={
        action:actionName,
        inv:JSON.parse(JSON.stringify(D.inv)),
        shopping:JSON.parse(JSON.stringify(D.shopping)),
        preps:JSON.parse(JSON.stringify(D.preps)),
        ings:JSON.parse(JSON.stringify(D.ings)),
        recs:JSON.parse(JSON.stringify(D.recs)),
        menus:JSON.parse(JSON.stringify(D.menus)),
        log:JSON.parse(JSON.stringify(D.log))
    };
    undoHistory.push(state);
    if(undoHistory.length>5)undoHistory.shift();
    updateUndoButton();
    showSyncStatus('unsaved');
}

function undoAction(){
    if(undoHistory.length===0)return;
    var state=undoHistory.pop();
    D.inv=state.inv;
    D.shopping=state.shopping;
    D.preps=state.preps;
    D.ings=state.ings;
    D.recs=state.recs;
    D.menus=state.menus;
    D.log=state.log;
    updateUndoButton();
    render();
}

function updateUndoButton(){
    var btn=document.getElementById('undo-btn');
    if(btn){
        btn.disabled=undoHistory.length===0;
        btn.title=undoHistory.length>0?'Undo: '+undoHistory[undoHistory.length-1].action+' ('+undoHistory.length+')':'Nothing to undo';
        btn.style.opacity=undoHistory.length>0?'1':'0.4';
    }
}

function logAction(action,location,details){
    var now=new Date();
    D.log.unshift({
        id:nid++,
        user:D.currentUser.name,
        action:action,
        location:location,
        details:details||'',
        timestamp:now.toISOString(),
        date:now.toLocaleDateString(),
        time:now.toLocaleTimeString()
    });
    var fourWeeksAgo=new Date();
    fourWeeksAgo.setDate(fourWeeksAgo.getDate()-28);
    D.log=D.log.filter(function(l){return new Date(l.timestamp)>=fourWeeksAgo;});
}

function addLog(action,location,details){logAction(action,location,details);}

function go(t){
    tab=t;
    document.querySelectorAll('.tab').forEach(function(el){el.classList.remove('active');});
    document.querySelector('.tab[data-t="'+t+'"]').classList.add('active');
    document.getElementById('fab').style.display=(t==='admin'||t==='log')?'none':'block';
    render();
}

function render(){
    document.documentElement.style.setProperty('--font-scale',D.fontScale);
    var slider=document.getElementById('font-slider');
    var val=document.getElementById('font-scale-val');
    if(slider)slider.value=D.fontScale;
    if(val)val.textContent=(D.fontScale*100).toFixed(0)+'%';
    
    var c=document.getElementById('content'),h=document.getElementById('hdr-t'),s=document.getElementById('hdr-s');
    var titles={inventory:'üì¶ Inventory',shopping:'üõí Shopping List',prep:'üë®‚Äçüç≥ Prep Status',ingredients:'ü•¨ Ingredients',recipes:'üìñ Recipes',menu:'üçΩÔ∏è Menu',log:'üìã Activity Log',admin:'‚öôÔ∏è Admin'};
    h.textContent=titles[tab];
    if(tab==='inventory')renderInv(c,s);
    else if(tab==='shopping')renderShop(c,s);
    else if(tab==='prep')renderPrep(c,s);
    else if(tab==='ingredients')renderIngs(c,s);
    else if(tab==='recipes')renderRecs(c,s);
    else if(tab==='menu')renderMenu(c,s);
    else if(tab==='log')renderLog(c,s);
    else if(tab==='admin')renderAdmin(c,s);
}

function getAreaName(areaId,subArea){
    var a=D.areas.find(function(x){return x.id===areaId;});
    if(!a)return 'Unknown';
    return subArea?a.name+' ('+subArea+')':a.name;
}

function getIngName(id){var i=D.ings.find(function(x){return x.id===id;});return i?i.name:'Unknown';}
function getRecName(id){var r=D.recs.find(function(x){return x.id===id;});return r?r.name:'Unknown';}
function getPrepName(id){var p=D.preps.find(function(x){return x.id===id;});return p?p.name:'Unknown';}

function getStatusColor(oh,tgt){var d=oh-tgt;return d>=0?'green':d>-3?'yellow':'red';}
function getStatusTxt(oh,tgt){var d=oh-tgt;return d>=0?'STOCKED':d>-3?'LOW':'CRITICAL';}

function renderInv(c,s){
    var total=D.inv.length;
    s.textContent=total+' items';
    var html='';
    
    D.areas.forEach(function(area){
        var areaItems=D.inv.filter(function(i){return i.areaId===area.id&&(!area.sections.length||!i.subArea);});
        var subItems={};
        if(area.sections.length){
            area.sections.forEach(function(sec){
                subItems[sec]=D.inv.filter(function(i){return i.areaId===area.id&&i.subArea===sec;});
            });
        }
        var totalInArea=areaItems.length;
        area.sections.forEach(function(sec){totalInArea+=subItems[sec]?subItems[sec].length:0;});
        
        var isExp=exp['area-'+area.id];
        html+='<div class="card"><div class="card-h" onclick="tog(\'area-'+area.id+'\')" style="cursor:pointer"><div><div class="card-t">'+area.name+'</div><div class="card-s">'+(area.prep?'üßä Prep Area':'üìç Storage')+'</div></div><span class="card-cnt">'+totalInArea+' '+(isExp?'‚ñ≤':'‚ñº')+'</span></div>';
        
        if(isExp){
            html+='<div style="margin-top:12px">';
            areaItems.forEach(function(inv){
                var ing=D.ings.find(function(x){return x.id===inv.ingId;});
                if(ing){
                    html+='<div class="inv-item" onclick="editInvItem('+inv.id+')"><span class="inv-item-name">'+ing.name+'</span><div class="inv-item-controls"><input type="number" value="'+inv.qty+'" onchange="updInv('+inv.id+',this.value)" onclick="event.stopPropagation()" style="width:50px;padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;text-align:center;font-size:calc(12px * var(--font-scale))"><select onchange="updInvUnit('+inv.id+',this.value)" onclick="event.stopPropagation()" style="padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;font-size:calc(10px * var(--font-scale))">';
                    D.units.forEach(function(u){html+='<option value="'+u.abbr+'"'+(inv.unit===u.abbr?' selected':'')+'>'+u.abbr+'</option>';});
                    html+='</select><button class="del-btn" onclick="event.stopPropagation();delInv('+inv.id+')">üóëÔ∏è</button></div></div>';
                }
            });
            if(area.sections.length){
                area.sections.forEach(function(sec){
                    html+='<div class="section-label">'+sec+'</div><div class="sub-area">';
                    if(subItems[sec]&&subItems[sec].length){
                        subItems[sec].forEach(function(inv){
                            var ing=D.ings.find(function(x){return x.id===inv.ingId;});
                            if(ing){
                                html+='<div class="inv-item" onclick="editInvItem('+inv.id+')"><span class="inv-item-name">'+ing.name+'</span><div class="inv-item-controls"><input type="number" value="'+inv.qty+'" onchange="updInv('+inv.id+',this.value)" onclick="event.stopPropagation()" style="width:50px;padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;text-align:center;font-size:calc(12px * var(--font-scale))"><select onchange="updInvUnit('+inv.id+',this.value)" onclick="event.stopPropagation()" style="padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;font-size:calc(10px * var(--font-scale))">';
                                D.units.forEach(function(u){html+='<option value="'+u.abbr+'"'+(inv.unit===u.abbr?' selected':'')+'>'+u.abbr+'</option>';});
                                html+='</select><button class="del-btn" onclick="event.stopPropagation();delInv('+inv.id+')">üóëÔ∏è</button></div></div>';
                            }
                        });
                    }else{
                        html+='<div style="color:#636e72;font-size:calc(11px * var(--font-scale));padding:8px">No items</div>';
                    }
                    html+='</div>';
                });
            }
            html+='<div class="add-toggle" onclick="togAdd(\'area-'+area.id+'\')"><span class="add-toggle-t">+ Add Ingredient</span></div>';
            html+='<div class="add-form'+(addOpen['area-'+area.id]?' open':'')+'">';
            html+='<select id="sel-'+area.id+'" class="form-i" style="margin-bottom:8px"><option value="">Select ingredient...</option>';
            D.cats.forEach(function(cat){
                var catIngs=D.ings.filter(function(i){return !i.archived && i.catId===cat.id;});
                if(catIngs.length){
                    html+='<optgroup label="'+cat.name+'">';
                    catIngs.forEach(function(ing){html+='<option value="'+ing.id+'">'+ing.name+'</option>';});
                    html+='</optgroup>';
                }
            });
            var uncatIngs=D.ings.filter(function(i){return !i.archived && !i.catId;});
            if(uncatIngs.length){
                html+='<optgroup label="Other">';
                uncatIngs.forEach(function(ing){html+='<option value="'+ing.id+'">'+ing.name+'</option>';});
                html+='</optgroup>';
            }
            html+='</select>';
            if(area.sections.length){
                html+='<select id="sub-'+area.id+'" class="form-i" style="margin-bottom:8px"><option value="">Main Area</option>';
                area.sections.forEach(function(sec){html+='<option value="'+sec+'">'+sec+'</option>';});
                html+='</select>';
            }
            html+='<div style="display:flex;gap:8px"><input type="number" id="qty-'+area.id+'" class="form-i" placeholder="Qty" style="flex:1"><select id="unit-'+area.id+'" class="form-i" style="flex:1">';
            D.units.forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
            html+='</select></div>';
            html+='<button class="btn btn-p" onclick="addToArea('+area.id+')" style="width:100%;margin-top:8px">Add</button>';
            html+='</div>';
            html+='</div>';
        }
        html+='</div>';
    });
    c.innerHTML=html;
}

function addToArea(areaId){
    var ingId=+document.getElementById('sel-'+areaId).value;
    var qty=+document.getElementById('qty-'+areaId).value;
    var unit=document.getElementById('unit-'+areaId).value;
    var area=D.areas.find(function(a){return a.id===areaId;});
    var subArea='';
    if(area&&area.sections.length){
        var subEl=document.getElementById('sub-'+areaId);
        if(subEl)subArea=subEl.value;
    }
    if(!ingId||!qty){alert('Select ingredient and enter quantity');return;}
    
    saveState('Add to '+getAreaName(areaId,subArea));
    D.inv.push({id:nid++,areaId:areaId,subArea:subArea,ingId:ingId,qty:qty,unit:unit});
    logAction('Added to inventory',getAreaName(areaId,subArea),getIngName(ingId)+': '+qty+' '+unit);
    addOpen['area-'+areaId]=false;
    render();
}

function updInv(id,v){
    var i=D.inv.find(function(x){return x.id===id;});
    if(i){
        saveState('Update qty');
        var oldQty=i.qty;
        i.qty=+v||0;
        var ing=D.ings.find(function(x){return x.id===i.ingId;});
        logAction('Updated quantity',getAreaName(i.areaId,i.subArea),(ing?ing.name:'')+': '+oldQty+' ‚Üí '+i.qty);
        render();
    }
}

function updInvUnit(id,v){
    var i=D.inv.find(function(x){return x.id===id;});
    if(i){i.unit=v;render();}
}

function delInv(id){
    var i=D.inv.find(function(x){return x.id===id;});
    if(i&&confirm('Remove from inventory?')){
        saveState('Remove from inventory');
        logAction('Removed from inventory',getAreaName(i.areaId,i.subArea),getIngName(i.ingId));
        D.inv=D.inv.filter(function(x){return x.id!==id;});
        render();
    }
}

function editInvItem(id){
    var inv=D.inv.find(function(x){return x.id===id;});
    if(!inv)return;
    var ing=D.ings.find(function(x){return x.id===inv.ingId;});
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Move '+ing.name+'</div>';
    html+='<div class="form-g"><label class="form-l">Current Location</label><div style="padding:8px;background:rgba(0,0,0,.2);border-radius:6px;color:#a0aec0;font-size:calc(12px * var(--font-scale))">'+getAreaName(inv.areaId,inv.subArea)+'</div></div>';
    html+='<div class="form-g"><label class="form-l">Move To</label><select id="move-area" class="form-i" onchange="updateSubAreaOptions()">';
    D.areas.forEach(function(a){html+='<option value="'+a.id+'"'+(a.id===inv.areaId?' selected':'')+'>'+a.name+'</option>';});
    html+='</select></div>';
    html+='<div class="form-g" id="sub-area-wrap"><label class="form-l">Section</label><select id="move-sub" class="form-i"><option value="">Main Area</option></select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="moveInvItem('+id+')" style="flex:1">Move</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    updateSubAreaOptions();
}

function updateSubAreaOptions(){
    var areaId=+document.getElementById('move-area').value;
    var area=D.areas.find(function(a){return a.id===areaId;});
    var wrap=document.getElementById('sub-area-wrap');
    var sel=document.getElementById('move-sub');
    if(area&&area.sections.length){
        wrap.style.display='block';
        sel.innerHTML='<option value="">Main Area</option>';
        area.sections.forEach(function(sec){sel.innerHTML+='<option value="'+sec+'">'+sec+'</option>';});
    }else{
        wrap.style.display='none';
        sel.innerHTML='<option value="">Main Area</option>';
    }
}

function moveInvItem(id){
    var inv=D.inv.find(function(x){return x.id===id;});
    if(!inv)return;
    var newAreaId=+document.getElementById('move-area').value;
    var newSub=document.getElementById('move-sub').value;
    var oldLoc=getAreaName(inv.areaId,inv.subArea);
    saveState('Move item');
    inv.areaId=newAreaId;
    inv.subArea=newSub;
    logAction('Moved item',oldLoc+' ‚Üí '+getAreaName(newAreaId,newSub),getIngName(inv.ingId));
    closeModal();
    render();
}

function renderShop(c,s){c.innerHTML='<p>Shopping placeholder</p>';s.textContent='';}
function renderPrep(c,s){c.innerHTML='<p>Prep placeholder</p>';s.textContent='';}
function renderIngs(c,s){c.innerHTML='<p>Ingredients placeholder</p>';s.textContent='';}
function renderRecs(c,s){c.innerHTML='<p>Recipes placeholder</p>';s.textContent='';}
function renderMenu(c,s){c.innerHTML='<p>Menu placeholder</p>';s.textContent='';}
function renderLog(c,s){c.innerHTML='<p>Log placeholder</p>';s.textContent='';}
function renderAdmin(c,s){c.innerHTML='<p>Admin placeholder</p>';s.textContent='';}

function tog(id){exp[id]=!exp[id];render();}
function togAdd(id){addOpen[id]=!addOpen[id];render();}
function toggleArchive(type){archiveOpen[type]=!archiveOpen[type];render();}
function closeModal(){document.getElementById('modal-o').classList.remove('open');}

function openAdd(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    m.innerHTML='<div class="modal-t">Add New</div><p>Coming soon...</p><button class="btn btn-s" onclick="closeModal()" style="width:100%;margin-top:12px">Close</button>';
    mo.classList.add('open');
}

function scrollTabs(dir){
    var wrap=document.getElementById('tabs-wrap');
    wrap.scrollBy({left:dir*120,behavior:'smooth'});
}

function updateScrollHints(){
    var wrap=document.getElementById('tabs-wrap');
    var left=document.getElementById('scroll-left');
    var right=document.getElementById('scroll-right');
    if(left)left.style.opacity='1';
    if(right)right.style.opacity='1';
}

function toggleFontControl(){
    var bar=document.getElementById('font-control-bar');
    bar.classList.toggle('open');
}

function setFontScale(val){
    D.fontScale=+val;
    document.getElementById('font-scale-val').textContent=(D.fontScale*100).toFixed(0)+'%';
    document.getElementById('font-slider').value=val;
    try{localStorage.setItem('ro_fontScale',val);}catch(e){}
    render();
}

var DATA_VERSION=3;

function loadAllDataLocal(){
    try{
        var savedData=localStorage.getItem('ro_allData');
        if(savedData){
            var parsed=JSON.parse(savedData);
            Object.keys(parsed).forEach(function(key){
                if(D.hasOwnProperty(key))D[key]=parsed[key];
            });
        }
    }catch(e){console.error('Load error:',e);}
}

function saveAllDataLocal(){
    try{
        var dataToSave={
            users:D.users,areas:D.areas,cats:D.cats,menuCats:D.menuCats,units:D.units,
            ings:D.ings,inv:D.inv,shopping:D.shopping,preps:D.preps,recs:D.recs,menus:D.menus,
            log:D.log,autoAddToInv:D.autoAddToInv
        };
        localStorage.setItem('ro_allData',JSON.stringify(dataToSave));
        localStorage.setItem('ro_dataVersion',DATA_VERSION);
    }catch(e){console.error('Local save error:',e);}
}

function exportData(){
    var json=JSON.stringify({version:DATA_VERSION,exportDate:new Date().toISOString(),data:D},null,2);
    var blob=new Blob([json],{type:'application/json'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='restaurant-oracle-backup-'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

var origRender=render;
render=function(){
    origRender();
    saveAllDataLocal();
};

document.addEventListener('DOMContentLoaded',async function(){
    try{
        var savedScale=localStorage.getItem('ro_fontScale');
        if(savedScale){D.fontScale=+savedScale;}
    }catch(e){}
    
    var hashParams = new URLSearchParams(window.location.hash.substring(1));
    var queryParams = new URLSearchParams(window.location.search);
    if(hashParams.get('type') === 'recovery' || queryParams.get('type') === 'recovery'){
        window.isPasswordRecovery = true;
    }
    
    var supabaseReady = await initSupabase();
    
    if(supabaseReady && supabase){
        supabase.auth.onAuthStateChange(onAuthStateChange);
        var session = await supabase.auth.getSession();
        if(session.data.session){
            onAuthStateChange('SIGNED_IN', session.data.session);
        }else{
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
    }else{
        loadAllDataLocal();
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        render();
    }
    
    updateScrollHints();
    document.getElementById('tabs-wrap').addEventListener('scroll',updateScrollHints);
});

document.getElementById('modal-o').addEventListener('click',function(e){if(e.target.id==='modal-o')closeModal();});
</script>
</body>
</html>