<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Restaurant Oracle</title>
    
    <!-- Supabase setup will be done inline in main script using dynamic import -->

    <!-- SheetJS for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Web App Icons -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Restaurant Oracle">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Restaurant Oracle">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Smart Kitchen Management">
    <link rel="manifest" href="manifest.json">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root{--font-size:14px;--font-scale:1}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0a0a1a,#1a1a3a);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
        
        /* Login Screen - Warm Coral/Peach Theme with Dark Mode inputs */
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:40px 20px;position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#0a0a1a 0%,#1a1a3a 50%,#0a0a1a 100%)}
        .login-screen.hidden{display:none}
        .login-logo{width:100%;max-width:340px;height:auto;margin-bottom:16px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
        .login-title{font-size:28px;font-weight:700;color:#e0e6ed;margin-bottom:8px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
        .login-subtitle{font-size:14px;color:#a0aec0;margin-bottom:32px;text-align:center}
        .login-box{width:100%;max-width:340px;background:rgba(26,26,46,.95);border:1px solid rgba(162,155,254,.2);border-radius:20px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.4)}
        .login-tabs{display:flex;margin-bottom:20px;background:rgba(0,0,0,.3);border-radius:10px;padding:4px}
        .login-tab{flex:1;padding:10px;text-align:center;font-size:14px;font-weight:600;color:#a0aec0;cursor:pointer;border-radius:8px;transition:all .2s}
        .login-tab.active{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff}
        .login-form{display:none}
        .login-form.active{display:block}
        .login-input{width:100%;padding:14px 16px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#e0e6ed;font-size:14px;margin-bottom:12px}
        .login-input:focus{outline:none;border-color:#a29bfe;box-shadow:0 0 0 3px rgba(162,155,254,.3)}
        .login-input::placeholder{color:#636e72}
        .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;border-radius:10px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s}
        .login-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(162,155,254,.4)}
        .login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .login-error{background:rgba(214,48,49,.2);color:#ff7675;padding:12px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none}
        .login-error.show{display:block}
        .login-success{background:rgba(0,184,148,.2);color:#00b894;padding:12px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none}
        .login-success.show{display:block}
        .login-divider{text-align:center;color:#636e72;font-size:12px;margin:20px 0;position:relative}
        .login-divider::before,.login-divider::after{content:'';position:absolute;top:50%;width:40%;height:1px;background:rgba(255,255,255,.1)}
        .login-divider::before{left:0}
        .login-divider::after{right:0}
        .sync-status{position:fixed;bottom:20px;right:20px;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;display:none;z-index:1000}
        .sync-status.syncing{display:block;background:rgba(253,203,110,.2);color:#fdcb6e}
        .sync-status.synced{display:block;background:rgba(0,184,148,.2);color:#00b894}
        .sync-status.offline{display:block;background:rgba(214,48,49,.2);color:#ff7675}
        .sync-status.unsaved{display:block;background:rgba(116,185,255,.2);color:#74b9ff}
        .user-menu{position:relative}
        .user-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#00b894,#00cec9);border:none;color:#fff;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .user-dropdown{position:absolute;top:44px;right:0;background:#2d2d4a;border-radius:12px;padding:8px;min-width:180px;box-shadow:0 10px 40px rgba(0,0,0,.5);display:none;z-index:50}
        .user-dropdown.open{display:block}
        .user-dropdown-item{padding:10px 12px;border-radius:8px;font-size:13px;color:#e0e6ed;cursor:pointer;display:flex;align-items:center;gap:8px}
        .user-dropdown-item:hover{background:rgba(255,255,255,.1)}
        .user-dropdown-item.logout{color:#ff7675}
        .user-dropdown-header{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:4px}
        .user-dropdown-name{font-weight:600;color:#e0e6ed;font-size:14px}
        .user-dropdown-email{font-size:11px;color:#a0aec0;margin-top:2px}
        
        .phone{width:390px;height:844px;background:#1a1a2e;border-radius:44px;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,.5),0 0 0 12px #2a2a3e;display:flex;flex-direction:column;position:relative}
        .phone.hidden{display:none}
        .status{height:50px;display:flex;justify-content:space-between;align-items:flex-end;padding:0 28px 8px;font-size:calc(14px * var(--font-scale));font-weight:600;color:#e0e6ed}
        .header{padding:12px 20px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
        .header h1{font-size:calc(20px * var(--font-scale));color:#e0e6ed}
        .header p{font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-top:2px}
        .content{flex:1;overflow-y:auto;padding:16px;font-size:calc(var(--font-size) * var(--font-scale))}
        .content::-webkit-scrollbar{width:4px}
        .content::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
        .tabs-container{display:flex;align-items:center;border-top:1px solid rgba(255,255,255,.1);position:relative;background:#1a1a2e}
        .tabs-wrap{flex:1;overflow-x:scroll;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;scroll-behavior:smooth}
        .tabs-wrap::-webkit-scrollbar{display:none}
        .tabs{display:flex;padding:8px 4px 30px;width:max-content;gap:4px}
        .tab{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 12px;cursor:pointer;border-radius:10px;min-width:65px;flex-shrink:0}
        .scroll-hint{width:28px;height:60px;display:flex;align-items:center;justify-content:center;background:#1a1a2e;color:#a29bfe;font-size:28px;font-weight:bold;cursor:pointer;flex-shrink:0;border:none;padding-bottom:20px}
        .scroll-hint:hover{color:#fff;background:rgba(108,92,231,.3)}
        .scroll-hint.scroll-left{border-right:1px solid rgba(255,255,255,.1)}
        .scroll-hint.scroll-right{border-left:1px solid rgba(255,255,255,.1)}
        .tab:hover{background:rgba(255,255,255,.05)}
        .tab span:first-child{font-size:calc(28px * var(--font-scale));opacity:.85;transition:all .2s}
        .tab span:last-child{font-size:calc(10px * var(--font-scale));font-weight:600;color:#a0aec0;white-space:nowrap}
        .tab.active span:first-child{opacity:1;transform:scale(1.1)}
        .tab.active span:last-child{font-weight:700}
        .tab[data-t="inventory"].active span:last-child{color:#a29bfe}
        .tab[data-t="shopping"].active span:last-child{color:#e17055}
        .tab[data-t="prep"].active span:last-child{color:#fd79a8}
        .tab[data-t="ingredients"].active span:last-child{color:#00b894}
        .tab[data-t="recipes"].active span:last-child{color:#fdcb6e}
        .tab[data-t="menu"].active span:last-child{color:#74b9ff}
        .tab[data-t="log"].active span:last-child{color:#81ecec}
        .tab[data-t="admin"].active span:last-child{color:#b2bec3}
        .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;margin-bottom:10px}
        .card:hover{border-color:rgba(255,255,255,.2)}
        .card-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .card-t{font-size:calc(15px * var(--font-scale));font-weight:600;color:#e0e6ed}
        .card-s{font-size:calc(11px * var(--font-scale));color:#a0aec0}
        .card-cnt{font-size:calc(11px * var(--font-scale));color:#a0aec0;background:rgba(0,0,0,.2);padding:4px 8px;border-radius:6px}
        .sec{font-size:calc(12px * var(--font-scale));font-weight:700;color:#a29bfe;margin:16px 0 8px;display:flex;align-items:center;gap:6px}
        .sec.ing{color:#00b894}
        .sec.prep{color:#fd79a8}
        .sec.menu{color:#74b9ff}
        .sec.log{color:#81ecec}
        .btn{padding:10px 16px;border-radius:10px;font-weight:600;font-size:calc(13px * var(--font-scale));cursor:pointer;border:none;transition:all .2s}
        .btn-p{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:#fff}
        .btn-p:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,92,231,.4)}
        .btn-s{background:rgba(255,255,255,.1);color:#e0e6ed}
        .btn-s:hover{background:rgba(255,255,255,.15)}
        .btn-sm{padding:6px 10px;font-size:calc(11px * var(--font-scale))}
        .btn-d{background:rgba(214,48,49,.2);color:#d63031}
        .form-g{margin-bottom:12px}
        .form-l{display:block;font-size:calc(11px * var(--font-scale));font-weight:600;color:#a0aec0;margin-bottom:4px}
        .form-i{width:100%;padding:10px 12px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#e0e6ed;font-size:calc(13px * var(--font-scale))}
        .form-i:focus{outline:none;border-color:#a29bfe}
        .form-i::placeholder{color:#636e72}
        select.form-i{cursor:pointer}
        select.form-i optgroup{background:#2d2d4a;color:#a29bfe;font-weight:700;padding:4px 0}
        select.form-i option{background:#1a1a2e;color:#e0e6ed;padding:8px}
        .header-add{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:#fff;font-size:22px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(108,92,231,.4);display:flex;align-items:center;justify-content:center;transition:all .2s}
        .header-add:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(108,92,231,.5)}
        .header-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#a0aec0;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .header-btn:hover:not(:disabled){background:rgba(255,255,255,.2);color:#e0e6ed}
        .header-btn:disabled{cursor:not-allowed;opacity:0.4}
        .font-control-bar{display:none;margin-top:10px;padding:10px 12px;background:rgba(0,0,0,.2);border-radius:8px;align-items:center;gap:10px}
        .font-control-bar.open{display:flex}
        .font-control-bar input[type="range"]{flex:1;accent-color:#a29bfe;height:4px}
        .modal-o{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center}
        .modal-o.open{display:flex}
        .modal{background:#1a1a2e;border-radius:20px;padding:20px;width:340px;max-height:80vh;overflow-y:auto}
        .modal-t{font-size:calc(18px * var(--font-scale));font-weight:700;color:#e0e6ed;margin-bottom:16px}
        .del-btn{background:none;border:none;color:#d63031;cursor:pointer;padding:4px;font-size:calc(16px * var(--font-scale))}
        .del-btn:hover{opacity:.7}
        .shop-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,.2);border-radius:10px;margin-bottom:8px}
        .shop-item.checked{opacity:.5}
        .shop-check{width:24px;height:24px;border-radius:6px;border:2px solid #e17055;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;font-size:calc(14px * var(--font-scale))}
        .shop-check.checked{background:#e17055;color:#fff}
        .shop-info{flex:1}
        .shop-name{font-size:calc(14px * var(--font-scale));color:#e0e6ed;font-weight:600}
        .shop-meta{font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-top:2px}
        .shop-qty{font-size:calc(16px * var(--font-scale));font-weight:700;color:#e17055}
        .shop-undo{background:none;border:none;color:#fdcb6e;cursor:pointer;font-size:calc(12px * var(--font-scale));padding:4px 8px;border-radius:4px}
        .shop-undo:hover{background:rgba(253,203,110,.2)}
        .rec-ing{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:rgba(0,0,0,.2);border-radius:6px;margin-bottom:4px}
        .rec-ing-name{font-size:calc(12px * var(--font-scale));color:#e0e6ed}
        .archive-header{margin-top:24px;padding:12px;background:rgba(0,0,0,.3);border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
        .archive-header span{color:#636e72;font-size:calc(12px * var(--font-scale));font-weight:600}
        .log-item{padding:10px 12px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:6px;border-left:3px solid #81ecec}
        .log-item .log-action{font-size:calc(13px * var(--font-scale));color:#e0e6ed;font-weight:500}
        .log-item .log-meta{font-size:calc(10px * var(--font-scale));color:#a0aec0;margin-top:4px}
        .standalone-badge{background:rgba(253,203,110,.2);color:#fdcb6e;font-size:calc(9px * var(--font-scale));padding:2px 6px;border-radius:4px;font-weight:600}
        .min-qty-badge{background:rgba(0,184,148,.2);color:#00b894;font-size:calc(9px * var(--font-scale));padding:2px 6px;border-radius:4px;margin-left:4px}
        .sub-area{margin-left:12px;padding-left:12px;border-left:2px solid rgba(255,255,255,.1)}
        .add-toggle{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;margin-top:8px;border-radius:6px;background:rgba(108,92,231,.1);cursor:pointer;transition:background .2s}
        .add-toggle:hover{background:rgba(108,92,231,.2)}
        .add-toggle-t{font-size:calc(12px * var(--font-scale));color:#a29bfe;font-weight:500}
        .add-form{display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.1)}
        .add-form.open{display:block}
        .inv-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:background .2s}
        .inv-item.prep-item{background:rgba(108,92,231,.15);border-left:3px solid #6c5ce7}
        .inv-item:hover{background:rgba(108,92,231,.2)}
        .inv-item-name{font-size:calc(13px * var(--font-scale));color:#e0e6ed}
        .inv-item-sub{font-size:calc(10px * var(--font-scale));color:#a0aec0;margin-left:4px}
        .inv-item-controls{display:flex;align-items:center;gap:6px}
        .inv-dropdown-item{padding:8px 12px;cursor:pointer;font-size:calc(12px * var(--font-scale));color:#e0e6ed;transition:background .15s}
        .inv-dropdown-item:hover{background:rgba(108,92,231,.3)}
        .status-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:calc(10px * var(--font-scale));font-weight:600}
        .status-stocked{background:rgba(0,184,148,.2);color:#00b894}
        .status-low{background:rgba(253,203,110,.2);color:#fdcb6e}
        .status-critical{background:rgba(214,48,49,.2);color:#d63031}
        .section-label{font-size:calc(10px * var(--font-scale));font-weight:700;color:#a0aec0;margin:12px 0 6px;padding-left:4px}
        .recipe-comp{padding:8px;background:rgba(0,0,0,.15);border-radius:6px;margin-bottom:4px;border-left:2px solid}
        .recipe-comp.ing{border-color:#00b894}
        .recipe-comp.prep{border-color:#fd79a8}
        .recipe-comp.rec{border-color:#fdcb6e}
    </style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="login-screen">
    <img src="icon.png" alt="Restaurant Oracle" class="login-logo">
    <div class="login-title">Restaurant Oracle</div>
    <div class="login-subtitle">Smart Kitchen Management for LaChona</div>
    <div class="login-box">
        <div class="login-tabs">
            <div class="login-tab active" onclick="switchLoginTab('signin')">Sign In</div>
            <div class="login-tab" onclick="switchLoginTab('signup')">Sign Up</div>
        </div>
        <div class="login-error" id="login-error"></div>
        <div class="login-success" id="login-success"></div>
        
        <!-- Sign In Form -->
        <div class="login-form active" id="signin-form">
            <input type="email" class="login-input" id="signin-email" placeholder="Email address">
            <input type="password" class="login-input" id="signin-password" placeholder="Password">
            <button class="login-btn" onclick="signIn()" id="signin-btn">Sign In</button>
            <div style="text-align:center;margin-top:12px">
                <a href="#" onclick="showResetPassword();return false;" style="color:#a29bfe;font-size:13px;text-decoration:none">Forgot Password?</a>
            </div>
        </div>
        
        <!-- Reset Password Form -->
        <div class="login-form" id="reset-form">
            <p style="color:#a0aec0;font-size:13px;margin-bottom:16px;text-align:center">Enter your email and we'll send you a link to reset your password.</p>
            <input type="email" class="login-input" id="reset-email" placeholder="Email address">
            <button class="login-btn" onclick="sendResetEmail()" id="reset-btn">Send Reset Link</button>
            <div style="text-align:center;margin-top:12px">
                <a href="#" onclick="switchLoginTab('signin');return false;" style="color:#a0aec0;font-size:13px;text-decoration:none">‚Üê Back to Sign In</a>
            </div>
        </div>
        
        <!-- Update Password Form (shown after clicking reset link) -->
        <div class="login-form" id="update-password-form">
            <p style="color:#a0aec0;font-size:13px;margin-bottom:16px;text-align:center">Enter your new password below.</p>
            <input type="password" class="login-input" id="new-password" placeholder="New password (min 6 characters)">
            <input type="password" class="login-input" id="confirm-password" placeholder="Confirm new password">
            <button class="login-btn" onclick="updatePassword()" id="update-password-btn">Update Password</button>
        </div>
        
        <!-- Sign Up Form -->
        <div class="login-form" id="signup-form">
            <input type="text" class="login-input" id="signup-name" placeholder="Your name">
            <input type="email" class="login-input" id="signup-email" placeholder="Email address">
            <input type="password" class="login-input" id="signup-password" placeholder="Password (min 6 characters)">
            <button class="login-btn" onclick="signUp()" id="signup-btn">Create Account</button>
        </div>
    </div>
</div>

<!-- Sync Status Indicator -->
<div class="sync-status" id="sync-status"></div>

<!-- Main App -->
<div class="phone hidden" id="app-container">
    <div class="status"><span>Restaurant Oracle</span><span id="connection-status"></span></div>
    <div class="header">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <h1 id="hdr-t">üì¶ Inventory</h1>
                <p id="hdr-s">Items</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <button class="header-btn" id="undo-btn" onclick="undoAction()" title="Undo" disabled>‚Ü©</button>
                <button class="header-btn" id="font-btn" onclick="toggleFontControl()" title="Text Size">üî§</button>
                <div class="user-menu">
                    <button class="user-btn" id="user-btn" onclick="toggleUserMenu()">?</button>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-name" id="user-name">User</div>
                            <div class="user-dropdown-email" id="user-email">user@example.com</div>
                        </div>
                        <div class="user-dropdown-item" onclick="event.stopPropagation();syncNow()">üîÑ Sync Now</div>
                        <div class="user-dropdown-item" onclick="event.stopPropagation();exportData()">üì§ Export Backup</div>
                        <div class="user-dropdown-item" onclick="event.stopPropagation();showDebugInfo()">üîß Debug Info</div>
                        <div class="user-dropdown-item logout" onclick="event.stopPropagation();signOut()">üö™ Sign Out</div>
                    </div>
                </div>
                <button class="header-add" id="fab" onclick="openAdd()">+</button>
            </div>
        </div>
        <div class="font-control-bar" id="font-control-bar">
            <span style="font-size:calc(11px * var(--font-scale));color:#a0aec0">Text Size:</span>
            <input type="range" min="0.8" max="1.4" step="0.1" value="1" id="font-slider" onchange="setFontScale(this.value)">
            <span id="font-scale-val" style="font-size:calc(12px * var(--font-scale));color:#e0e6ed;min-width:36px">100%</span>
        </div>
    </div>
    <div class="content" id="content"></div>
    <div class="tabs-container">
        <div class="scroll-hint scroll-left" id="scroll-left" onclick="scrollTabs(-1)">‚Äπ</div>
        <div class="tabs-wrap" id="tabs-wrap">
            <div class="tabs">
                <div class="tab active" data-t="inventory" onclick="go('inventory')"><span>üì¶</span><span>Inventory</span></div>
                <div class="tab" data-t="shopping" onclick="go('shopping')"><span>üõí</span><span>Shopping</span></div>
                <div class="tab" data-t="prep" onclick="go('prep')"><span>üë®‚Äçüç≥</span><span>Prep</span></div>
                <div class="tab" data-t="ingredients" onclick="go('ingredients')"><span>ü•¨</span><span>Ingredients</span></div>
                <div class="tab" data-t="recipes" onclick="go('recipes')"><span>üìñ</span><span>Recipes</span></div>
                <div class="tab" data-t="menu" onclick="go('menu')"><span>üçΩÔ∏è</span><span>Menu</span></div>
                <div class="tab" data-t="log" onclick="go('log')"><span>üìã</span><span>Log</span></div>
                <div class="tab" data-t="admin" onclick="go('admin')"><span>‚öôÔ∏è</span><span>Admin</span></div>
            </div>
        </div>
        <div class="scroll-hint scroll-right" id="scroll-right" onclick="scrollTabs(1)">‚Ä∫</div>
    </div>
    <div class="modal-o" id="modal-o"><div class="modal" id="modal"></div></div>
</div>
<script>
// ==================== EARLY PASSWORD RECOVERY CHECK ====================
// Check IMMEDIATELY before anything else runs - Supabase will clear the hash
(function(){
    var hash = window.location.hash;
    console.log('Early URL check - Hash:', hash);
    if(hash && (hash.indexOf('type=recovery') !== -1 || hash.indexOf('type%3Drecovery') !== -1)){
        console.log('Password recovery detected early!');
        sessionStorage.setItem('ro_password_recovery', 'true');
    }
})();

// ==================== SUPABASE CONFIG ====================
var SUPABASE_URL='https://quoqhfbibsmsdicrddym.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1b3FoZmJpYnNtc2RpY3JkZHltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Njc5MDUsImV4cCI6MjA4NDI0MzkwNX0.DaqF9ToMtgqdNZJfpj-nueGJBeQSq_Gutkl2bXhqhpo';
var supabase=null;
var currentAuthUser=null;
var isOnline=navigator.onLine;
var syncQueue=[];
var realtimeChannel=null;

// Initialize Supabase using dynamic import
async function initSupabase(){
    try{
        console.log('Loading Supabase library...');
        var module = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        supabase = module.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase initialized successfully');
        return true;
    }catch(e){
        console.error('Supabase init error:', e);
        return false;
    }
}

// ==================== AUTH FUNCTIONS ====================
function switchLoginTab(tab){
    document.querySelectorAll('.login-tab').forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.login-form').forEach(function(f){f.classList.remove('active');});
    if(tab==='signin'||tab==='signup'){
        document.querySelector('.login-tab:nth-child('+(tab==='signin'?'1':'2')+')').classList.add('active');
    }
    document.getElementById(tab+'-form').classList.add('active');
    hideLoginMessages();
}

function showResetPassword(){
    document.querySelectorAll('.login-tab').forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.login-form').forEach(function(f){f.classList.remove('active');});
    document.getElementById('reset-form').classList.add('active');
    // Pre-fill email if already entered
    var signinEmail=document.getElementById('signin-email').value.trim();
    if(signinEmail){
        document.getElementById('reset-email').value=signinEmail;
    }
    hideLoginMessages();
}

async function sendResetEmail(){
    hideLoginMessages();
    var email=document.getElementById('reset-email').value.trim();
    
    if(!email){
        showLoginError('Please enter your email address');
        return;
    }
    
    document.getElementById('reset-btn').disabled=true;
    document.getElementById('reset-btn').textContent='Sending...';
    
    try{
        var result=await supabase.auth.resetPasswordForEmail(email,{
            redirectTo:window.location.origin+window.location.pathname
        });
        if(result.error)throw result.error;
        showLoginSuccess('Password reset link sent! Check your email.');
        setTimeout(function(){
            switchLoginTab('signin');
        },3000);
    }catch(err){
        showLoginError(err.message||'Failed to send reset email');
    }
    
    document.getElementById('reset-btn').disabled=false;
    document.getElementById('reset-btn').textContent='Send Reset Link';
}

function hideLoginMessages(){
    document.getElementById('login-error').classList.remove('show');
    document.getElementById('login-success').classList.remove('show');
}

function showLoginError(msg){
    var el=document.getElementById('login-error');
    el.textContent=msg;
    el.classList.add('show');
}

function showLoginSuccess(msg){
    var el=document.getElementById('login-success');
    el.textContent=msg;
    el.classList.add('show');
}

async function signIn(){
    hideLoginMessages();
    var email=document.getElementById('signin-email').value.trim();
    var password=document.getElementById('signin-password').value;
    
    if(!email||!password){
        showLoginError('Please enter email and password');
        return;
    }
    
    document.getElementById('signin-btn').disabled=true;
    document.getElementById('signin-btn').textContent='Signing in...';
    
    try{
        var result=await supabase.auth.signInWithPassword({email:email,password:password});
        if(result.error)throw result.error;
        // Auth state change will handle the rest
    }catch(err){
        showLoginError(err.message||'Sign in failed');
        document.getElementById('signin-btn').disabled=false;
        document.getElementById('signin-btn').textContent='Sign In';
    }
}

async function signUp(){
    hideLoginMessages();
    var name=document.getElementById('signup-name').value.trim();
    var email=document.getElementById('signup-email').value.trim();
    var password=document.getElementById('signup-password').value;
    
    if(!name||!email||!password){
        showLoginError('Please fill in all fields');
        return;
    }
    if(password.length<6){
        showLoginError('Password must be at least 6 characters');
        return;
    }
    
    document.getElementById('signup-btn').disabled=true;
    document.getElementById('signup-btn').textContent='Creating account...';
    
    try{
        var result=await supabase.auth.signUp({
            email:email,
            password:password,
            options:{data:{name:name}}
        });
        if(result.error)throw result.error;
        
        // Check if this is the first user (make them owner)
        var existingMembers = await supabase.from('team_members').select('id').limit(1);
        var isFirstUser = !existingMembers.data || existingMembers.data.length === 0;
        
        // Add to team_members table
        if(result.data.user){
            await supabase.from('team_members').insert({
                user_id:result.data.user.id,
                name:name,
                email:email,
                role: isFirstUser ? 'owner' : 'employee'
            });
        }
        
        showLoginSuccess('Account created!' + (isFirstUser ? ' You are the Owner.' : '') + ' Check your email to confirm, then sign in.');
        switchLoginTab('signin');
    }catch(err){
        showLoginError(err.message||'Sign up failed');
    }
    
    document.getElementById('signup-btn').disabled=false;
    document.getElementById('signup-btn').textContent='Create Account';
}

function signOut(){
    console.log('signOut called');
    
    // Close dropdown immediately
    document.getElementById('user-dropdown').classList.remove('open');
    
    // Don't wait for Supabase - just clear local auth and reload
    currentAuthUser = null;
    Object.keys(localStorage).forEach(function(key){
        if(key.startsWith('sb-')) localStorage.removeItem(key);
    });
    sessionStorage.clear();
    location.reload();
}

function toggleUserMenu(){
    document.getElementById('user-dropdown').classList.toggle('open');
}

// Close user menu when clicking outside
document.addEventListener('click',function(e){
    if(!e.target.closest('.user-menu')){
        document.getElementById('user-dropdown').classList.remove('open');
    }
    // Close inventory dropdowns when clicking outside
    if(!e.target.closest('.inv-dropdown') && !e.target.id?.startsWith('inv-search-')){
        document.querySelectorAll('.inv-dropdown').forEach(function(d){d.style.display='none';});
    }
});

async function onAuthStateChange(event,session){
    console.log('Auth event:', event, 'Session:', !!session);
    
    // Check for password recovery - check multiple sources
    var hashParams = new URLSearchParams(window.location.hash.substring(1));
    var queryParams = new URLSearchParams(window.location.search);
    var isRecoveryInUrl = hashParams.get('type') === 'recovery' || queryParams.get('type') === 'recovery';
    var isRecoveryInSession = sessionStorage.getItem('ro_password_recovery') === 'true';
    
    console.log('Recovery check - URL:', isRecoveryInUrl, 'Session:', isRecoveryInSession, 'Event:', event);
    
    // Handle password recovery - show update password form
    // This must be checked FIRST, even if session exists
    if(event === 'PASSWORD_RECOVERY' || isRecoveryInUrl || isRecoveryInSession || window.isPasswordRecovery){
        console.log('Password recovery mode activated');
        // Clear the flag so it doesn't trigger again after password update
        sessionStorage.removeItem('ro_password_recovery');
        window.isPasswordRecovery = false;
        
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        // Show update password form
        document.querySelectorAll('.login-tab').forEach(function(t){t.classList.remove('active');});
        document.querySelectorAll('.login-form').forEach(function(f){f.classList.remove('active');});
        document.getElementById('update-password-form').classList.add('active');
        showLoginSuccess('Please enter your new password.');
        return;
    }
    
    if(session&&session.user){
        currentAuthUser=session.user;
        
        // Update UI
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        
        var userName=session.user.user_metadata?.name||session.user.email.split('@')[0];
        document.getElementById('user-name').textContent=userName;
        document.getElementById('user-email').textContent=session.user.email;
        document.getElementById('user-btn').textContent=userName.charAt(0).toUpperCase();
        
        // Load data from Supabase
        await loadFromSupabase();
        
        // Setup real-time sync
        setupRealtimeSync();
        
        render();
    }else{
        currentAuthUser=null;
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        
        // Cleanup realtime
        if(realtimeChannel){
            supabase.removeChannel(realtimeChannel);
            realtimeChannel=null;
        }
    }
}

async function updatePassword(){
    hideLoginMessages();
    var newPassword=document.getElementById('new-password').value;
    var confirmPassword=document.getElementById('confirm-password').value;
    
    if(!newPassword||!confirmPassword){
        showLoginError('Please fill in both password fields');
        return;
    }
    if(newPassword.length<6){
        showLoginError('Password must be at least 6 characters');
        return;
    }
    if(newPassword!==confirmPassword){
        showLoginError('Passwords do not match');
        return;
    }
    
    document.getElementById('update-password-btn').disabled=true;
    document.getElementById('update-password-btn').textContent='Updating...';
    
    try{
        var result=await supabase.auth.updateUser({password:newPassword});
        if(result.error)throw result.error;
        showLoginSuccess('Password updated successfully! Signing you in...');
        // Clear the recovery flag
        window.isPasswordRecovery = false;
        // Clear the hash from URL
        history.replaceState(null,'',window.location.pathname);
        // Reload after a moment to complete sign in
        setTimeout(function(){
            window.location.reload();
        }, 1500);
    }catch(err){
        showLoginError(err.message||'Failed to update password');
        document.getElementById('update-password-btn').disabled=false;
        document.getElementById('update-password-btn').textContent='Update Password';
    }
}

// ==================== SUPABASE DATA FUNCTIONS ====================
// Helper: fetch with timeout
function fetchWithTimeout(promise, timeoutMs, tableName){
    return Promise.race([
        promise,
        new Promise(function(_,reject){
            setTimeout(function(){reject(new Error('Timeout fetching '+tableName));}, timeoutMs);
        })
    ]);
}

async function loadFromSupabase(){
    showSyncStatus('syncing');
    console.log('loadFromSupabase starting...');
    try{
        // Load all tables with timeout - 10 seconds per table
        console.log('Fetching main tables...');
        var [areas,cats,menuCats,units,ings,inv,shopping,preps,recs,menus,log]=await Promise.all([
            fetchWithTimeout(supabase.from('areas').select('*').order('id'), 10000, 'areas'),
            fetchWithTimeout(supabase.from('cats').select('*').order('id'), 10000, 'cats'),
            fetchWithTimeout(supabase.from('menu_cats').select('*').order('id'), 10000, 'menu_cats'),
            fetchWithTimeout(supabase.from('units').select('*').order('id'), 10000, 'units'),
            fetchWithTimeout(supabase.from('ings').select('*').order('id'), 10000, 'ings'),
            fetchWithTimeout(supabase.from('inv').select('*').order('id'), 10000, 'inv'),
            fetchWithTimeout(supabase.from('shopping').select('*').order('id'), 10000, 'shopping'),
            fetchWithTimeout(supabase.from('preps').select('*').order('id'), 10000, 'preps'),
            fetchWithTimeout(supabase.from('recs').select('*').order('id'), 10000, 'recs'),
            fetchWithTimeout(supabase.from('menus').select('*').order('id'), 10000, 'menus'),
            fetchWithTimeout(supabase.from('log').select('*').order('created_at',{ascending:false}).limit(100), 10000, 'log')
        ]);
        console.log('Main tables fetched');
        
        // Try to load rec_cats separately (table might not exist)
        var recCats = {data: []};
        try {
            recCats = await supabase.from('rec_cats').select('*').order('id');
            console.log('rec_cats fetched:', recCats.data?.length || 0);
        } catch(e) {
            console.log('rec_cats table not found, using defaults');
        }
        
        // Try to load conversions separately (table might not exist)
        var conversions = {data: []};
        try {
            conversions = await supabase.from('conversions').select('*').order('id');
            console.log('conversions fetched:', conversions.data?.length || 0);
        } catch(e) {
            console.log('conversions table not found');
        }
        
        // Check if database has data, if not, migrate from localStorage/defaults
        if(!areas.data||areas.data.length===0){
            console.log('Database empty, migrating initial data...');
            await migrateToSupabase();
            return loadFromSupabase(); // Reload after migration
        }

        // NOTE: We no longer auto-restore deleted default ingredients/recipes
        // If a user deletes an item, it should stay deleted
        // Defaults are only used for initial database setup (handled by migrateToSupabase)
        if(false){ // Disabled - defaults should not be auto-restored

            console.log('Missing defaults synced to Supabase');
        }
        
        console.log('Mapping data to local format...');

        // Map cloud data
        var cloudData = {
            areas: areas.data.map(mapAreaFromDb),
            cats: cats.data||[],
            menuCats: (menuCats.data||[]).map(function(c){return{id:c.id,name:c.name};}),
            recCats: (recCats.data||[]).map(function(c){return{id:c.id,name:c.name};}),
            conversions: (conversions.data||[]).map(mapConvFromDb),
            units: units.data||[],
            ings: (ings.data||[]).map(mapIngFromDb),
            inv: (inv.data||[]).map(mapInvFromDb),
            shopping: (shopping.data||[]).map(mapShoppingFromDb),
            preps: (preps.data||[]).map(mapPrepFromDb),
            recs: (recs.data||[]).map(mapRecFromDb),
            menus: (menus.data||[]).map(mapMenuFromDb),
            log: (log.data||[]).map(mapLogFromDb)
        };

        // Load local data from localStorage for comparison
        var localData = null;
        try {
            var saved = localStorage.getItem('ro_allData');
            if(saved) localData = JSON.parse(saved);
        } catch(e) {
            console.log('Could not parse localStorage data');
        }

        // Check for data conflicts - if local has MORE data, warn user
        var conflict = false;
        var conflictDetails = [];

        if(localData) {
            // Check inventory specifically (most important for data loss)
            var localInvCount = (localData.inv||[]).length;
            var cloudInvCount = cloudData.inv.length;
            if(localInvCount > cloudInvCount) {
                conflict = true;
                conflictDetails.push('Inventory: Local has ' + localInvCount + ' items, Cloud has ' + cloudInvCount);
            }

            // Check other important tables
            var localIngsCount = (localData.ings||[]).length;
            var cloudIngsCount = cloudData.ings.length;
            if(localIngsCount > cloudIngsCount) {
                conflict = true;
                conflictDetails.push('Ingredients: Local has ' + localIngsCount + ', Cloud has ' + cloudIngsCount);
            }

            var localRecsCount = (localData.recs||[]).length;
            var cloudRecsCount = cloudData.recs.length;
            if(localRecsCount > cloudRecsCount) {
                conflict = true;
                conflictDetails.push('Recipes: Local has ' + localRecsCount + ', Cloud has ' + cloudRecsCount);
            }

            var localMenusCount = (localData.menus||[]).length;
            var cloudMenusCount = cloudData.menus.length;
            if(localMenusCount > cloudMenusCount) {
                conflict = true;
                conflictDetails.push('Menus: Local has ' + localMenusCount + ', Cloud has ' + cloudMenusCount);
            }
        }

        // If conflict detected, ask user what to do
        if(conflict) {
            console.warn('DATA CONFLICT DETECTED:', conflictDetails);
            var useLocal = confirm(
                '‚ö†Ô∏è DATA CONFLICT DETECTED!\n\n' +
                'Your device has MORE data than the cloud:\n' +
                conflictDetails.join('\n') + '\n\n' +
                'Click OK to KEEP your local data (recommended)\n' +
                'Click CANCEL to use cloud data (may lose work)'
            );

            if(useLocal && localData) {
                console.log('User chose to keep local data');
                // Use local data instead
                D.areas = localData.areas || cloudData.areas;
                D.cats = localData.cats || cloudData.cats;
                D.menuCats = localData.menuCats || cloudData.menuCats;
                D.recCats = localData.recCats || cloudData.recCats;
                if(!D.recCats || !D.recCats.length) D.recCats=[{id:1,name:'Fillings'},{id:2,name:'Doughs'},{id:3,name:'Sauces'},{id:4,name:'Cocktails'},{id:5,name:'Desserts'},{id:6,name:'Brunch'}];
                D.conversions = localData.conversions || cloudData.conversions || [];
                D.units = localData.units || cloudData.units;
                if(!D.units || !D.units.length) D.units = getDefaultUnits();
                D.ings = localData.ings || cloudData.ings;
                D.inv = localData.inv || cloudData.inv;
                D.shopping = localData.shopping || cloudData.shopping;
                D.preps = localData.preps || cloudData.preps;
                D.recs = localData.recs || cloudData.recs;
                D.menus = localData.menus || cloudData.menus;
                D.log = localData.log || cloudData.log || [];
                console.log('Loaded from localStorage:', D.inv.length, 'inventory items');

                // Mark everything as changed so it syncs to cloud
                D.areas.forEach(function(a){ changeLog.areas.add(a.id); });
                D.cats.forEach(function(c){ changeLog.cats.add(c.id); });
                D.menuCats.forEach(function(c){ changeLog.menuCats.add(c.id); });
                D.recCats.forEach(function(c){ changeLog.recCats.add(c.id); });
                D.ings.forEach(function(i){ changeLog.ings.add(i.id); });
                D.inv.forEach(function(i){ changeLog.inv.add(i.id); });
                D.shopping.forEach(function(s){ changeLog.shopping.add(s.id); });
                D.preps.forEach(function(p){ changeLog.preps.add(p.id); });
                D.recs.forEach(function(r){ changeLog.recs.add(r.id); });
                D.menus.forEach(function(m){ changeLog.menus.add(m.id); });

                // Auto-sync local data to cloud
                setTimeout(function(){
                    console.log('Auto-syncing local data to cloud...');
                    syncNow();
                }, 1000);

                migrateMenuData();
                var settings=await supabase.from('settings').select('*');
                if(settings.data){
                    settings.data.forEach(function(s){
                        if(s.key==='autoAddToInv')D.autoAddToInv=s.value?1:0;
                    });
                }
                takeSyncSnapshot();
                showSyncStatus('synced');
                return; // Exit early, we used local data
            }
        }

        // No conflict or user chose cloud data - use cloud data
        D.areas = cloudData.areas;
        D.cats = cloudData.cats;
        D.menuCats = cloudData.menuCats;
        D.recCats = cloudData.recCats;
        if(!D.recCats.length) D.recCats=[{id:1,name:'Fillings'},{id:2,name:'Doughs'},{id:3,name:'Sauces'},{id:4,name:'Cocktails'},{id:5,name:'Desserts'},{id:6,name:'Brunch'}];
        D.conversions = cloudData.conversions;
        D.units = cloudData.units;
        // Fallback to default units if database is empty
        if(!D.units.length) D.units = getDefaultUnits();
        D.ings = cloudData.ings;
        D.inv = cloudData.inv;
        console.log('Loaded inventory from Supabase:', D.inv.length, 'items', D.inv);
        D.shopping = cloudData.shopping;
        D.preps = cloudData.preps;
        D.recs = cloudData.recs;
        D.menus = cloudData.menus;
        D.log = cloudData.log;
        console.log('Data mapped, recs:', D.recs.length, 'recCats:', D.recCats.length);
        
        // Migrate menu data to new format if needed
        migrateMenuData();

        // Load settings
        var settings=await supabase.from('settings').select('*');
        if(settings.data){
            settings.data.forEach(function(s){
                if(s.key==='autoAddToInv')D.autoAddToInv=s.value?1:0;
            });
        }
        
        takeSyncSnapshot(); // Store snapshot of synced data
        console.log('loadFromSupabase complete, calling showSyncStatus');
        showSyncStatus('synced');
    }catch(err){
        console.error('Load from Supabase error:',err);
        showSyncStatus('offline');
        // Fall back to localStorage
        loadAllDataLocal();
        takeSyncSnapshot(); // Still take snapshot so sync can work later
    }
}

// Helper to get default units
function getDefaultUnits(){
    return [
        {id:1,name:'each',abbr:'ea'},{id:2,name:'pound',abbr:'lb'},{id:3,name:'ounce',abbr:'oz'},{id:4,name:'gram',abbr:'g'},{id:5,name:'kilogram',abbr:'kg'},
        {id:6,name:'cup',abbr:'cup'},{id:7,name:'tablespoon',abbr:'tbsp'},{id:8,name:'teaspoon',abbr:'tsp'},{id:9,name:'fluid ounce',abbr:'fl oz'},{id:10,name:'milliliter',abbr:'ml'},
        {id:11,name:'liter',abbr:'L'},{id:12,name:'gallon',abbr:'gal'},{id:13,name:'quart',abbr:'qt'},{id:14,name:'pint',abbr:'pt'},{id:15,name:'bunch',abbr:'bunch'},
        {id:16,name:'head',abbr:'head'},{id:17,name:'clove',abbr:'clove'},{id:18,name:'slice',abbr:'slice'},{id:19,name:'piece',abbr:'pc'},{id:20,name:'package',abbr:'pkg'},
        {id:21,name:'can',abbr:'can'},{id:22,name:'jar',abbr:'jar'},{id:23,name:'bottle',abbr:'btl'},{id:24,name:'box',abbr:'box'},{id:25,name:'bag',abbr:'bag'},
        {id:26,name:'case',abbr:'case'},{id:27,name:'dozen',abbr:'doz'},{id:28,name:'half dozen',abbr:'1/2 doz'},{id:29,name:'bottle wine',abbr:'btl'},{id:30,name:'batch',abbr:'batch'},
        {id:31,name:'portion',abbr:'portion'},{id:32,name:'serving',abbr:'srv'},{id:33,name:'sheet',abbr:'sheet'},{id:34,name:'rack',abbr:'rack'},{id:35,name:'tray',abbr:'tray'},
        {id:36,name:'pan',abbr:'pan'},{id:37,name:'hotel pan',abbr:'hotel'},{id:38,name:'half hotel',abbr:'1/2 hotel'},{id:39,name:'third hotel',abbr:'1/3 hotel'},{id:40,name:'sixth hotel',abbr:'1/6 hotel'},
        {id:41,name:'cambro',abbr:'cambro'},{id:42,name:'lexan',abbr:'lexan'},{id:43,name:'quart container',abbr:'qt cont'},{id:44,name:'pint container',abbr:'pt cont'},{id:45,name:'deli container',abbr:'deli'}
    ];
}

// Field mapping functions (database snake_case to local camelCase)
function mapAreaFromDb(a){return{id:a.id,name:a.name,sections:a.sections||[],prep:a.prep||0};}
function mapIngFromDb(i){return{id:i.id,name:i.name,catId:i.cat_id,areaId:i.area_id,subArea:i.sub_area||'',defUnit:i.unit||'ea',archived:i.archived||0,standalone:i.standalone||0,minQty:i.par||0,autoShop:i.auto_shop||0,cost:i.cost||0};}
function mapInvFromDb(i){return{id:i.id,areaId:i.area_id,subArea:i.sub_area||'',ingId:i.ing_id||0,recId:i.rec_id||0,menuId:i.menu_id||0,qty:i.qty||0,unit:i.unit||'ea'};}
function mapShoppingFromDb(s){return{id:s.id,ingId:s.ing_id,qty:s.qty||0,unit:s.unit||'ea',checked:s.checked||0,savedForLater:s.saved_for_later||0};}
function mapPrepFromDb(p){return{id:p.id,name:p.name,recId:p.rec_id,onHand:p.on_hand||0,tgt:p.tgt||0,unit:p.unit||'batch',areaId:p.area_id};}
function mapRecFromDb(r){return{id:r.id,name:r.name,group:r.group_name||'',catId:r.cat_id,yield:r.yield||98,yieldUnit:r.yield_unit||'',outputMode:r.output_mode||'auto',manualQty:r.manual_qty||0,shelfLife:r.shelf_life||'',notes:r.notes||'',ings:r.ings||[],preps:r.preps||[],subRecs:r.sub_recs||[],photos:r.photos||[],videos:r.videos||[],archived:r.archived||0,includeInPrep:r.include_in_prep===0?0:1};}
function mapMenuFromDb(m){return{id:m.id,name:m.name,catId:m.cat_id,tgt:m.tgt||0,unitId:m.unit_id,ings:m.ings||[],recs:m.recs||[],archived:m.archived||0,includeInShop:m.include_in_shop===0?0:1,includeInPrep:m.include_in_prep===0?0:1};}
function mapLogFromDb(l){return{id:l.id,action:l.action,location:l.location||'',detail:l.detail||'',user:l.user_name||'',time:l.created_at};}
function mapConvFromDb(c){return{id:c.id,ingId:c.ing_id,storageUnit:c.storage_unit,recipeUnit:c.recipe_unit,factor:c.factor||1};}

// Mapping functions for saving (local camelCase to database snake_case)
function mapAreaToDb(a){return{id:a.id,name:a.name,sections:a.sections,prep:a.prep};}
function mapIngToDb(i){return{id:i.id,name:i.name,cat_id:i.catId,area_id:i.areaId,sub_area:i.subArea,unit:i.defUnit,archived:i.archived,standalone:i.standalone,par:i.minQty,auto_shop:i.autoShop,cost:i.cost||0};}
function mapInvToDb(i){return{id:i.id,area_id:i.areaId,sub_area:i.subArea,ing_id:i.ingId||null,rec_id:i.recId||null,menu_id:i.menuId||null,qty:i.qty,unit:i.unit};}
function mapShoppingToDb(s){return{id:s.id,ing_id:s.ingId,qty:s.qty,unit:s.unit,checked:s.checked,saved_for_later:s.savedForLater};}
function mapPrepToDb(p){return{id:p.id,name:p.name,rec_id:p.recId,on_hand:p.onHand,tgt:p.tgt,unit:p.unit,area_id:p.areaId};}
function mapRecToDb(r){return{id:r.id,name:r.name,group_name:r.group,cat_id:r.catId,yield:r.yield,yield_unit:r.yieldUnit,output_mode:r.outputMode,manual_qty:r.manualQty,shelf_life:r.shelfLife,notes:r.notes,ings:r.ings,preps:r.preps,sub_recs:r.subRecs,photos:r.photos,videos:r.videos,archived:r.archived,include_in_prep:r.includeInPrep};}
function mapMenuToDb(m){return{id:m.id,name:m.name,cat_id:m.catId,tgt:m.tgt,unit_id:m.unitId,ings:m.ings,recs:m.recs,archived:m.archived,include_in_shop:m.includeInShop,include_in_prep:m.includeInPrep};}
function mapConvToDb(c){return{id:c.id,ing_id:c.ingId,storage_unit:c.storageUnit,recipe_unit:c.recipeUnit,factor:c.factor};}
function mapLogToDb(l){return{id:l.id,action:'Inventory: '+l.item,location:'',detail:l.oldQty+' '+l.oldUnit+' ‚Üí '+l.newQty+' '+l.newUnit,user_name:l.user,created_at:l.timestamp};}

async function migrateToSupabase(){
    console.log('Migrating data to Supabase...');
    showSyncStatus('syncing');
    
    try{
        // Insert default/localStorage data into Supabase
        if(D.areas.length)await supabase.from('areas').upsert(D.areas.map(mapAreaToDb));
        if(D.cats.length)await supabase.from('cats').upsert(D.cats);
        if(D.menuCats.length)await supabase.from('menu_cats').upsert(D.menuCats.map(function(c){return{id:c.id,name:c.name};}));
        if(D.recCats&&D.recCats.length)await supabase.from('rec_cats').upsert(D.recCats.map(function(c){return{id:c.id,name:c.name};}));
        if(D.units.length)await supabase.from('units').upsert(D.units);
        if(D.ings.length)await supabase.from('ings').upsert(D.ings.map(mapIngToDb));
        if(D.inv.length)await supabase.from('inv').upsert(D.inv.map(mapInvToDb));
        if(D.shopping.length)await supabase.from('shopping').upsert(D.shopping.map(mapShoppingToDb));
        if(D.preps.length)await supabase.from('preps').upsert(D.preps.map(mapPrepToDb));
        if(D.recs.length)await supabase.from('recs').upsert(D.recs.map(mapRecToDb));
        if(D.menus.length)await supabase.from('menus').upsert(D.menus.map(mapMenuToDb));
        
        console.log('Migration complete!');
        showSyncStatus('synced');
    }catch(err){
        console.error('Migration error:',err);
        showSyncStatus('offline');
    }
}

async function saveToSupabase(table,data,isDelete){
    if(!supabase||!currentAuthUser){
        saveAllDataLocal();
        return;
    }
    
    showSyncStatus('syncing');
    
    try{
        if(isDelete){
            await supabase.from(table).delete().eq('id',data.id);
        }else{
            await supabase.from(table).upsert(data);
        }
        showSyncStatus('synced');
    }catch(err){
        console.error('Save to Supabase error:',err);
        showSyncStatus('offline');
        // Queue for later
        syncQueue.push({table:table,data:data,isDelete:isDelete});
        saveAllDataLocal();
    }
}

async function syncNow(){
    console.log('syncNow called');
    console.log('supabase:', !!supabase, 'currentAuthUser:', !!currentAuthUser);
    
    if(!supabase||!currentAuthUser){
        alert('Not connected to cloud. Please sign in.');
        return;
    }
    
    // If initial load not complete, do full sync
    if(!initialLoadComplete){
        console.log('Initial load not complete, doing full sync...');
        showSyncStatus('syncing');
        try{
            var results = await Promise.all([
                supabase.from('areas').upsert(D.areas.map(mapAreaToDb)),
                supabase.from('cats').upsert(D.cats),
                supabase.from('menu_cats').upsert(D.menuCats.map(function(c){return{id:c.id,name:c.name};})),
                supabase.from('units').upsert(D.units),
                supabase.from('ings').upsert(D.ings.map(mapIngToDb)),
                supabase.from('inv').upsert(D.inv.map(mapInvToDb)),
                supabase.from('shopping').upsert(D.shopping.map(mapShoppingToDb)),
                supabase.from('preps').upsert(D.preps.map(mapPrepToDb)),
                supabase.from('recs').upsert(D.recs.map(mapRecToDb)),
                supabase.from('menus').upsert(D.menus.map(mapMenuToDb)),
                supabase.from('settings').upsert({id:1,key:'autoAddToInv',value:D.autoAddToInv?true:false})
            ]);
            console.log('Full sync results:', results);
            takeSyncSnapshot();
            clearChangeLog();
            showSyncStatus('synced');
            return;
        }catch(err){
            console.error('Full sync error:',err);
            showSyncStatus('offline');
            alert('Sync failed: '+err.message);
            return;
        }
    }
    
    // Use differential sync - only sync changes
    showSyncStatus('syncing');
    console.log('Starting differential sync...');
    
    // Detect changes
    detectAllChanges();
    
    if(!hasChanges()){
        console.log('No changes to sync');
        showSyncStatus('synced');
        return;
    }
    
    console.log('Syncing changes:', JSON.stringify({
        areas: changeLog.areas.size,
        cats: changeLog.cats.size,
        menuCats: changeLog.menuCats.size,
        recCats: changeLog.recCats.size,
        units: changeLog.units.size,
        ings: changeLog.ings.size,
        inv: changeLog.inv.size,
        shopping: changeLog.shopping.size,
        preps: changeLog.preps.size,
        recs: changeLog.recs.size,
        menus: changeLog.menus.size,
        settings: changeLog.settings
    }));
    
    try{
        var promises = [];
        
        // Only sync tables that have changes
        if(changeLog.areas.size > 0){
            var items = getChangedItems('areas', D.areas, mapAreaToDb);
            if(items.length) promises.push(supabase.from('areas').upsert(items));
        }
        if(deleteLog.areas.size > 0){
            promises.push(supabase.from('areas').delete().in('id', getDeletedIds('areas')));
        }
        
        if(changeLog.cats.size > 0){
            var items = getChangedItems('cats', D.cats);
            if(items.length) promises.push(supabase.from('cats').upsert(items));
        }
        if(deleteLog.cats.size > 0){
            promises.push(supabase.from('cats').delete().in('id', getDeletedIds('cats')));
        }
        
        if(changeLog.menuCats.size > 0){
            var items = getChangedItems('menuCats', D.menuCats, function(c){return{id:c.id,name:c.name};});
            if(items.length) promises.push(supabase.from('menu_cats').upsert(items));
        }
        if(deleteLog.menuCats.size > 0){
            promises.push(supabase.from('menu_cats').delete().in('id', getDeletedIds('menuCats')));
        }
        
        if(changeLog.recCats.size > 0){
            var items = getChangedItems('recCats', D.recCats||[], function(c){return{id:c.id,name:c.name};});
            if(items.length) promises.push(supabase.from('rec_cats').upsert(items));
        }
        if(deleteLog.recCats.size > 0){
            promises.push(supabase.from('rec_cats').delete().in('id', getDeletedIds('recCats')));
        }
        
        if(changeLog.units.size > 0){
            var items = getChangedItems('units', D.units);
            if(items.length) promises.push(supabase.from('units').upsert(items));
        }
        if(deleteLog.units.size > 0){
            promises.push(supabase.from('units').delete().in('id', getDeletedIds('units')));
        }
        
        if(changeLog.ings.size > 0){
            var items = getChangedItems('ings', D.ings, mapIngToDb);
            if(items.length) promises.push(supabase.from('ings').upsert(items));
        }
        if(deleteLog.ings.size > 0){
            promises.push(supabase.from('ings').delete().in('id', getDeletedIds('ings')));
        }
        
        if(changeLog.inv.size > 0){
            var items = getChangedItems('inv', D.inv, mapInvToDb);
            console.log('Syncing inventory changes:', items.length, 'items', items);
            if(items.length) promises.push(supabase.from('inv').upsert(items));
        }
        if(deleteLog.inv.size > 0){
            console.log('Deleting inventory items:', getDeletedIds('inv'));
            promises.push(supabase.from('inv').delete().in('id', getDeletedIds('inv')));
        }
        
        if(changeLog.shopping.size > 0){
            var items = getChangedItems('shopping', D.shopping, mapShoppingToDb);
            if(items.length) promises.push(supabase.from('shopping').upsert(items));
        }
        if(deleteLog.shopping.size > 0){
            promises.push(supabase.from('shopping').delete().in('id', getDeletedIds('shopping')));
        }
        
        if(changeLog.preps.size > 0){
            var items = getChangedItems('preps', D.preps, mapPrepToDb);
            if(items.length) promises.push(supabase.from('preps').upsert(items));
        }
        if(deleteLog.preps.size > 0){
            promises.push(supabase.from('preps').delete().in('id', getDeletedIds('preps')));
        }
        
        if(changeLog.recs.size > 0){
            var items = getChangedItems('recs', D.recs, mapRecToDb);
            if(items.length) promises.push(supabase.from('recs').upsert(items));
        }
        if(deleteLog.recs.size > 0){
            promises.push(supabase.from('recs').delete().in('id', getDeletedIds('recs')));
        }
        
        if(changeLog.menus.size > 0){
            var items = getChangedItems('menus', D.menus, mapMenuToDb);
            if(items.length) promises.push(supabase.from('menus').upsert(items));
        }
        if(deleteLog.menus.size > 0){
            promises.push(supabase.from('menus').delete().in('id', getDeletedIds('menus')));
        }
        
        if(changeLog.conversions && changeLog.conversions.size > 0){
            var items = getChangedItems('conversions', D.conversions, mapConvToDb);
            if(items.length) promises.push(supabase.from('conversions').upsert(items));
        }
        if(deleteLog.conversions && deleteLog.conversions.size > 0){
            promises.push(supabase.from('conversions').delete().in('id', getDeletedIds('conversions')));
        }
        
        if(changeLog.settings){
            promises.push(supabase.from('settings').upsert({id:1,key:'autoAddToInv',value:D.autoAddToInv?true:false}));
        }

        // Sync log entries
        if(changeLog.log && changeLog.log.size > 0){
            var logItems = D.log.filter(function(l){return changeLog.log.has(l.id);}).map(mapLogToDb);
            if(logItems.length) promises.push(supabase.from('log').upsert(logItems));
        }

        if(promises.length === 0){
            console.log('No sync operations needed');
            showSyncStatus('synced');
            return;
        }
        
        console.log('Executing', promises.length, 'sync operations...');
        var results = await Promise.all(promises);
        console.log('Sync results:', results);
        
        // Update snapshot and clear change log
        takeSyncSnapshot();
        clearChangeLog();
        
        showSyncStatus('synced');
        console.log('Sync complete');
    }catch(err){
        console.error('Sync error:',err);
        showSyncStatus('offline');
        alert('Sync failed: '+err.message);
    }
}

function setupRealtimeSync(){
    // Disabled for now - causes performance issues with reload loops
    // Users can manually sync with "Sync Now" button or refresh the page
    // Real-time sync will be re-enabled in a future update with smarter merging
    console.log('Real-time sync disabled for performance');
    return;
    
    /*
    if(!supabase||realtimeChannel)return;
    
    realtimeChannel=supabase.channel('db-changes')
        .on('postgres_changes',{event:'*',schema:'public'},function(payload){
            console.log('Realtime update:',payload);
            // Reload data on any change
            loadFromSupabase().then(render);
        })
        .subscribe();
    */
}

function showSyncStatus(status){
    var el=document.getElementById('sync-status');
    el.className='sync-status '+status;
    if(status==='syncing')el.textContent='‚è≥ Syncing...';
    else if(status==='synced')el.textContent='‚úì Synced';
    else if(status==='offline')el.textContent='‚ö† Offline';
    else if(status==='unsaved')el.textContent='‚óè Unsaved';
    
    // Hide after 2 seconds if synced
    if(status==='synced'){
        setTimeout(function(){el.className='sync-status';},2000);
    }
}

// Online/offline handling
window.addEventListener('online',function(){
    isOnline=true;
    // Don't auto-sync, let user do it manually
});
window.addEventListener('offline',function(){
    isOnline=false;
    showSyncStatus('offline');
});

// ==================== DATA ====================
var D={
    fontScale:1,
    autoAddToInv:0,
    currentUser:{id:1,name:'Owner',role:'owner'},
    users:[{id:1,name:'Owner',role:'owner',email:'owner@lachona.com',phone:''},{id:2,name:'Maria',role:'employee',email:'maria@lachona.com',phone:''}],
    areas:[
        {id:1,name:'Oven Fridge',sections:[],prep:1},
        {id:2,name:'Dairy Fridge',sections:[],prep:1},
        {id:3,name:'Prep Fridge',sections:['Left','Middle','Right'],prep:1},
        {id:4,name:'Main Prep Table',sections:[],prep:1},
        {id:5,name:'Oven Prep Table',sections:[],prep:1},
        {id:6,name:'Dishwasher',sections:[],prep:0},
        {id:7,name:'Sheeter',sections:[],prep:0},
        {id:8,name:'Freezer',sections:[],prep:1},
        {id:9,name:'Hallway Fridge',sections:[],prep:1},
        {id:10,name:'Stairs',sections:[],prep:0},
        {id:11,name:'Wine Display',sections:['Left Column','Top Row','Right Column'],prep:0},
        {id:12,name:'Left Wine Fridge',sections:[],prep:1},
        {id:13,name:'Right Wine Fridge',sections:[],prep:1}
    ],
    cats:[{id:1,name:'Meat'},{id:2,name:'Produce'},{id:3,name:'Dairy'},{id:4,name:'Dry Goods'},{id:5,name:'Liquids'},{id:6,name:'Supplies'},{id:7,name:'Bar/Spirits'},{id:8,name:'Bar/Wine'},{id:9,name:'Bar/Mixers'}],
    menuCats:[{id:1,name:'Empanadas'},{id:2,name:'Ensalada'},{id:3,name:'Tapas'},{id:4,name:'Soup'},{id:5,name:'Desserts'},{id:6,name:'Red Wine'},{id:7,name:'White & Sparkling'},{id:8,name:'Cocktails'},{id:9,name:'Brunch'},{id:10,name:'Beverages'},{id:11,name:'Sides'}],
    recCats:[{id:1,name:'Fillings'},{id:2,name:'Doughs'},{id:3,name:'Sauces'},{id:4,name:'Cocktails'},{id:5,name:'Desserts'},{id:6,name:'Brunch'}],
    units:[
        {id:1,name:'each',abbr:'ea'},{id:2,name:'pound',abbr:'lb'},{id:3,name:'ounce',abbr:'oz'},{id:4,name:'gram',abbr:'g'},{id:5,name:'kilogram',abbr:'kg'},
        {id:6,name:'cup',abbr:'cup'},{id:7,name:'tablespoon',abbr:'tbsp'},{id:8,name:'teaspoon',abbr:'tsp'},{id:9,name:'fluid ounce',abbr:'fl oz'},{id:10,name:'milliliter',abbr:'ml'},
        {id:11,name:'liter',abbr:'L'},{id:12,name:'gallon',abbr:'gal'},{id:13,name:'quart',abbr:'qt'},{id:14,name:'pint',abbr:'pt'},{id:15,name:'bunch',abbr:'bunch'},
        {id:16,name:'head',abbr:'head'},{id:17,name:'clove',abbr:'clove'},{id:18,name:'slice',abbr:'slice'},{id:19,name:'piece',abbr:'pc'},{id:20,name:'package',abbr:'pkg'},
        {id:21,name:'can',abbr:'can'},{id:22,name:'jar',abbr:'jar'},{id:23,name:'bottle',abbr:'btl'},{id:24,name:'box',abbr:'box'},{id:25,name:'bag',abbr:'bag'},
        {id:26,name:'case',abbr:'case'},{id:27,name:'dozen',abbr:'doz'},{id:28,name:'half dozen',abbr:'1/2 doz'},{id:29,name:'bottle wine',abbr:'btl'},{id:30,name:'batch',abbr:'batch'},
        {id:31,name:'portion',abbr:'portion'},{id:32,name:'serving',abbr:'srv'},{id:33,name:'sheet',abbr:'sheet'},{id:34,name:'rack',abbr:'rack'},{id:35,name:'tray',abbr:'tray'},
        {id:36,name:'pan',abbr:'pan'},{id:37,name:'hotel pan',abbr:'hotel'},{id:38,name:'half hotel',abbr:'1/2 hotel'},{id:39,name:'third hotel',abbr:'1/3 hotel'},{id:40,name:'sixth hotel',abbr:'1/6 hotel'},
        {id:41,name:'cambro',abbr:'cambro'},{id:42,name:'lexan',abbr:'lexan'},{id:43,name:'quart container',abbr:'qt cont'},{id:44,name:'pint container',abbr:'pt cont'},{id:45,name:'deli container',abbr:'deli'},
        {id:46,name:'squeeze bottle',abbr:'squeeze'},{id:47,name:'roll',abbr:'roll'},{id:48,name:'sleeve',abbr:'sleeve'},{id:49,name:'stick',abbr:'stick'},{id:50,name:'bar',abbr:'bar'},
        {id:51,name:'cube',abbr:'cube'},{id:52,name:'pack',abbr:'pack'}
    ],
    ings:[
        {id:1,name:'Ground Beef',catId:1,areaId:1,subArea:'',defUnit:'lb',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:2,name:'Chicken Breast',catId:1,areaId:1,subArea:'',defUnit:'lb',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:3,name:'Sweet Onion',catId:2,areaId:3,subArea:'Left',defUnit:'lb',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:4,name:'Sweet Red Pepper',catId:2,areaId:3,subArea:'Middle',defUnit:'ea',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:5,name:'Potatoes',catId:2,areaId:3,subArea:'Right',defUnit:'lb',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:6,name:'Cheese',catId:3,areaId:2,subArea:'',defUnit:'lb',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:7,name:'Eggs',catId:3,areaId:2,subArea:'',defUnit:'ea',archived:0,standalone:1,minQty:24,autoShop:1},
        {id:8,name:'Flour',catId:4,areaId:10,subArea:'',defUnit:'lb',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:9,name:'Salt',catId:4,areaId:4,subArea:'',defUnit:'lb',archived:0,standalone:1,minQty:2,autoShop:1},
        {id:10,name:'Olive Oil',catId:5,areaId:10,subArea:'',defUnit:'gal',archived:0,standalone:1,minQty:1,autoShop:1},
        {id:11,name:'Carrots',catId:2,areaId:3,subArea:'Left',defUnit:'cup',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:12,name:'Prego Sauce',catId:5,areaId:10,subArea:'',defUnit:'cup',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:13,name:'Veg Broth Cubes',catId:4,areaId:4,subArea:'',defUnit:'cube',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:14,name:'Beef Bouillon',catId:4,areaId:4,subArea:'',defUnit:'cup',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:15,name:'Chicken Bouillon',catId:4,areaId:4,subArea:'',defUnit:'cup',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:16,name:'Paprika',catId:4,areaId:4,subArea:'',defUnit:'tbsp',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:17,name:'Cumin',catId:4,areaId:4,subArea:'',defUnit:'tbsp',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:18,name:'Empanada Mix Seasoning',catId:4,areaId:4,subArea:'',defUnit:'tbsp',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:19,name:'Chicken Package',catId:1,areaId:8,subArea:'',defUnit:'pack',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:20,name:'Pizza Mix Seasoning',catId:4,areaId:4,subArea:'',defUnit:'tbsp',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:21,name:'Green Olives',catId:4,areaId:10,subArea:'',defUnit:'jar',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:22,name:'Spanish Olives',catId:4,areaId:10,subArea:'',defUnit:'jar',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:23,name:'Oregano',catId:4,areaId:4,subArea:'',defUnit:'tbsp',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:24,name:'Taco Seasoning',catId:4,areaId:4,subArea:'',defUnit:'pkg',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:25,name:'Spinach',catId:2,areaId:3,subArea:'Middle',defUnit:'pkg',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:26,name:'Parmesan Cheese',catId:3,areaId:2,subArea:'',defUnit:'jar',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:27,name:'Mozzarella Bar',catId:3,areaId:2,subArea:'',defUnit:'bar',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:28,name:'Broccoli',catId:2,areaId:3,subArea:'Right',defUnit:'bag',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:29,name:'Water',catId:5,areaId:4,subArea:'',defUnit:'cup',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:30,name:'Gin',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:31,name:'Vermouth',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:32,name:'Cointreau',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:33,name:'DOM Benedictine',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:34,name:'Bitters',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:35,name:'Vodka',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:36,name:'Tequila',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:37,name:'Rum',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:38,name:'Fernet',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:39,name:'Rye Whiskey',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:40,name:'XO Brandy',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:41,name:'Amaro di Montenegro',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:42,name:'Campari',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:43,name:'Irish Cream',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:44,name:'Raspberry di Amore',catId:7,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:45,name:'Simple Syrup',catId:9,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:46,name:'Pancake Syrup',catId:9,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:47,name:'Lemons',catId:2,areaId:3,subArea:'',defUnit:'oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:48,name:'Limes',catId:2,areaId:3,subArea:'',defUnit:'ea',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:49,name:'Strawberries',catId:2,areaId:3,subArea:'',defUnit:'oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:50,name:'Raspberries',catId:2,areaId:3,subArea:'',defUnit:'oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:51,name:'Blackberries',catId:2,areaId:3,subArea:'',defUnit:'oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:52,name:'Tomato Juice',catId:9,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:53,name:'Worcestershire',catId:9,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:54,name:'Hot Sauce',catId:9,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:55,name:'Black Pepper',catId:4,areaId:4,subArea:'',defUnit:'oz',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:56,name:'Celery Salt',catId:4,areaId:4,subArea:'',defUnit:'oz',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:57,name:'Bacon',catId:1,areaId:1,subArea:'',defUnit:'oz',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:58,name:'Tonic Water',catId:9,areaId:10,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:59,name:'Club Soda',catId:9,areaId:10,subArea:'',defUnit:'ea',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:60,name:'Cinnamon',catId:4,areaId:4,subArea:'',defUnit:'oz',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:61,name:'Cinnamon Stick',catId:4,areaId:4,subArea:'',defUnit:'ea',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:62,name:'Orange Juice',catId:9,areaId:3,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:63,name:'Concord Espresso',catId:9,areaId:4,subArea:'',defUnit:'oz',archived:0,standalone:0,minQty:0,autoShop:0},
        {id:64,name:'LaChona Reserva Blend 2021',catId:8,areaId:12,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:65,name:'LaChona White Malbec Rose',catId:8,areaId:12,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:66,name:'LaChona Chardonnay 2022',catId:8,areaId:12,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:67,name:'LaChona Norte y Sur Malbec',catId:8,areaId:12,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0},
        {id:68,name:'LaChona Norte y Sur Cabernet',catId:8,areaId:12,subArea:'',defUnit:'fl oz',archived:0,standalone:1,minQty:0,autoShop:0}
    ],
    inv:[
        {id:1,areaId:1,ingId:1,qty:10,unit:'lb'},
        {id:2,areaId:2,ingId:7,qty:36,unit:'ea'},
        {id:3,areaId:3,subArea:'Left',ingId:3,qty:5,unit:'lb'},
        {id:4,areaId:10,ingId:8,qty:25,unit:'lb'},
        {id:5,areaId:4,ingId:9,qty:3,unit:'lb'}
    ],
    shopping:[
        {id:1,ingId:1,qty:20,unit:'lb',checked:0,savedForLater:0},
        {id:2,ingId:7,qty:48,unit:'ea',checked:0,savedForLater:0}
    ],
    preps:[
        {id:1,name:'Abuela Chona Mix',recId:4,onHand:2,tgt:5,unit:'batch'},
        {id:2,name:'Pollo Mix',recId:5,onHand:1,tgt:3,unit:'batch'},
        {id:3,name:'Dough Discs',recId:3,onHand:40,tgt:100,unit:'ea'},
        {id:10,name:'Golden Cup Batch',recId:201,onHand:0,tgt:1,unit:'batch'},
        {id:11,name:'Que Miras Bobo Batch',recId:202,onHand:0,tgt:1,unit:'batch'},
        {id:12,name:'Argentina Batch',recId:203,onHand:0,tgt:1,unit:'batch'},
        {id:13,name:'BA Old Fashioned Batch',recId:204,onHand:0,tgt:1,unit:'batch'},
        {id:14,name:'Fernet Sour Batch',recId:205,onHand:0,tgt:1,unit:'batch'},
        {id:15,name:'Espresso Martini Batch',recId:206,onHand:0,tgt:1,unit:'batch'},
        {id:16,name:'Lagrima de Amor Batch',recId:207,onHand:0,tgt:1,unit:'batch'},
        {id:17,name:'La Nieta Batch',recId:208,onHand:0,tgt:1,unit:'batch'},
        {id:18,name:'Mendoza Batch',recId:209,onHand:0,tgt:1,unit:'batch'},
        {id:19,name:'Potion de Amor Batch',recId:210,onHand:0,tgt:1,unit:'batch'},
        {id:20,name:'Red Wine Spritzer Batch',recId:211,onHand:0,tgt:1,unit:'batch'},
        {id:21,name:'White Wine Spritzer Batch',recId:212,onHand:0,tgt:1,unit:'batch'},
        {id:22,name:'Bloody Mary Batch',recId:213,onHand:0,tgt:1,unit:'batch'},
        {id:23,name:'Asadors Julep Batch',recId:214,onHand:0,tgt:1,unit:'batch'},
        {id:24,name:'Beso de Frambuesa Batch',recId:215,onHand:0,tgt:1,unit:'batch'},
        {id:25,name:'Mategarita Batch',recId:216,onHand:0,tgt:1,unit:'batch'}
    ],
    recs:[
        {id:1,name:'Beef Filling',group:'Filling',catId:1,yield:95,shelfLife:'3 Days',notes:'Brown beef, add veggies',ings:[{ingId:1,qty:5,unit:'lb'},{ingId:3,qty:1,unit:'lb'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:2,name:'Chicken Filling',group:'Filling',catId:1,yield:90,shelfLife:'3 Days',notes:'Poach chicken, shred',ings:[{ingId:2,qty:4,unit:'lb'},{ingId:3,qty:0.5,unit:'lb'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:3,name:'Dough Discs',group:'Dough',catId:1,yield:98,shelfLife:'2 Days',notes:'Mix flour with water and salt. Roll thin.',ings:[{ingId:8,qty:10,unit:'lb'},{ingId:7,qty:4,unit:'ea'},{ingId:9,qty:0.25,unit:'lb'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:4,name:'Abuela Chona Mix',group:'Mix',catId:1,yield:95,shelfLife:'7 Days',notes:'1 pack ground beef, 1 big sweet onion, 1 big sweet red pepper, 2 cups carrots, 2 cups Prego, 1 cup water, 4 cubes veg broth, 1/4 cup beef bouillon, 1/4 cup chicken bouillon, 3 tbsp paprika, 2 tbsp cumin, 2 tbsp empanada mix, 4 big potatoes, 4 boiled eggs',ings:[{ingId:1,qty:1,unit:'pack'},{ingId:3,qty:1,unit:'ea'},{ingId:4,qty:1,unit:'ea'},{ingId:11,qty:2,unit:'cup'},{ingId:12,qty:2,unit:'cup'},{ingId:29,qty:1,unit:'cup'},{ingId:13,qty:4,unit:'cube'},{ingId:14,qty:0.25,unit:'cup'},{ingId:15,qty:0.25,unit:'cup'},{ingId:16,qty:3,unit:'tbsp'},{ingId:17,qty:2,unit:'tbsp'},{ingId:18,qty:2,unit:'tbsp'},{ingId:5,qty:4,unit:'ea'},{ingId:7,qty:4,unit:'ea'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:5,name:'Pollo Mix',group:'Mix',catId:1,yield:90,shelfLife:'7 Days',notes:'1 chicken package (6 bags), 2 big sweet onions, 2 big sweet red peppers, 4 cups carrots, 2 cups Prego, 4 cubes veg broth, 1/4 cup beef bouillon, 1/4 cup chicken bouillon, 3 tbsp paprika, 2 tbsp cumin, 2 tbsp pizza mix seasoning',ings:[{ingId:19,qty:1,unit:'pack'},{ingId:3,qty:2,unit:'ea'},{ingId:4,qty:2,unit:'ea'},{ingId:11,qty:4,unit:'cup'},{ingId:12,qty:2,unit:'cup'},{ingId:13,qty:4,unit:'cube'},{ingId:14,qty:0.25,unit:'cup'},{ingId:15,qty:0.25,unit:'cup'},{ingId:16,qty:3,unit:'tbsp'},{ingId:17,qty:2,unit:'tbsp'},{ingId:20,qty:2,unit:'tbsp'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:6,name:'Beef Criolla Mix',group:'Mix',catId:1,yield:95,shelfLife:'7 Days',notes:'1 pack ground beef, green olives, 1 big sweet onion, 1 big sweet red pepper, 2 cups carrots, 2 cups Prego, 1 cup water, 4 cubes veg broth, 1/4 cup beef/chicken bouillon, 1 tbsp oregano, 3 tbsp paprika, 1 taco pkg (1/2 hot, 1/2 regular), 1 jar Spanish olives',ings:[{ingId:1,qty:1,unit:'pack'},{ingId:3,qty:1,unit:'ea'},{ingId:4,qty:1,unit:'ea'},{ingId:11,qty:2,unit:'cup'},{ingId:12,qty:2,unit:'cup'},{ingId:29,qty:1,unit:'cup'},{ingId:13,qty:4,unit:'cube'},{ingId:14,qty:0.25,unit:'cup'},{ingId:15,qty:0.25,unit:'cup'},{ingId:23,qty:1,unit:'tbsp'},{ingId:16,qty:3,unit:'tbsp'},{ingId:24,qty:1,unit:'pkg'},{ingId:22,qty:1,unit:'jar'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:7,name:'Espinaca Mix',group:'Mix',catId:1,yield:90,shelfLife:'5 Days',notes:'4 spinach packages, 1 jar parmesan, 1 bar mozzarella, 1 big sweet onion, 1 big sweet red pepper, 2 cups carrots, 1 cup Prego, 4 cubes veg broth, 1/4 cup beef/chicken bouillon, 3 tbsp paprika, 2 tbsp cumin, 2 tbsp pizza mix',ings:[{ingId:25,qty:4,unit:'pkg'},{ingId:26,qty:1,unit:'jar'},{ingId:27,qty:1,unit:'bar'},{ingId:3,qty:1,unit:'ea'},{ingId:4,qty:1,unit:'ea'},{ingId:11,qty:2,unit:'cup'},{ingId:12,qty:1,unit:'cup'},{ingId:13,qty:4,unit:'cube'},{ingId:14,qty:0.25,unit:'cup'},{ingId:15,qty:0.25,unit:'cup'},{ingId:16,qty:3,unit:'tbsp'},{ingId:17,qty:2,unit:'tbsp'},{ingId:20,qty:2,unit:'tbsp'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:8,name:'Imposter Mix',group:'Mix',catId:1,yield:90,shelfLife:'5 Days',notes:'Broccoli: 3 bags cut, 1 jar parmesan, 1 bar mozzarella, 1 big sweet onion, 1 big sweet red pepper, 2 cups carrots, 1 cup Prego, 4 cubes veg broth, 1/4 cup beef/chicken bouillon, 3 tbsp paprika, 2 tbsp cumin, 2 tbsp pizza mix',ings:[{ingId:28,qty:3,unit:'bag'},{ingId:26,qty:1,unit:'jar'},{ingId:27,qty:1,unit:'bar'},{ingId:3,qty:1,unit:'ea'},{ingId:4,qty:1,unit:'ea'},{ingId:11,qty:2,unit:'cup'},{ingId:12,qty:1,unit:'cup'},{ingId:13,qty:4,unit:'cube'},{ingId:14,qty:0.25,unit:'cup'},{ingId:15,qty:0.25,unit:'cup'},{ingId:16,qty:3,unit:'tbsp'},{ingId:17,qty:2,unit:'tbsp'},{ingId:20,qty:2,unit:'tbsp'}],preps:[],subRecs:[],photos:[],videos:[],archived:0},
        {id:101,name:'Golden Cup',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Glass: Special glass. Shake all but tonic w/ ice, add to glass, add tonic, add 2 cubes, top with whip cream and cinnamon stick garnish. Cost: $1.24, Margin: 92.73%',ings:[{ingId:65,qty:3,unit:'fl oz'},{ingId:37,qty:1,unit:'fl oz'},{ingId:58,qty:2,unit:'fl oz'},{ingId:45,qty:0.5,unit:'fl oz'},{ingId:34,qty:0.1,unit:'fl oz'},{ingId:60,qty:1,unit:'oz'},{ingId:61,qty:1,unit:'ea'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:102,name:'Que Miras Bobo',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Glass: Coupe. Cherry garnish, mash w/ 6 cherries and pour through strainer into glass after shaking with ice. Cost: $4.24, Margin: 75.05%',ings:[{ingId:39,qty:2,unit:'fl oz'},{ingId:38,qty:1,unit:'fl oz'},{ingId:33,qty:0.25,unit:'fl oz'},{ingId:51,qty:1,unit:'oz'},{ingId:45,qty:0.5,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:103,name:'Argentina',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Garnish: Orange Peel. Ice: Sphere. Glass: Serrated Whiskey. Cost: $3.15, Margin: 81.45%',ings:[{ingId:30,qty:1,unit:'fl oz'},{ingId:31,qty:1,unit:'fl oz'},{ingId:32,qty:0.25,unit:'fl oz'},{ingId:33,qty:0.25,unit:'fl oz'},{ingId:34,qty:0.2,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:104,name:'Buenos Aires Old Fashioned',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Garnish: Orange wedge. Ice: Square. Glass: Serrated Whiskey. Cost: $4.06, Margin: 76.13%',ings:[{ingId:36,qty:2,unit:'fl oz'},{ingId:31,qty:1,unit:'fl oz'},{ingId:41,qty:1,unit:'fl oz'},{ingId:34,qty:0.1,unit:'fl oz'},{ingId:45,qty:0.5,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:105,name:'Fernet Sour',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Glass: Coupe. Lemon curl garnish. No ice in glass. Shake w/ ice and egg white, pour into glass with nice foam layer. Cost: $4.23, Margin: 75.09%',ings:[{ingId:38,qty:2,unit:'fl oz'},{ingId:7,qty:1,unit:'ea'},{ingId:47,qty:3.5,unit:'oz'},{ingId:34,qty:0.1,unit:'fl oz'},{ingId:45,qty:1,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:106,name:'Espresso Martini',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Glass: Large V-shaped. Shaker for all with ice, pour, garnish with bean. Prep: 3 min. Cost: $1.96, Margin: 88.46%',ings:[{ingId:35,qty:1.5,unit:'fl oz'},{ingId:63,qty:0.5,unit:'oz'},{ingId:43,qty:0.5,unit:'fl oz'},{ingId:45,qty:0.25,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:107,name:'Lagrima de Amor',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Cost: $3.29, Margin: 80.63%',ings:[{ingId:35,qty:2,unit:'fl oz'},{ingId:32,qty:0.5,unit:'fl oz'},{ingId:47,qty:3.5,unit:'oz'},{ingId:45,qty:0.75,unit:'fl oz'},{ingId:49,qty:1.75,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:108,name:'La Nieta',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Glass: Collins tall and skinny. Shake with ice, strain on cube. Cost: $2.62, Margin: 84.62%',ings:[{ingId:66,qty:2,unit:'fl oz'},{ingId:37,qty:1.5,unit:'fl oz'},{ingId:42,qty:0.5,unit:'fl oz'},{ingId:48,qty:1,unit:'ea'},{ingId:45,qty:0.75,unit:'fl oz'},{ingId:34,qty:0.1,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:109,name:'Mendoza',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Cost: $1.08, Margin: 93.65%',ings:[{ingId:67,qty:2,unit:'fl oz'},{ingId:40,qty:2,unit:'fl oz'},{ingId:62,qty:0.5,unit:'fl oz'},{ingId:46,qty:0.25,unit:'fl oz'},{ingId:60,qty:1,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:110,name:'Potion de Amor',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Glass: Large v-shape. Shake in ice, serve with berry garnish. Cost: $3.82, Margin: 77.55%',ings:[{ingId:35,qty:2,unit:'fl oz'},{ingId:32,qty:0.5,unit:'fl oz'},{ingId:44,qty:1,unit:'fl oz'},{ingId:45,qty:0.75,unit:'fl oz'},{ingId:50,qty:2,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:111,name:'Red Wine Spritzer',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Prep: 3 min. Fill with ice, pour wine, then club soda, add slices of orange to inside of glass, top with 2 berries. Cost: $0.93, Margin: 93.81%',ings:[{ingId:67,qty:3,unit:'fl oz'},{ingId:59,qty:0.5,unit:'ea'},{ingId:50,qty:1,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:112,name:'White Wine Spritzer',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Prep: 3 min. Fill with ice, pour wine, then club soda, add slices of lemon to inside of glass, top with mint. Cost: $0.74, Margin: 95.04%',ings:[{ingId:66,qty:3,unit:'fl oz'},{ingId:59,qty:0.5,unit:'ea'},{ingId:47,qty:3,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:113,name:'Bloody Mary',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Prep: 3 min. Cost: $1.43, Margin: 91.61%',ings:[{ingId:35,qty:1.5,unit:'fl oz'},{ingId:52,qty:3,unit:'fl oz'},{ingId:47,qty:1.5,unit:'oz'},{ingId:53,qty:0.5,unit:'fl oz'},{ingId:54,qty:0.5,unit:'fl oz'},{ingId:55,qty:0.1,unit:'oz'},{ingId:56,qty:0.1,unit:'oz'},{ingId:57,qty:1,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:114,name:'Asadors Julep',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Mash berries, shake in ice, strain into coupe, garnish with berry. Cost: $0.72, Margin: 95.74%',ings:[{ingId:64,qty:2,unit:'fl oz'},{ingId:48,qty:0.5,unit:'ea'},{ingId:45,qty:0.5,unit:'fl oz'},{ingId:34,qty:0.1,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:115,name:'Beso de Frambuesa',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Mash berries, shake in ice, strain into coupe, garnish with berry. Cost: $1.24',ings:[{ingId:64,qty:2,unit:'fl oz'},{ingId:44,qty:2,unit:'fl oz'},{ingId:45,qty:0.5,unit:'fl oz'},{ingId:49,qty:0.75,unit:'oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:116,name:'Mategarita',group:'Cocktail',catId:4,yield:98,shelfLife:'N/A',notes:'Prep: 3 min. Glass: Coupe. Sugar rim. Shaker all but wine together in ice, pour (no ice in glass). Float red wine on top. Cost: $2.44',ings:[{ingId:36,qty:1.75,unit:'fl oz'},{ingId:68,qty:0.5,unit:'fl oz'},{ingId:32,qty:0.75,unit:'fl oz'},{ingId:48,qty:0.5,unit:'ea'},{ingId:45,qty:0.75,unit:'fl oz'}],preps:[],subRecs:[],photos:[],videos:[],archived:0,includeInPrep:0},
        {id:201,name:'Golden Cup Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 4.5oz mix, add 2oz tonic, ice, whip cream & cinnamon stick. DO NOT add tonic to batch.',ings:[],preps:[],subRecs:[{recId:101,qty:5}],photos:[],videos:[],archived:0},
        {id:202,name:'Que Miras Bobo Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 3.75oz mix, mash w/ 6 cherries, shake w/ ice, strain into coupe. Add fresh blackberries.',ings:[],preps:[],subRecs:[{recId:102,qty:5}],photos:[],videos:[],archived:0},
        {id:203,name:'Argentina Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'5 Days',notes:'Store in Hallway Fridge. Per serving: pour 2.7oz mix over sphere ice in serrated whiskey glass, garnish orange peel.',ings:[],preps:[],subRecs:[{recId:103,qty:5}],photos:[],videos:[],archived:0},
        {id:204,name:'BA Old Fashioned Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'5 Days',notes:'Store in Hallway Fridge. Per serving: pour 4.6oz mix over square ice in serrated whiskey glass, garnish orange wedge.',ings:[],preps:[],subRecs:[{recId:104,qty:5}],photos:[],videos:[],archived:0},
        {id:205,name:'Fernet Sour Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 6.6oz mix, ADD 1 EGG WHITE fresh, shake hard w/ ice, strain into coupe, lemon curl garnish.',ings:[],preps:[],subRecs:[{recId:105,qty:5}],photos:[],videos:[],archived:0},
        {id:206,name:'Espresso Martini Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'2 Days',notes:'Store in Hallway Fridge. Per serving: pour 2.75oz mix, shake w/ ice, strain into large V glass, garnish w/ bean. Make espresso fresh.',ings:[],preps:[],subRecs:[{recId:106,qty:5}],photos:[],videos:[],archived:0},
        {id:207,name:'Lagrima de Amor Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'2 Days',notes:'Store in Hallway Fridge. Per serving: pour 6.75oz mix, shake w/ ice, strain. Add fresh strawberries per drink.',ings:[],preps:[],subRecs:[{recId:107,qty:5}],photos:[],videos:[],archived:0},
        {id:208,name:'La Nieta Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 4.85oz mix, shake w/ ice, strain over cube in Collins glass. Squeeze fresh lime.',ings:[],preps:[],subRecs:[{recId:108,qty:5}],photos:[],videos:[],archived:0},
        {id:209,name:'Mendoza Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 4.75oz mix, stir, serve. Add fresh cinnamon garnish.',ings:[],preps:[],subRecs:[{recId:109,qty:5}],photos:[],videos:[],archived:0},
        {id:210,name:'Potion de Amor Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'2 Days',notes:'Store in Hallway Fridge. Per serving: pour 4.25oz mix, shake w/ ice, strain into large V glass. Add fresh raspberries.',ings:[],preps:[],subRecs:[{recId:110,qty:5}],photos:[],videos:[],archived:0},
        {id:211,name:'Red Wine Spritzer Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'1 Day',notes:'Store in Hallway Fridge. Per serving: pour 3oz wine over ice, add club soda fresh, orange slices, 2 berries. DO NOT batch soda.',ings:[],preps:[],subRecs:[{recId:111,qty:5}],photos:[],videos:[],archived:0},
        {id:212,name:'White Wine Spritzer Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'1 Day',notes:'Store in Hallway Fridge. Per serving: pour 3oz wine over ice, add club soda fresh, lemon slices, mint. DO NOT batch soda.',ings:[],preps:[],subRecs:[{recId:112,qty:5}],photos:[],videos:[],archived:0},
        {id:213,name:'Bloody Mary Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 6.5oz mix over ice, garnish w/ celery, bacon, olives. Shake before pouring.',ings:[],preps:[],subRecs:[{recId:113,qty:5}],photos:[],videos:[],archived:0},
        {id:214,name:'Asadors Julep Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 3.1oz mix, shake w/ ice, strain into coupe, berry garnish. Squeeze fresh lime.',ings:[],preps:[],subRecs:[{recId:114,qty:5}],photos:[],videos:[],archived:0},
        {id:215,name:'Beso de Frambuesa Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'2 Days',notes:'Store in Hallway Fridge. Per serving: pour 5oz mix, mash w/ berries, shake w/ ice, strain into coupe, berry garnish.',ings:[],preps:[],subRecs:[{recId:115,qty:5}],photos:[],videos:[],archived:0},
        {id:216,name:'Mategarita Batch',group:'Batch Cocktail',catId:4,yield:5,shelfLife:'3 Days',notes:'Store in Hallway Fridge. Per serving: pour 3.25oz mix, shake w/ ice, strain into sugar-rimmed coupe, float 0.5oz red wine. Fresh lime.',ings:[],preps:[],subRecs:[{recId:116,qty:5}],photos:[],videos:[],archived:0}
    ],
    menus:[
        {id:1,name:'Abuela Chona',catId:1,tgt:50,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:2,name:'Criolla',catId:1,tgt:30,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:3,name:'Sweet Beef',catId:1,tgt:20,unitId:1,ings:[],recs:[{recId:1,qty:2,unit:'oz'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:4,name:'Chorizo',catId:1,tgt:25,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:5,name:'Ham & Cheese',catId:1,tgt:30,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:6,name:'Pollo Regular',catId:1,tgt:25,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:7,name:'Pollo Spicy',catId:1,tgt:15,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:8,name:'Espinaca',catId:1,tgt:25,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:9,name:'Humita',catId:1,tgt:20,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:10,name:'Imposter',catId:1,tgt:15,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:11,name:'Ensalada Don Jose',catId:2,tgt:10,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:12,name:'Picadas',catId:3,tgt:5,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:13,name:'Quesos y Frutas',catId:3,tgt:5,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:14,name:'Chimichurri Dip',catId:3,tgt:5,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:15,name:'Papas Rustica',catId:3,tgt:15,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:16,name:'Soup of the Day',catId:4,tgt:10,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:17,name:'Alfajor',catId:5,tgt:20,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:18,name:'Pastelito',catId:5,tgt:10,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:20,name:'Maria Emilia Icon Blend 2020',catId:6,tgt:5,unitId:29,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:21,name:'Gran Reserva Cabernet Franc',catId:6,tgt:5,unitId:29,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:22,name:'Norte y Sur Malbec',catId:6,tgt:8,unitId:29,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:23,name:'Icon Sparkling 2020',catId:7,tgt:8,unitId:29,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:24,name:'Chardonnay 2022',catId:7,tgt:5,unitId:29,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:25,name:'Golden Cup',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:101,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:26,name:'Que Miras Bobo',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:102,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:27,name:'Argentina',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:103,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:28,name:'Buenos Aires Old Fashioned',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:104,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:29,name:'Espresso Martini',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:106,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:34,name:'Fernet Sour',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:105,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:35,name:'Lagrima de Amor',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:107,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:36,name:'La Nieta',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:108,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:37,name:'Mendoza',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:109,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:38,name:'Potion de Amor',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:110,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:39,name:'Red Wine Spritzer',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:111,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:40,name:'White Wine Spritzer',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:112,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:41,name:'Bloody Mary',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:113,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:42,name:'Asadors Julep',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:114,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:43,name:'Beso de Frambuesa',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:115,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:44,name:'Mategarita',catId:8,tgt:0,unitId:1,ings:[],recs:[{recId:116,qty:1,unit:'ea'}],archived:0,includeInShop:1,includeInPrep:0},
        {id:30,name:'Breakfast Empanada',catId:9,tgt:15,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:31,name:'Pancakes',catId:9,tgt:10,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:32,name:'Fresh Fruit',catId:11,tgt:10,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0},
        {id:33,name:'Bacon',catId:11,tgt:10,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0}
    ],
    conversions:[],
    log:[]
};

var tab='inventory',nid=300,exp={},addOpen={},pendingPurchase=null,archiveOpen={ings:0,recs:0,menus:0},adminSectionsOpen={dataManagement:0};
var undoHistory=[];

// Store a copy of default data before it gets overwritten by Supabase
var DEFAULT_DATA = {
    ings: JSON.parse(JSON.stringify(D.ings)),
    recs: JSON.parse(JSON.stringify(D.recs))
};

function getDefaultData(){
    return DEFAULT_DATA;
}

// ==================== UNDO SYSTEM ====================
// Snapshot of last synced state - compare against this
var syncedSnapshot = null;
var initialLoadComplete = false;

function takeSyncSnapshot(){
    console.log('takeSyncSnapshot called');
    try {
        syncedSnapshot = {
            inv: JSON.stringify(D.inv),
            shopping: JSON.stringify(D.shopping),
            preps: JSON.stringify(D.preps),
            ings: JSON.stringify(D.ings),
            recs: JSON.stringify(D.recs),
            menus: JSON.stringify(D.menus),
            areas: JSON.stringify(D.areas),
            cats: JSON.stringify(D.cats),
            menuCats: JSON.stringify(D.menuCats),
            recCats: JSON.stringify(D.recCats || []),
            units: JSON.stringify(D.units),
            autoAddToInv: D.autoAddToInv
        };
        initialLoadComplete = true;
        // Update nid to be higher than any existing ID
        updateNextId();
        console.log('takeSyncSnapshot complete, initialLoadComplete:', initialLoadComplete, 'nid:', nid);
    } catch(e) {
        console.error('takeSyncSnapshot error:', e);
    }
}

function updateNextId(){
    // Find the maximum ID across all data arrays to avoid collisions
    var maxId = nid;
    [D.ings, D.recs, D.menus, D.inv, D.shopping, D.preps, D.areas, D.cats, D.menuCats, D.recCats, D.units].forEach(function(arr){
        if(arr && arr.length){
            arr.forEach(function(item){
                if(item && item.id && item.id >= maxId) maxId = item.id + 1;
            });
        }
    });
    nid = maxId;
    console.log('Updated nid to:', nid);
}

function saveState(actionName){
    // Deep copy the data that can be changed
    var state={
        action:actionName,
        inv:JSON.parse(JSON.stringify(D.inv)),
        shopping:JSON.parse(JSON.stringify(D.shopping)),
        preps:JSON.parse(JSON.stringify(D.preps)),
        ings:JSON.parse(JSON.stringify(D.ings)),
        recs:JSON.parse(JSON.stringify(D.recs)),
        menus:JSON.parse(JSON.stringify(D.menus)),
        log:JSON.parse(JSON.stringify(D.log))
    };
    
    undoHistory.push(state);
    // Keep only last 5 states
    if(undoHistory.length>5)undoHistory.shift();
    updateUndoButton();
    
    // Mark that we have unsaved changes
    showSyncStatus('unsaved');
}

function detectAllChanges(){
    // Compare current data against last synced snapshot
    if(!syncedSnapshot) return;
    
    clearChangeLog();
    
    detectTableChanges('inv', JSON.parse(syncedSnapshot.inv), D.inv);
    detectTableChanges('shopping', JSON.parse(syncedSnapshot.shopping), D.shopping);
    detectTableChanges('preps', JSON.parse(syncedSnapshot.preps), D.preps);
    detectTableChanges('ings', JSON.parse(syncedSnapshot.ings), D.ings);
    detectTableChanges('recs', JSON.parse(syncedSnapshot.recs), D.recs);
    detectTableChanges('menus', JSON.parse(syncedSnapshot.menus), D.menus);
    detectTableChanges('areas', JSON.parse(syncedSnapshot.areas), D.areas);
    detectTableChanges('cats', JSON.parse(syncedSnapshot.cats), D.cats);
    detectTableChanges('menuCats', JSON.parse(syncedSnapshot.menuCats), D.menuCats);
    detectTableChanges('recCats', JSON.parse(syncedSnapshot.recCats || '[]'), D.recCats || []);
    detectTableChanges('units', JSON.parse(syncedSnapshot.units), D.units);
    
    // Check settings
    if(syncedSnapshot.autoAddToInv !== D.autoAddToInv){
        changeLog.settings = true;
    }
}

function detectTableChanges(table, syncedArray, currArray){
    // Build maps for quick lookup
    var syncedMap = {};
    syncedArray.forEach(function(item){ syncedMap[item.id] = JSON.stringify(item); });
    
    var currMap = {};
    currArray.forEach(function(item){ currMap[item.id] = JSON.stringify(item); });
    
    // Find added or modified items
    currArray.forEach(function(item){
        if(!syncedMap[item.id] || syncedMap[item.id] !== currMap[item.id]){
            markChanged(table, item.id);
        }
    });
    
    // Find deleted items
    syncedArray.forEach(function(item){
        if(!currMap[item.id]){
            markDeleted(table, item.id);
        }
    });
}

function undoAction(){
    if(undoHistory.length===0)return;
    var state=undoHistory.pop();
    D.inv=state.inv;
    D.shopping=state.shopping;
    D.preps=state.preps;
    D.ings=state.ings;
    D.recs=state.recs;
    D.menus=state.menus;
    D.log=state.log;
    updateUndoButton();
    render();
}

function updateUndoButton(){
    var btn=document.getElementById('undo-btn');
    if(btn){
        btn.disabled=undoHistory.length===0;
        btn.title=undoHistory.length>0?'Undo: '+undoHistory[undoHistory.length-1].action+' ('+undoHistory.length+')':'Nothing to undo';
        btn.style.opacity=undoHistory.length>0?'1':'0.4';
    }
}

// ==================== RECIPE OUTPUT CALCULATION ====================
// Unit conversion factors to base units (oz for weight, fl oz for volume)
var unitConversions = {
    // Weight units ‚Üí oz
    'oz': {type:'weight', toBase:1},
    'lb': {type:'weight', toBase:16},
    'g': {type:'weight', toBase:0.035274},
    'kg': {type:'weight', toBase:35.274},
    // Volume units ‚Üí fl oz
    'fl oz': {type:'volume', toBase:1},
    'ml': {type:'volume', toBase:0.033814},
    'L': {type:'volume', toBase:33.814},
    'cup': {type:'volume', toBase:8},
    'tbsp': {type:'volume', toBase:0.5},
    'tsp': {type:'volume', toBase:0.1667},
    'gal': {type:'volume', toBase:128},
    // Count units ‚Üí ea
    'ea': {type:'count', toBase:1},
    'doz': {type:'count', toBase:12},
    '1/2 doz': {type:'count', toBase:6},
    'case': {type:'count', toBase:1},
    'batch': {type:'count', toBase:1},
    'btl': {type:'count', toBase:1},
    'shells': {type:'count', toBase:1}
};

function calcRecipeOutput(rec){
    if(!rec) return {qty:0, unit:'', type:''};

    // If manual mode, return manual values
    if(rec.outputMode === 'manual' && rec.manualQty > 0){
        return {qty: rec.manualQty, unit: rec.yieldUnit || 'ea', type: 'manual'};
    }

    // Otherwise calculate from ingredients
    if(!rec.ings || !rec.ings.length) return {qty:0, unit:'', type:''};

    // Sum quantities by type
    var totals = {weight:0, volume:0, count:0};
    var unitCounts = {weight:{}, volume:{}, count:{}};

    rec.ings.forEach(function(ri){
        var conv = unitConversions[ri.unit];
        if(conv){
            totals[conv.type] += (ri.qty || 0) * conv.toBase;
            unitCounts[conv.type][ri.unit] = (unitCounts[conv.type][ri.unit] || 0) + 1;
        } else {
            // Unknown unit, treat as count
            totals.count += (ri.qty || 0);
            unitCounts.count[ri.unit] = (unitCounts.count[ri.unit] || 0) + 1;
        }
    });

    // Determine primary type (highest total converted value)
    var primaryType = 'count';
    var primaryTotal = 0;

    if(totals.weight > 0){
        primaryType = 'weight';
        primaryTotal = totals.weight;
    }
    if(totals.volume > totals.weight){
        primaryType = 'volume';
        primaryTotal = totals.volume;
    }
    if(totals.count > 0 && totals.weight === 0 && totals.volume === 0){
        primaryType = 'count';
        primaryTotal = totals.count;
    }

    // Apply yield percentage
    var yieldPct = (rec.yield || 98) / 100;
    var outputQty = primaryTotal * yieldPct;

    // Determine output unit
    var outputUnit = primaryType === 'weight' ? 'oz' : (primaryType === 'volume' ? 'fl oz' : 'ea');

    // Use stored yieldUnit if set
    if(rec.yieldUnit){
        outputUnit = rec.yieldUnit;
    }

    // Format nicely
    if(outputQty >= 1){
        outputQty = Math.round(outputQty * 100) / 100;
    } else {
        outputQty = Math.round(outputQty * 1000) / 1000;
    }

    return {qty: outputQty, unit: outputUnit, type: primaryType};
}

function getRecipeOutputDisplay(rec){
    // If manual mode, use manualQty
    if(rec.outputMode === 'manual' && rec.manualQty > 0){
        var unit = rec.yieldUnit || 'ea';
        return rec.manualQty + ' ' + unit;
    }
    // Otherwise use calculated output
    var output = calcRecipeOutput(rec);
    if(output.qty === 0) return 'No ingredients';
    return output.qty + ' ' + (rec.yieldUnit || output.unit);
}

// ==================== DATA MIGRATION ====================
function migrateMenuData(){
    var migrated = false;
    D.menus.forEach(function(menu){
        // Migrate recIds to recs format
        if(menu.recIds && menu.recIds.length){
            if(!menu.recs) menu.recs = [];
            menu.recIds.forEach(function(rid){
                var rec = D.recs.find(function(r){return r.id === rid;});
                var output = rec ? calcRecipeOutput(rec) : {qty:1, unit:'ea'};
                // Default to 1 ea (one serving of recipe)
                menu.recs.push({
                    recId: rid,
                    qty: 1,
                    unit: rec && rec.yieldUnit ? rec.yieldUnit : output.unit
                });
            });
            menu.recIds = []; // Clear old format
            migrated = true;
        }
        // Ensure prep items have units
        if(menu.preps && menu.preps.length){
            menu.preps.forEach(function(mp){
                if(!mp.unit){
                    var prep = D.preps.find(function(p){return p.id === mp.prepId;});
                    mp.unit = prep ? prep.unit : 'ea';
                    migrated = true;
                }
            });
        }
        // Ensure recs array exists
        if(!menu.recs) menu.recs = [];
    });
    if(migrated){
        console.log('Menu data migrated to new format');
    }
}

// ==================== LOG FUNCTIONS ====================
function logInventoryChange(item,oldQty,oldUnit,newQty,newUnit){
    var now=new Date();
    var logEntry={
        id:nid++,
        user:D.currentUser.name,
        item:item,
        oldQty:oldQty,
        oldUnit:oldUnit,
        newQty:newQty,
        newUnit:newUnit,
        timestamp:now.toISOString(),
        date:now.toLocaleDateString(),
        time:now.toLocaleTimeString()
    };
    D.log.unshift(logEntry);
    // Mark log change for sync
    if(typeof changeLog !== 'undefined' && changeLog.log){
        changeLog.log.add(logEntry.id);
    }
    // Keep only last 4 weeks
    var fourWeeksAgo=new Date();
    fourWeeksAgo.setDate(fourWeeksAgo.getDate()-28);
    D.log=D.log.filter(function(l){return new Date(l.timestamp)>=fourWeeksAgo;});
}

// ==================== NAVIGATION ====================
function go(t){
    tab=t;
    document.querySelectorAll('.tab').forEach(function(el){el.classList.remove('active');});
    document.querySelector('.tab[data-t="'+t+'"]').classList.add('active');
    document.getElementById('fab').style.display=(t==='admin'||t==='log')?'none':'block';
    render();
}

function render(){
    document.documentElement.style.setProperty('--font-scale',D.fontScale);
    // Sync font slider
    var slider=document.getElementById('font-slider');
    var val=document.getElementById('font-scale-val');
    if(slider)slider.value=D.fontScale;
    if(val)val.textContent=(D.fontScale*100).toFixed(0)+'%';
    
    var c=document.getElementById('content'),h=document.getElementById('hdr-t'),s=document.getElementById('hdr-s');
    var titles={inventory:'üì¶ Inventory',shopping:'üõí Shopping List',prep:'üë®‚Äçüç≥ Prep Status',ingredients:'ü•¨ Ingredients',recipes:'üìñ Recipes',menu:'üçΩÔ∏è Menu',log:'üìã Activity Log',admin:'‚öôÔ∏è Admin'};
    h.textContent=titles[tab];
    if(tab==='inventory')renderInv(c,s);
    else if(tab==='shopping')renderShop(c,s);
    else if(tab==='prep')renderPrep(c,s);
    else if(tab==='ingredients')renderIngs(c,s);
    else if(tab==='recipes')renderRecs(c,s);
    else if(tab==='menu')renderMenu(c,s);
    else if(tab==='log')renderLog(c,s);
    else if(tab==='admin')renderAdmin(c,s);
}

// ==================== HELPER FUNCTIONS ====================
function getAreaName(areaId,subArea){
    var a=D.areas.find(function(x){return x.id===areaId;});
    if(!a)return 'Unknown';
    return subArea?a.name+' ('+subArea+')':a.name;
}

function getIngName(id){var i=D.ings.find(function(x){return x.id===id;});return i?i.name:'Unknown';}
function getRecName(id){var r=D.recs.find(function(x){return x.id===id;});return r?r.name:'Unknown';}
function getPrepName(id){var p=D.preps.find(function(x){return x.id===id;});return p?p.name:'Unknown';}
function getMenuName(id){var m=D.menus.find(function(x){return x.id===id;});return m?m.name:'Unknown';}
function getCatName(id){var c=D.cats.find(function(x){return x.id===id;});return c?c.name:'';}

// Get sorted units for dropdown display (alphabetically by abbreviation)
function getSortedUnits(){
    return D.units.slice().sort(function(a,b){
        return a.abbr.toLowerCase().localeCompare(b.abbr.toLowerCase());
    });
}

// Render a single inventory item with conversion info
function renderInvItem(inv){
    var itemName='',isPrep=false,conv=null,ing=null;
    if(inv.ingId){
        ing=D.ings.find(function(x){return x.id===inv.ingId;});
        itemName=ing?ing.name:'Unknown';
        // Check for conversion
        if(D.conversions){
            conv=D.conversions.find(function(c){return c.ingId===inv.ingId;});
        }
    }else if(inv.recId){
        var rec=D.recs.find(function(r){return r.id===inv.recId;});
        itemName=rec?'üç≥ '+rec.name:'Unknown Prep';
        isPrep=true;
    }else if(inv.menuId){
        var menu=D.menus.find(function(m){return m.id===inv.menuId;});
        itemName=menu?'üçΩÔ∏è '+menu.name:'Unknown Menu';
        isPrep=true;
    }
    if(!itemName)return '';

    var html='<div class="inv-item'+(isPrep?' prep-item':'')+'" style="flex-wrap:wrap">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;width:100%">';
    html+='<span class="inv-item-name" onclick="editInvItem('+inv.id+')" style="cursor:pointer">'+itemName+'</span>';
    html+='<div class="inv-item-controls">';
    html+='<input type="number" value="'+inv.qty+'" onchange="updInv('+inv.id+',this.value)" onclick="event.stopPropagation()" style="width:50px;padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;text-align:center;font-size:calc(12px * var(--font-scale))">';
    html+='<select onchange="updInvUnit('+inv.id+',this.value)" onclick="event.stopPropagation()" style="padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;font-size:calc(10px * var(--font-scale))">';

    // If ingredient has conversion, show storage unit as the main option
    if(conv){
        // Add storage unit if not in standard units
        var storageInList=D.units.some(function(u){return u.abbr===conv.storageUnit;});
        if(!storageInList){
            html+='<option value="'+conv.storageUnit+'"'+(inv.unit===conv.storageUnit?' selected':'')+'>'+conv.storageUnit+'</option>';
        }
    }
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'"'+(inv.unit===u.abbr?' selected':'')+'>'+u.abbr+'</option>';});
    html+='</select>';
    html+='<button class="del-btn" onclick="event.stopPropagation();delInv('+inv.id+')">üóëÔ∏è</button>';
    html+='</div></div>';

    // Show conversion info if available
    if(conv){
        var recipeQty=inv.qty*conv.factor;
        html+='<div style="width:100%;padding:4px 0 0 0;font-size:calc(9px * var(--font-scale));color:#6c5ce7;display:flex;justify-content:space-between;align-items:center">';
        html+='<span>üìê 1 '+conv.storageUnit+' = '+conv.factor+' '+conv.recipeUnit+' ('+formatQty(recipeQty)+' '+conv.recipeUnit+' total)</span>';
        html+='<button onclick="event.stopPropagation();editConversion('+conv.id+')" style="background:none;border:none;color:#6c5ce7;cursor:pointer;font-size:calc(10px * var(--font-scale));padding:2px 4px">‚úèÔ∏è</button>';
        html+='</div>';
    }else if(inv.ingId && !isPrep){
        // No conversion - show option to add one
        html+='<div style="width:100%;padding:4px 0 0 0;font-size:calc(9px * var(--font-scale));color:#636e72">';
        html+='<button onclick="event.stopPropagation();addConversionForIng('+inv.ingId+')" style="background:none;border:none;color:#636e72;cursor:pointer;font-size:calc(9px * var(--font-scale));padding:0;text-decoration:underline">+ Add storage‚Üírecipe conversion</button>';
        html+='</div>';
    }

    html+='</div>';
    return html;
}

function getStatusColor(oh,tgt){var d=oh-tgt;return d>=0?'green':d>-3?'yellow':'red';}
function getStatusTxt(oh,tgt){var d=oh-tgt;return d>=0?'STOCKED':d>-3?'LOW':'CRITICAL';}

// Unit conversion helpers
function getConversionForIng(ingId){
    return D.conversions.find(function(c){return c.ingId===ingId;});
}
function getConversionForUnit(unit){
    return D.conversions.find(function(c){return c.recipeUnit===unit;});
}
function convertToStorage(qty,ingId){
    var conv=getConversionForIng(ingId);
    if(!conv||!conv.factor)return null;
    return{qty:Math.ceil(qty/conv.factor),unit:conv.storageUnit};
}
function convertToRecipe(qty,ingId){
    var conv=getConversionForIng(ingId);
    if(!conv||!conv.factor)return null;
    return{qty:qty*conv.factor,unit:conv.recipeUnit};
}

// ==================== INVENTORY ====================
function renderInv(c,s){
    var total=D.inv.length;
    s.textContent=total+' items';
    var html='';
    
    D.areas.forEach(function(area){
        var areaItems=D.inv.filter(function(i){return i.areaId===area.id&&(!area.sections.length||!i.subArea);});
        var subItems={};
        if(area.sections.length){
            area.sections.forEach(function(sec){
                subItems[sec]=D.inv.filter(function(i){return i.areaId===area.id&&i.subArea===sec;});
            });
        }
        var totalInArea=areaItems.length;
        area.sections.forEach(function(sec){totalInArea+=subItems[sec]?subItems[sec].length:0;});
        
        var isExp=exp['area-'+area.id];
        html+='<div class="card"><div class="card-h" onclick="tog(\'area-'+area.id+'\')" style="cursor:pointer"><div><div class="card-t">'+area.name+'</div><div class="card-s">üìç Storage</div></div><span class="card-cnt">'+totalInArea+' '+(isExp?'‚ñ≤':'‚ñº')+'</span></div>';
        
        if(isExp){
            html+='<div style="margin-top:12px">';
            // Main area items
            areaItems.forEach(function(inv){
                html+=renderInvItem(inv);
            });
            // Sub-areas
            if(area.sections.length){
                area.sections.forEach(function(sec){
                    html+='<div class="section-label">'+sec+'</div><div class="sub-area">';
                    if(subItems[sec]&&subItems[sec].length){
                        subItems[sec].forEach(function(inv){
                            html+=renderInvItem(inv);
                        });
                    }else{
                        html+='<div style="color:#636e72;font-size:calc(11px * var(--font-scale));padding:8px">No items</div>';
                    }
                    html+='</div>';
                });
            }
            // Add form toggle
            html+='<div class="add-toggle" onclick="togAdd(\'area-'+area.id+'\')"><span class="add-toggle-t">+ Add Item</span></div>';
            html+='<div class="add-form'+(addOpen['area-'+area.id]?' open':'')+'">';
            // Combined search/select using datalist for better UX
            html+='<div style="position:relative"><input type="text" id="inv-search-'+area.id+'" class="form-i" placeholder="üîç Search items..." style="margin-bottom:8px" oninput="filterInvItems('+area.id+',this.value)" autocomplete="off">';
            html+='<div id="inv-dropdown-'+area.id+'" class="inv-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:250px;overflow-y:auto;background:#2d2d4a;border:1px solid rgba(255,255,255,.2);border-radius:8px;z-index:100;margin-top:-4px">';
            html+=buildInvDropdownItems(area.id,'');
            html+='</div></div>';
            html+='<input type="hidden" id="sel-'+area.id+'" value="">';
            if(area.sections.length){
                html+='<select id="sub-'+area.id+'" class="form-i" style="margin-bottom:8px"><option value="">Main Area</option>';
                area.sections.forEach(function(sec){html+='<option value="'+sec+'">'+sec+'</option>';});
                html+='</select>';
            }
            html+='<div style="display:flex;gap:8px"><input type="number" id="qty-'+area.id+'" class="form-i" placeholder="Qty" style="flex:1"><select id="unit-'+area.id+'" class="form-i" style="flex:1">';
            getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
            html+='</select></div>';
            // Unit conversion section (shown when ingredient selected)
            html+='<div id="conv-'+area.id+'" style="display:none;margin-top:8px;padding:10px;background:rgba(108,92,231,0.1);border-radius:6px;border-left:3px solid #6c5ce7">';
            html+='<div style="font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-bottom:6px">üìê Storage ‚Üí Recipe Unit Conversion</div>';
            html+='<div style="font-size:calc(9px * var(--font-scale));color:#636e72;margin-bottom:8px;font-style:italic">*Recipe units = Total listed per item on pkg</div>';
            // Dropdown of existing conversions grouped by category
            html+='<select id="conv-select-'+area.id+'" class="form-i" style="margin-bottom:8px;font-size:calc(11px * var(--font-scale))" onchange="onConvSelect('+area.id+')">';
            html+='<option value="same">Storage = Recipe Units</option>';
            // Group conversions by ingredient category
            if(D.conversions && D.conversions.length){
                D.cats.forEach(function(cat){
                    var catConvs=D.conversions.filter(function(conv){
                        var ing=D.ings.find(function(i){return i.id===conv.ingId;});
                        return ing && ing.catId===cat.id;
                    });
                    if(catConvs.length){
                        html+='<optgroup label="'+cat.name+'">';
                        catConvs.forEach(function(conv){
                            var ing=D.ings.find(function(i){return i.id===conv.ingId;});
                            var ingName=ing?ing.name:'Unknown';
                            html+='<option value="'+conv.id+'">'+ingName+': 1 '+conv.storageUnit+' = '+conv.factor+' '+conv.recipeUnit+'</option>';
                        });
                        html+='</optgroup>';
                    }
                });
                // Uncategorized
                var uncatConvs=D.conversions.filter(function(conv){
                    var ing=D.ings.find(function(i){return i.id===conv.ingId;});
                    return ing && !ing.catId;
                });
                if(uncatConvs.length){
                    html+='<optgroup label="Other">';
                    uncatConvs.forEach(function(conv){
                        var ing=D.ings.find(function(i){return i.id===conv.ingId;});
                        var ingName=ing?ing.name:'Unknown';
                        html+='<option value="'+conv.id+'">'+ingName+': 1 '+conv.storageUnit+' = '+conv.factor+' '+conv.recipeUnit+'</option>';
                    });
                    html+='</optgroup>';
                }
            }
            html+='<option value="new">‚ûï Create New Conversion</option>';
            html+='</select>';
            // Create new conversion fields (hidden by default)
            html+='<div id="conv-new-'+area.id+'" style="display:none">';
            html+='<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px">';
            html+='<span style="font-size:calc(11px * var(--font-scale));color:#a0aec0">Storage:</span>';
            html+='<input type="number" id="stor-qty-'+area.id+'" class="form-i" value="1" style="width:40px;font-size:calc(11px * var(--font-scale))">';
            html+='<input type="text" id="stor-unit-'+area.id+'" class="form-i" placeholder="bottle" style="width:70px;font-size:calc(11px * var(--font-scale))">';
            html+='</div>';
            html+='<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">';
            html+='<span style="font-size:calc(11px * var(--font-scale));color:#a0aec0">Recipe:</span>';
            html+='<input type="number" id="rec-qty-'+area.id+'" class="form-i" placeholder="25" style="width:50px;font-size:calc(11px * var(--font-scale))">';
            html+='<select id="rec-unit-'+area.id+'" class="form-i" style="width:70px;font-size:calc(11px * var(--font-scale))">';
            getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
            html+='</select>';
            html+='</div>';
            html+='</div></div>';
            html+='<button class="btn btn-p" onclick="addToArea('+area.id+')" style="width:100%;margin-top:8px">Add</button>';
            html+='</div>';
            html+='</div>';
        }
        html+='</div>';
    });
    c.innerHTML=html;
}

function addToArea(areaId){
    var selVal=document.getElementById('sel-'+areaId).value;
    var qty=+document.getElementById('qty-'+areaId).value;
    var unit=document.getElementById('unit-'+areaId).value;
    var area=D.areas.find(function(a){return a.id===areaId;});
    var subArea='';
    if(area&&area.sections.length){
        var subEl=document.getElementById('sub-'+areaId);
        if(subEl)subArea=subEl.value;
    }
    if(!selVal||!qty){alert('Select item and enter quantity');return;}

    // Parse selection - could be "ing-123", "rec-456", or "menu-789"
    var parts=selVal.split('-');
    var itemType=parts[0];
    var itemId=+parts[1];
    var invItem={id:nid++,areaId:areaId,subArea:subArea,ingId:0,recId:0,menuId:0,qty:qty,unit:unit};
    var itemName='';

    if(itemType==='ing'){
        invItem.ingId=itemId;
        itemName=getIngName(itemId);

        // Check for unit conversion
        var existingConv=D.conversions?D.conversions.find(function(c){return c.ingId===itemId;}):null;
        if(!existingConv){
            var convSelect=document.getElementById('conv-select-'+areaId);
            var convVal=convSelect?convSelect.value:'';

            if(convVal==='same'){
                // Storage = Recipe Units (1:1 conversion)
                if(!D.conversions)D.conversions=[];
                var maxConvId=D.conversions.length?Math.max.apply(null,D.conversions.map(function(c){return c.id;})):0;
                D.conversions.push({
                    id:maxConvId+1,
                    ingId:itemId,
                    storageUnit:unit,
                    factor:1,
                    recipeUnit:unit
                });
            }else if(convVal==='new'){
                // Create new conversion from form fields
                var storQty=document.getElementById('stor-qty-'+areaId);
                var storUnit=document.getElementById('stor-unit-'+areaId);
                var recQty=document.getElementById('rec-qty-'+areaId);
                var recUnit=document.getElementById('rec-unit-'+areaId);

                if(storUnit&&storUnit.value&&recQty&&recQty.value){
                    if(!D.conversions)D.conversions=[];
                    var maxConvId=D.conversions.length?Math.max.apply(null,D.conversions.map(function(c){return c.id;})):0;
                    var storQtyVal=storQty?+storQty.value||1:1;
                    var factor=(+recQty.value)/storQtyVal;
                    D.conversions.push({
                        id:maxConvId+1,
                        ingId:itemId,
                        storageUnit:storUnit.value,
                        factor:factor,
                        recipeUnit:recUnit.value
                    });
                    // Use storage unit for inventory
                    invItem.unit=storUnit.value;
                }
            }else if(convVal){
                // Using existing conversion as template - copy it for this ingredient
                var templateConv=D.conversions.find(function(c){return c.id===+convVal;});
                if(templateConv){
                    var maxConvId=D.conversions.length?Math.max.apply(null,D.conversions.map(function(c){return c.id;})):0;
                    D.conversions.push({
                        id:maxConvId+1,
                        ingId:itemId,
                        storageUnit:templateConv.storageUnit,
                        factor:templateConv.factor,
                        recipeUnit:templateConv.recipeUnit
                    });
                    invItem.unit=templateConv.storageUnit;
                }
            }
        }
    }else if(itemType==='rec'){
        invItem.recId=itemId;
        var rec=D.recs.find(function(r){return r.id===itemId;});
        itemName=rec?rec.name:'Recipe';
    }else if(itemType==='menu'){
        invItem.menuId=itemId;
        var menu=D.menus.find(function(m){return m.id===itemId;});
        itemName=menu?menu.name:'Menu Item';
    }

    saveState('Add to '+getAreaName(areaId,subArea));
    D.inv.push(invItem);
    logInventoryChange(itemName,0,unit,qty,unit);
    addOpen['area-'+areaId]=false;
    render();
}

// Build dropdown items for inventory search
function buildInvDropdownItems(areaId, searchTerm){
    var searchLower=(searchTerm||'').toLowerCase();
    var html='';

    // Ingredients section
    var hasIngredients=false;
    D.cats.forEach(function(cat){
        var catIngs=D.ings.filter(function(i){
            return !i.archived && i.catId===cat.id &&
                   (!searchTerm || i.name.toLowerCase().indexOf(searchLower)!==-1);
        });
        if(catIngs.length){
            if(!hasIngredients){
                html+='<div style="padding:6px 10px;color:#a29bfe;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3)">‚îÄ‚îÄ INGREDIENTS ‚îÄ‚îÄ</div>';
                hasIngredients=true;
            }
            html+='<div style="padding:4px 10px;color:#636e72;font-size:calc(9px * var(--font-scale));font-weight:600">'+cat.name+'</div>';
            catIngs.forEach(function(ing){
                var conv=D.conversions?D.conversions.find(function(c){return c.ingId===ing.id;}):null;
                var convInfo=conv?' <span style="color:#6c5ce7;font-size:calc(9px * var(--font-scale))">('+conv.storageUnit+'‚Üí'+conv.recipeUnit+')</span>':'';
                html+='<div class="inv-dropdown-item" data-value="ing-'+ing.id+'" onclick="selectInvItem('+areaId+',\'ing-'+ing.id+'\',\''+ing.name.replace(/'/g,"\\'")+'\')">'+ing.name+convInfo+'</div>';
            });
        }
    });
    // Uncategorized ingredients
    var uncatIngs=D.ings.filter(function(i){
        return !i.archived && !i.catId &&
               (!searchTerm || i.name.toLowerCase().indexOf(searchLower)!==-1);
    });
    if(uncatIngs.length){
        if(!hasIngredients){
            html+='<div style="padding:6px 10px;color:#a29bfe;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3)">‚îÄ‚îÄ INGREDIENTS ‚îÄ‚îÄ</div>';
        }
        html+='<div style="padding:4px 10px;color:#636e72;font-size:calc(9px * var(--font-scale));font-weight:600">Other</div>';
        uncatIngs.forEach(function(ing){
            var conv=D.conversions?D.conversions.find(function(c){return c.ingId===ing.id;}):null;
            var convInfo=conv?' <span style="color:#6c5ce7;font-size:calc(9px * var(--font-scale))">('+conv.storageUnit+'‚Üí'+conv.recipeUnit+')</span>':'';
            html+='<div class="inv-dropdown-item" data-value="ing-'+ing.id+'" onclick="selectInvItem('+areaId+',\'ing-'+ing.id+'\',\''+ing.name.replace(/'/g,"\\'")+'\')">'+ing.name+convInfo+'</div>';
        });
    }

    // Prep items (recipes used in menus)
    var usedRecIds=[];
    D.menus.filter(function(m){return !m.archived;}).forEach(function(m){
        if(m.recs&&m.recs.length){
            m.recs.forEach(function(mr){if(usedRecIds.indexOf(mr.recId)===-1)usedRecIds.push(mr.recId);});
        }
    });
    var filteredRecs=usedRecIds.filter(function(recId){
        var rec=D.recs.find(function(r){return r.id===recId;});
        return rec && (!searchTerm || rec.name.toLowerCase().indexOf(searchLower)!==-1);
    });
    if(filteredRecs.length){
        html+='<div style="padding:6px 10px;color:#fd79a8;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3);margin-top:4px">‚îÄ‚îÄ PREP ITEMS (Recipes) ‚îÄ‚îÄ</div>';
        filteredRecs.forEach(function(recId){
            var rec=D.recs.find(function(r){return r.id===recId;});
            if(rec)html+='<div class="inv-dropdown-item" data-value="rec-'+rec.id+'" onclick="selectInvItem('+areaId+',\'rec-'+rec.id+'\',\'üç≥ '+rec.name.replace(/'/g,"\\'")+'\')">üç≥ '+rec.name+'</div>';
        });
    }

    // Menu items marked as Prep
    var prepMenus=D.menus.filter(function(m){
        return !m.archived && m.includeInPrep &&
               (!searchTerm || m.name.toLowerCase().indexOf(searchLower)!==-1);
    });
    if(prepMenus.length){
        html+='<div style="padding:6px 10px;color:#74b9ff;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3);margin-top:4px">‚îÄ‚îÄ PREP ITEMS (Menu) ‚îÄ‚îÄ</div>';
        prepMenus.forEach(function(menu){
            html+='<div class="inv-dropdown-item" data-value="menu-'+menu.id+'" onclick="selectInvItem('+areaId+',\'menu-'+menu.id+'\',\'üçΩÔ∏è '+menu.name.replace(/'/g,"\\'")+'\')">üçΩÔ∏è '+menu.name+'</div>';
        });
    }

    if(!html){
        html='<div style="padding:12px;color:#636e72;text-align:center;font-size:calc(11px * var(--font-scale))">No items found</div>';
    }
    return html;
}

function showInvDropdown(areaId){
    var dropdown=document.getElementById('inv-dropdown-'+areaId);
    if(dropdown)dropdown.style.display='block';
}

function hideInvDropdown(areaId){
    setTimeout(function(){
        var dropdown=document.getElementById('inv-dropdown-'+areaId);
        if(dropdown)dropdown.style.display='none';
    },200);
}

function filterInvItems(areaId, searchTerm){
    var dropdown=document.getElementById('inv-dropdown-'+areaId);
    if(dropdown){
        if(searchTerm && searchTerm.trim()){
            dropdown.innerHTML=buildInvDropdownItems(areaId, searchTerm);
            dropdown.style.display='block';
        } else {
            dropdown.style.display='none';
        }
    }
}

function selectInvItem(areaId, value, displayName){
    var searchInput=document.getElementById('inv-search-'+areaId);
    var hiddenInput=document.getElementById('sel-'+areaId);
    var dropdown=document.getElementById('inv-dropdown-'+areaId);

    if(searchInput)searchInput.value=displayName.replace(/üç≥ |üçΩÔ∏è /g,'');
    if(hiddenInput)hiddenInput.value=value;
    if(dropdown)dropdown.style.display='none';

    // Trigger the item select handler
    onInvItemSelect(areaId);
}

function onInvItemSelect(areaId){
    var selVal=document.getElementById('sel-'+areaId).value;
    var convDiv=document.getElementById('conv-'+areaId);
    var convNewDiv=document.getElementById('conv-new-'+areaId);
    var convSelect=document.getElementById('conv-select-'+areaId);

    if(!selVal){
        if(convDiv)convDiv.style.display='none';
        return;
    }
    var parts=selVal.split('-');
    var itemType=parts[0];
    var itemId=+parts[1];
    var unitSel=document.getElementById('unit-'+areaId);

    if(itemType==='ing'){
        var ing=D.ings.find(function(i){return i.id===itemId;});
        // Check if conversion exists for this ingredient
        var existingConv=D.conversions?D.conversions.find(function(c){return c.ingId===itemId;}):null;

        if(existingConv){
            // Has conversion - hide the conversion section entirely, use storage unit
            if(convDiv)convDiv.style.display='none';
            // Set unit dropdown to storage unit
            for(var i=0;i<unitSel.options.length;i++){
                if(unitSel.options[i].value===existingConv.storageUnit){unitSel.selectedIndex=i;break;}
            }
        }else{
            // No conversion - show conversion section
            if(convDiv)convDiv.style.display='block';
            if(convNewDiv)convNewDiv.style.display='none';
            if(convSelect)convSelect.value='same';
            // Set default unit if ingredient has one
            if(ing&&ing.defUnit){
                for(var i=0;i<unitSel.options.length;i++){
                    if(unitSel.options[i].value===ing.defUnit){unitSel.selectedIndex=i;break;}
                }
            }
        }
    }else{
        // Recipe/prep item - hide conversion fields
        if(convDiv)convDiv.style.display='none';
    }
}

function onConvSelect(areaId){
    var convSelect=document.getElementById('conv-select-'+areaId);
    var convNewDiv=document.getElementById('conv-new-'+areaId);
    var unitSel=document.getElementById('unit-'+areaId);

    if(!convSelect)return;
    var val=convSelect.value;

    if(val==='same'){
        // Storage = Recipe Units - hide new fields
        if(convNewDiv)convNewDiv.style.display='none';
    }else if(val==='new'){
        // Show create new fields
        if(convNewDiv)convNewDiv.style.display='block';
    }else if(val){
        // Selected existing conversion - hide new fields, apply conversion's storage unit
        if(convNewDiv)convNewDiv.style.display='none';
        var conv=D.conversions?D.conversions.find(function(c){return c.id===+val;}):null;
        if(conv && unitSel){
            // Check if storage unit exists in dropdown, if not add it temporarily
            var found=false;
            for(var i=0;i<unitSel.options.length;i++){
                if(unitSel.options[i].value===conv.storageUnit){
                    unitSel.selectedIndex=i;
                    found=true;
                    break;
                }
            }
            if(!found){
                var opt=document.createElement('option');
                opt.value=conv.storageUnit;
                opt.text=conv.storageUnit;
                unitSel.add(opt);
                unitSel.value=conv.storageUnit;
            }
        }
    }else{
        // Nothing selected
        if(convNewDiv)convNewDiv.style.display='none';
    }
}

function updInv(id,v){
    var i=D.inv.find(function(x){return x.id===id;});
    if(i){
        saveState('Update qty');
        var oldQty=i.qty;
        var oldUnit=i.unit;
        i.qty=+v||0;
        var itemName='';
        if(i.ingId){
            var ing=D.ings.find(function(x){return x.id===i.ingId;});
            itemName=ing?ing.name:'';
        }else if(i.recId){
            var rec=D.recs.find(function(r){return r.id===i.recId;});
            itemName=rec?rec.name:'';
        }else if(i.menuId){
            var menu=D.menus.find(function(m){return m.id===i.menuId;});
            itemName=menu?menu.name:'';
        }
        logInventoryChange(itemName,oldQty,oldUnit,i.qty,i.unit);
        render();
    }
}

function updInvUnit(id,v){
    var i=D.inv.find(function(x){return x.id===id;});
    if(i){
        saveState('Update inventory unit');
        var oldUnit=i.unit;
        i.unit=v;
        var itemName='';
        if(i.ingId)itemName=getIngName(i.ingId);
        else if(i.recId)itemName=getRecName(i.recId);
        else if(i.menuId)itemName=getMenuName(i.menuId);
        logInventoryChange(itemName,i.qty,oldUnit,i.qty,i.unit);
        render();
    }
}

function delInv(id){
    var i=D.inv.find(function(x){return x.id===id;});
    if(i&&confirm('Remove from inventory?')){
        saveState('Remove from inventory');
        var itemName='';
        if(i.ingId)itemName=getIngName(i.ingId);
        else if(i.recId)itemName=getRecName(i.recId);
        else if(i.menuId)itemName=getMenuName(i.menuId);
        logInventoryChange(itemName,i.qty,i.unit,0,i.unit);
        D.inv=D.inv.filter(function(x){return x.id!==id;});
        render();
    }
}

function editInvItem(id){
    var inv=D.inv.find(function(x){return x.id===id;});
    if(!inv)return;
    var itemName='';
    if(inv.ingId){
        var ing=D.ings.find(function(x){return x.id===inv.ingId;});
        itemName=ing?ing.name:'Unknown';
    }else if(inv.recId){
        var rec=D.recs.find(function(r){return r.id===inv.recId;});
        itemName=rec?'üç≥ '+rec.name:'Unknown Prep';
    }
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Move '+itemName+'</div>';
    html+='<div class="form-g"><label class="form-l">Current Location</label><div style="padding:8px;background:rgba(0,0,0,.2);border-radius:6px;color:#a0aec0;font-size:calc(12px * var(--font-scale))">'+getAreaName(inv.areaId,inv.subArea)+'</div></div>';
    html+='<div class="form-g"><label class="form-l">Move To</label><select id="move-area" class="form-i" onchange="updateSubAreaOptions()">';
    D.areas.forEach(function(a){html+='<option value="'+a.id+'"'+(a.id===inv.areaId?' selected':'')+'>'+a.name+'</option>';});
    html+='</select></div>';
    html+='<div class="form-g" id="sub-area-wrap"><label class="form-l">Section</label><select id="move-sub" class="form-i"><option value="">Main Area</option></select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="moveInvItem('+id+')" style="flex:1">Move</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    updateSubAreaOptions();
}

function updateSubAreaOptions(){
    var areaId=+document.getElementById('move-area').value;
    var area=D.areas.find(function(a){return a.id===areaId;});
    var wrap=document.getElementById('sub-area-wrap');
    var sel=document.getElementById('move-sub');
    if(area&&area.sections.length){
        wrap.style.display='block';
        sel.innerHTML='<option value="">Main Area</option>';
        area.sections.forEach(function(sec){sel.innerHTML+='<option value="'+sec+'">'+sec+'</option>';});
    }else{
        wrap.style.display='none';
        sel.innerHTML='<option value="">Main Area</option>';
    }
}

function moveInvItem(id){
    var inv=D.inv.find(function(x){return x.id===id;});
    if(!inv)return;
    var newAreaId=+document.getElementById('move-area').value;
    var newSub=document.getElementById('move-sub').value;
    saveState('Move item');
    inv.areaId=newAreaId;
    inv.subArea=newSub;
    closeModal();
    render();
}

// ==================== SHOPPING LIST ====================
function renderShop(c,s){
    var toBuy=D.shopping.filter(function(x){return !x.checked&&!x.savedForLater;});
    var purchased=D.shopping.filter(function(x){return x.checked&&!x.savedForLater;});
    var saved=D.shopping.filter(function(x){return x.savedForLater;});
    s.textContent=toBuy.length+' to buy';

    var html='';

    // Calculate Shopping button
    html+='<div style="margin-bottom:12px"><button class="btn btn-p" onclick="calculateShoppingList()" style="width:100%">üßÆ Calculate Shopping List from Prep Needs</button></div>';

    // Auto-add toggle
    html+='<div class="card" style="padding:10px;margin-bottom:12px;background:'+(D.autoAddToInv?'rgba(0,184,148,.15)':'rgba(255,255,255,.05)')+'">';
    html+='<label style="display:flex;align-items:center;gap:10px;cursor:pointer">';
    html+='<input type="checkbox" id="auto-add-toggle" '+(D.autoAddToInv?'checked':'')+' onchange="toggleAutoAdd()">';
    html+='<div><div style="font-weight:600;font-size:calc(12px * var(--font-scale));color:'+(D.autoAddToInv?'#00b894':'#a0aec0')+'">‚ö° Auto-Add to Inventory</div>';
    html+='<div style="font-size:calc(10px * var(--font-scale));color:#636e72">When checked, purchased items go directly to their designated locations</div></div>';
    html+='</label></div>';

    html+='<div class="sec" style="color:#e17055">To Buy ('+toBuy.length+')</div>';
    if(toBuy.length){
        // Group items by ingredient category
        var byCategory = {};
        toBuy.forEach(function(item){
            var ing = D.ings.find(function(x){return x.id===item.ingId;});
            var catId = ing ? (ing.catId || 0) : 0;
            if(!byCategory[catId]) byCategory[catId] = [];
            byCategory[catId].push({item: item, ing: ing});
        });

        // Sort categories and render
        var catIds = Object.keys(byCategory).sort(function(a,b){
            var catA = D.cats.find(function(c){return c.id === +a;});
            var catB = D.cats.find(function(c){return c.id === +b;});
            var nameA = catA ? catA.name : 'Uncategorized';
            var nameB = catB ? catB.name : 'Uncategorized';
            return nameA.localeCompare(nameB);
        });

        catIds.forEach(function(catId){
            var cat = D.cats.find(function(c){return c.id === +catId;});
            var catName = cat ? cat.name : 'Uncategorized';
            var items = byCategory[catId];

            html+='<div style="margin-top:8px;padding:4px 8px;background:rgba(255,255,255,.05);border-radius:6px;font-size:calc(11px * var(--font-scale));color:#a0aec0;font-weight:600">'+catName+' ('+items.length+')</div>';

            items.forEach(function(data){
                var item = data.item;
                var ing = data.ing;
                if(ing){
                    html+='<div class="shop-item" style="flex-wrap:wrap"><div class="shop-check" onclick="togShop('+item.id+')"></div><div class="shop-info" style="flex:1;min-width:120px"><div class="shop-name">'+ing.name+'</div></div><div class="shop-qty">'+formatQty(item.qty)+' '+item.unit+'</div><button class="btn btn-s btn-sm" onclick="saveForLater('+item.id+')">üíæ</button>';
                    // Show usedFor info if available
                    if(item.usedFor || item.totalNeed){
                        html+='<div style="width:100%;padding:6px 0 0 32px;font-size:calc(10px * var(--font-scale));color:#a0aec0;line-height:1.4">';
                        // Show recipe units if different from shopping units
                        var recipeUnit = item.recipeUnit || item.unit;
                        var recipeQty = formatQty(item.recipeQty || item.totalNeed || item.qty);
                        if(recipeUnit !== item.unit){
                            html+='<div style="color:#fdcb6e">Recipe needs: '+recipeQty+' '+recipeUnit+'</div>';
                        }
                        html+='<div style="color:#636e72">Need: '+formatQty(item.totalNeed||item.qty)+' '+recipeUnit+' | Have: '+formatQty(item.onHand||0)+' '+recipeUnit+'</div>';
                        if(item.usedFor){
                            html+='<div style="margin-top:2px">'+item.usedFor+'</div>';
                        }
                        html+='</div>';
                    }
                    html+='</div>';
                }
            });
        });
    }else{
        html+='<div style="color:#636e72;font-size:calc(12px * var(--font-scale));padding:16px;text-align:center">Nothing to buy!</div>';
    }
    
    html+='<div class="sec" style="color:#00b894;margin-top:20px;display:flex;justify-content:space-between;align-items:center">Purchased ('+purchased.length+')';
    if(purchased.length){
        // Count how many can be auto-added (have designated locations)
        var canAutoAdd=purchased.filter(function(item){
            var ing=D.ings.find(function(x){return x.id===item.ingId;});
            return ing&&ing.areaId;
        }).length;
        if(canAutoAdd>0){
            html+='<button class="btn btn-p btn-sm" onclick="addAllPurchasedToInv()" style="font-size:calc(10px * var(--font-scale))">üì¶ Add All to Inventory ('+canAutoAdd+')</button>';
        }
    }
    html+='</div>';
    if(purchased.length){
        purchased.forEach(function(item){
            var ing=D.ings.find(function(x){return x.id===item.ingId;});
            if(ing){
                var hasLocation=ing.areaId?'‚úì':'‚ö†Ô∏è';
                var locationName=ing.areaId?getAreaName(ing.areaId,ing.subArea):'No location set';
                html+='<div class="shop-item checked"><div class="shop-check checked" onclick="togShop('+item.id+')">‚úì</div><div class="shop-info"><div class="shop-name" style="text-decoration:line-through">'+ing.name+'</div><div class="shop-meta">'+hasLocation+' '+locationName+'</div></div><div class="shop-qty">'+item.qty+' '+item.unit+'</div><button class="shop-undo" onclick="undoShopCheck('+item.id+')">‚Ü©</button><button class="btn btn-p btn-sm" onclick="addToInv('+item.id+')"'+(ing.areaId?'':' style="background:#fdcb6e"')+'>‚Üí Inv</button></div>';
            }
        });
    }
    
    html+='<div class="sec" style="color:#fdcb6e;margin-top:20px">Saved for Later ('+saved.length+')</div>';
    if(saved.length){
        saved.forEach(function(item){
            var ing=D.ings.find(function(x){return x.id===item.ingId;});
            if(ing){
                html+='<div class="shop-item" style="opacity:.6"><div class="shop-info"><div class="shop-name">'+ing.name+'</div></div><div class="shop-qty">'+item.qty+' '+item.unit+'</div><button class="btn btn-s btn-sm" onclick="restoreFromSaved('+item.id+')">‚Ü©</button><button class="del-btn" onclick="delShop('+item.id+')">üóëÔ∏è</button></div>';
            }
        });
    }
    
    c.innerHTML=html;
}

function togShop(id){
    var s=D.shopping.find(function(x){return x.id===id;});
    if(s){
        saveState(s.checked?'Uncheck item':'Mark purchased');
        s.checked=s.checked?0:1;
        if(s.checked){
            // Auto-add to inventory if enabled and ingredient has a location
            if(D.autoAddToInv){
                var ing=D.ings.find(function(x){return x.id===s.ingId;});
                if(ing&&ing.areaId){
                    D.inv.push({id:nid++,areaId:ing.areaId,subArea:ing.subArea||'',ingId:ing.id,qty:s.qty,unit:s.unit});
                    logInventoryChange(ing.name,0,s.unit,s.qty,s.unit);
                    D.shopping=D.shopping.filter(function(x){return x.id!==id;});
                }
            }
        }
        render();
    }
}

function toggleAutoAdd(){
    saveState('Toggle auto add to inventory');
    D.autoAddToInv=D.autoAddToInv?0:1;
    changeLog.settings=true;
    render();
}

function undoShopCheck(id){
    var s=D.shopping.find(function(x){return x.id===id;});
    if(s){
        saveState('Undo purchase check');
        s.checked=0;
        render();
    }
}

function saveForLater(id){
    var s=D.shopping.find(function(x){return x.id===id;});
    if(s){saveState('Save for later');s.savedForLater=1;render();}
}

function restoreFromSaved(id){
    var s=D.shopping.find(function(x){return x.id===id;});
    if(s){saveState('Restore from saved');s.savedForLater=0;render();}
}

function delShop(id){
    if(confirm('Remove from shopping list?')){
        saveState('Remove from shopping');
        D.shopping=D.shopping.filter(function(x){return x.id!==id;});
        render();
    }
}

function addToInv(shopId){
    var s=D.shopping.find(function(x){return x.id===shopId;});
    if(!s)return;
    var ing=D.ings.find(function(x){return x.id===s.ingId;});
    if(!ing)return;

    // Check if ingredient has a default location
    if(ing.areaId){
        saveState('Add to inventory from shopping');
        D.inv.push({id:nid++,areaId:ing.areaId,subArea:ing.subArea||'',ingId:ing.id,qty:s.qty,unit:s.unit});
        logInventoryChange(ing.name,0,s.unit,s.qty,s.unit);
        D.shopping=D.shopping.filter(function(x){return x.id!==shopId;});
        render();
    }else{
        // Show location picker
        pendingPurchase=shopId;
        openLocationPicker(s);
    }
}

function addAllPurchasedToInv(){
    var purchased=D.shopping.filter(function(x){return x.checked&&!x.savedForLater;});
    var added=0;
    var skipped=0;
    var skippedItems=[];
    
    saveState('Add all purchased to inventory');
    
    purchased.forEach(function(s){
        var ing=D.ings.find(function(x){return x.id===s.ingId;});
        if(ing&&ing.areaId){
            D.inv.push({id:nid++,areaId:ing.areaId,subArea:ing.subArea||'',ingId:ing.id,qty:s.qty,unit:s.unit});
            logInventoryChange(ing.name,0,s.unit,s.qty,s.unit);
            D.shopping=D.shopping.filter(function(x){return x.id!==s.id;});
            added++;
        }else{
            skipped++;
            if(ing)skippedItems.push(ing.name);
        }
    });
    
    render();
    
    var msg='Added '+added+' item'+(added!==1?'s':'')+' to inventory.';
    if(skipped>0){
        msg+='\n\n'+skipped+' item'+(skipped!==1?'s':'')+' skipped (no location set):\n‚Ä¢ '+skippedItems.join('\n‚Ä¢ ');
    }
    alert(msg);
}

function openLocationPicker(shopItem){
    var ing=D.ings.find(function(x){return x.id===shopItem.ingId;});
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Select Location for '+ing.name+'</div>';
    html+='<div class="form-g"><label class="form-l">Storage Area</label><select id="loc-area" class="form-i" onchange="updateSubAreaOptions()">';
    D.areas.forEach(function(a){html+='<option value="'+a.id+'">'+a.name+'</option>';});
    html+='</select></div>';
    html+='<div class="form-g" id="sub-area-wrap"><label class="form-l">Section</label><select id="move-sub" class="form-i"><option value="">Main Area</option></select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal();pendingPurchase=null;" style="flex:1">Cancel</button><button class="btn btn-p" onclick="confirmAddToInv()" style="flex:1">Add to Inventory</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    updateSubAreaOptions();
}

function confirmAddToInv(){
    if(!pendingPurchase)return;
    var s=D.shopping.find(function(x){return x.id===pendingPurchase;});
    if(!s)return;
    var areaId=+document.getElementById('loc-area').value;
    var subArea=document.getElementById('move-sub').value;
    
    saveState('Add to inventory from shopping');
    D.inv.push({id:nid++,areaId:areaId,subArea:subArea,ingId:s.ingId,qty:s.qty,unit:s.unit});
    logInventoryChange(getIngName(s.ingId),0,s.unit,s.qty,s.unit);
    D.shopping=D.shopping.filter(function(x){return x.id!==pendingPurchase;});
    pendingPurchase=null;
    closeModal();
    render();
}

// Helper: Recursively expand a recipe to get all ingredients (handles sub-recipes)
function expandRecipeIngredients(recId, multiplier, visited, sources){
    if(!visited) visited = {};
    if(visited[recId]) return []; // Prevent infinite recursion
    visited[recId] = true;

    var rec = D.recs.find(function(r){return r.id === recId;});
    if(!rec) return [];

    var ingredients = [];

    // Add direct ingredients
    if(rec.ings && rec.ings.length){
        rec.ings.forEach(function(ri){
            ingredients.push({
                ingId: ri.ingId,
                qty: (ri.qty || 0) * multiplier,
                unit: ri.unit,
                source: sources || rec.name
            });
        });
    }

    // Recursively expand sub-recipes
    if(rec.subRecs && rec.subRecs.length){
        rec.subRecs.forEach(function(sr){
            var subIngs = expandRecipeIngredients(sr.recId, (sr.qty || 1) * multiplier, visited, sources || rec.name);
            ingredients = ingredients.concat(subIngs);
        });
    }

    return ingredients;
}

// Helper: Round quantity for display (max 2 decimal places, remove trailing zeros)
function roundQty(qty){
    if(typeof qty !== 'number' || isNaN(qty)) return 0;
    return Math.round(qty * 100) / 100;
}
function formatQty(qty){
    var rounded = roundQty(qty);
    // Remove unnecessary trailing zeros
    return rounded.toString().replace(/\.?0+$/, '');
}

// Helper: Convert quantity between units using conversions
function convertToRecipeUnits(ingId, qty, fromUnit){
    var conv = D.conversions ? D.conversions.find(function(c){return c.ingId === ingId;}) : null;
    if(!conv) return {qty: qty, unit: fromUnit};

    // If fromUnit is storage unit, convert to recipe units
    if(fromUnit === conv.storageUnit){
        return {qty: qty * conv.factor, unit: conv.recipeUnit};
    }
    return {qty: qty, unit: fromUnit};
}

function convertToStorageUnits(ingId, qty, fromUnit){
    var conv = D.conversions ? D.conversions.find(function(c){return c.ingId === ingId;}) : null;
    if(!conv) return {qty: qty, unit: fromUnit};

    // If fromUnit is recipe unit, convert to storage units
    if(fromUnit === conv.recipeUnit){
        return {qty: qty / conv.factor, unit: conv.storageUnit};
    }
    return {qty: qty, unit: fromUnit};
}

function calculateShoppingList(silent){
    saveState('Calculate shopping list');

    // ========== STEP 1: Calculate Menu needs (subtract finished menu items) ==========
    var menuNeeds = {}; // menuId -> {needed, unit, name}

    D.menus.filter(function(m){return !m.archived && m.includeInShop;}).forEach(function(menu){
        var target = menu.tgt || 0;

        // Subtract finished menu items from inventory (menuId)
        var onHandMenu = 0;
        D.inv.forEach(function(inv){
            if(inv.menuId === menu.id) onHandMenu += inv.qty;
        });

        var needed = target - onHandMenu;
        if(needed > 0){
            menuNeeds[menu.id] = {needed: needed, original: target, onHand: onHandMenu, name: menu.name, menu: menu};
        }
    });

    // ========== STEP 2: Calculate Recipe needs from Menu items ==========
    var recipeNeeds = {}; // recId -> {qty, unit, menuSources:[]}

    Object.keys(menuNeeds).forEach(function(menuIdStr){
        var menuId = +menuIdStr;
        var menuNeed = menuNeeds[menuId];
        var menu = menuNeed.menu;

        if(menu.recs && menu.recs.length){
            menu.recs.forEach(function(mr){
                var rec = D.recs.find(function(r){return r.id === mr.recId;});
                // Only include recipes that have includeInPrep checked
                if(rec && rec.includeInPrep){
                    var needed = menuNeed.needed * (mr.qty || 1);
                    if(!recipeNeeds[mr.recId]) recipeNeeds[mr.recId] = {qty: 0, unit: mr.unit, menuSources:[]};
                    recipeNeeds[mr.recId].qty += needed;
                    recipeNeeds[mr.recId].menuSources.push({name: menu.name, qty: needed});
                }
            });
        }
    });

    // ========== STEP 3: Calculate batches needed (subtract prep inventory) ==========
    var batchesNeeded = {}; // recId -> {batches, menuSources, recName}

    Object.keys(recipeNeeds).forEach(function(recIdStr){
        var recId = +recIdStr;
        var rec = D.recs.find(function(r){return r.id === recId;});
        if(!rec) return;

        var need = recipeNeeds[recId];
        var output = calcRecipeOutput(rec);

        // Get on-hand prep inventory for this recipe
        var onHand = 0;
        D.inv.forEach(function(inv){
            if(inv.recId === recId) onHand += inv.qty;
        });

        // Calculate shortfall in output units
        var shortfall = need.qty - onHand;
        if(shortfall <= 0) return; // Have enough prep

        // Calculate batches needed (output.qty is per batch)
        var batchQty = output.qty || 1;
        var batches = Math.ceil(shortfall / batchQty);
        batchesNeeded[recId] = {batches: batches, menuSources: need.menuSources, recName: rec.name};
    });

    // ========== STEP 4: Calculate ingredient needs (with sub-recipe expansion) ==========
    var ingredientNeeds = {}; // ingId -> {qty, unit, sources:[]}

    Object.keys(batchesNeeded).forEach(function(recIdStr){
        var recId = +recIdStr;
        var batchInfo = batchesNeeded[recId];

        // Expand recipe including all sub-recipes
        var allIngs = expandRecipeIngredients(recId, batchInfo.batches, {}, batchInfo.recName);

        allIngs.forEach(function(ing){
            if(!ingredientNeeds[ing.ingId]){
                ingredientNeeds[ing.ingId] = {qty: 0, unit: ing.unit, sources:[]};
            }
            ingredientNeeds[ing.ingId].qty += ing.qty;
            ingredientNeeds[ing.ingId].sources.push({
                type: 'recipe',
                name: ing.source,
                qty: ing.qty,
                menus: batchInfo.menuSources
            });
        });
    });

    // ========== STEP 5: Add direct ingredients from Menu items ==========
    // Track standalone ingredients linked to menus (we'll handle them separately)
    var standaloneMenuIngIds = {};

    Object.keys(menuNeeds).forEach(function(menuIdStr){
        var menuId = +menuIdStr;
        var menuNeed = menuNeeds[menuId];
        var menu = menuNeed.menu;

        if(menu.ings && menu.ings.length){
            menu.ings.forEach(function(mi){
                var ing = D.ings.find(function(i){return i.id === mi.ingId;});

                // If this is a standalone ingredient, DON'T multiply by menu needs
                // Just mark it so we use its minQty target instead
                if(ing && ing.standalone){
                    standaloneMenuIngIds[mi.ingId] = {
                        menuName: menu.name,
                        minQty: ing.minQty || 0,
                        unit: ing.defUnit || mi.unit
                    };
                    return; // Skip the normal multiplication
                }

                var needed = menuNeed.needed * (mi.qty || 0);
                if(needed <= 0) return;
                if(!ingredientNeeds[mi.ingId]){
                    ingredientNeeds[mi.ingId] = {qty: 0, unit: mi.unit, sources:[]};
                }
                ingredientNeeds[mi.ingId].qty += needed;
                ingredientNeeds[mi.ingId].sources.push({type:'menu', name: menu.name, qty: needed});
            });
        }
    });

    // ========== STEP 5b: Add standalone ingredients using their minQty target (if autoShop enabled) ==========
    Object.keys(standaloneMenuIngIds).forEach(function(ingIdStr){
        var ingId = +ingIdStr;
        var standaloneInfo = standaloneMenuIngIds[ingId];

        // Check if autoShop is enabled for this ingredient
        var ing = D.ings.find(function(i){return i.id === ingId;});
        if(!ing || !ing.autoShop) return;

        // Use the standalone ingredient's minQty as the target (not multiplied)
        var needed = standaloneInfo.minQty;
        if(needed <= 0) return;

        if(!ingredientNeeds[ingId]){
            ingredientNeeds[ingId] = {qty: 0, unit: standaloneInfo.unit, sources:[]};
        }
        // Replace any existing qty with the minQty (don't add to it)
        ingredientNeeds[ingId].qty = needed;
        ingredientNeeds[ingId].sources = [{type:'standalone', name: standaloneInfo.menuName + ' (Standalone Min)', qty: needed}];
    });

    // ========== STEP 5c: Add ALL standalone ingredients with minQty and autoShop enabled ==========
    D.ings.filter(function(ing){
        return !ing.archived && ing.standalone && ing.minQty > 0 && ing.autoShop;
    }).forEach(function(ing){
        // Skip if already added via menu link
        if(ingredientNeeds[ing.id]) return;

        ingredientNeeds[ing.id] = {
            qty: ing.minQty,
            unit: ing.defUnit,
            sources: [{type:'standalone', name: ing.name + ' (Standalone Min)', qty: ing.minQty}]
        };
    });

    // ========== STEP 6: Subtract inventory (with unit conversion) ==========
    var toShop = {}; // ingId -> {qty, unit, sources, onHand, totalNeed}

    Object.keys(ingredientNeeds).forEach(function(ingIdStr){
        var ingId = +ingIdStr;
        var need = ingredientNeeds[ingId];

        // Skip water - always available
        var ing = D.ings.find(function(i){return i.id === ingId;});
        if(ing && ing.name.toLowerCase() === 'water') return;

        // Get on-hand inventory for this ingredient (convert to recipe units if needed)
        var onHandRecipeUnits = 0;
        D.inv.forEach(function(inv){
            if(inv.ingId === ingId){
                var converted = convertToRecipeUnits(ingId, inv.qty, inv.unit);
                // Only add if units match or conversion worked
                if(converted.unit === need.unit || !need.unit){
                    onHandRecipeUnits += converted.qty;
                } else {
                    // Units don't match and no conversion - add raw
                    onHandRecipeUnits += inv.qty;
                }
            }
        });

        var shortfall = need.qty - onHandRecipeUnits;
        if(shortfall > 0){
            // Convert shortfall to storage units for shopping
            var forShopping = convertToStorageUnits(ingId, shortfall, need.unit);
            toShop[ingId] = {
                qty: Math.ceil(forShopping.qty * 10) / 10,
                unit: forShopping.unit,
                recipeQty: shortfall,
                recipeUnit: need.unit,
                sources: need.sources,
                onHand: onHandRecipeUnits,
                totalNeed: need.qty
            };
        }
    });

    // ========== STEP 7: Update shopping list ==========
    var added = 0;
    var updated = 0;

    Object.keys(toShop).forEach(function(ingIdStr){
        var ingId = +ingIdStr;
        var need = toShop[ingId];

        // Build usedFor string from sources
        var usedFor = need.sources.map(function(s){
            if(s.type === 'menu') return 'üçΩÔ∏è ' + s.name + ' (' + formatQty(s.qty) + ')';
            if(s.type === 'recipe'){
                var menuNames = s.menus ? s.menus.map(function(m){return m.name;}).join(', ') : '';
                return 'üìñ ' + s.name + ' (' + formatQty(s.qty) + ')' + (menuNames ? ' ‚Üí ' + menuNames : '');
            }
            return s.name;
        }).join('; ');

        // Check if already in shopping list
        var existing = D.shopping.find(function(s){return s.ingId === ingId && !s.checked && !s.savedForLater;});
        if(existing){
            existing.qty = need.qty;
            existing.unit = need.unit;
            existing.usedFor = usedFor;
            existing.onHand = need.onHand;
            existing.totalNeed = need.totalNeed;
            existing.recipeQty = need.recipeQty;
            existing.recipeUnit = need.recipeUnit;
            updated++;
        } else {
            D.shopping.push({
                id: nid++,
                ingId: ingId,
                qty: need.qty,
                unit: need.unit,
                checked: 0,
                savedForLater: 0,
                usedFor: usedFor,
                onHand: need.onHand,
                totalNeed: need.totalNeed,
                recipeQty: need.recipeQty,
                recipeUnit: need.recipeUnit
            });
            added++;
        }
    });

    // Remove items that are no longer needed
    var removed = 0;
    D.shopping = D.shopping.filter(function(s){
        if(s.checked || s.savedForLater) return true;
        if(toShop[s.ingId]) return true;
        removed++;
        return false;
    });

    if(!silent){
        alert('Shopping list updated!\nAdded: ' + added + '\nUpdated: ' + updated + '\nRemoved: ' + removed);
    }
    render();
}

// ==================== PREP STATUS ====================
function renderPrep(c,s){
    // ========== SECTION 1: Menu Item Prep Status ==========
    var menuPrepList = [];

    D.menus.filter(function(m){return !m.archived && m.includeInPrep;}).forEach(function(menu){
        var target = menu.tgt || 0;

        // Get on-hand finished menu items from inventory (menuId)
        var onHand = 0;
        D.inv.forEach(function(inv){
            if(inv.menuId === menu.id) onHand += inv.qty;
        });

        menuPrepList.push({
            menuId: menu.id,
            name: menu.name,
            target: target,
            onHand: onHand,
            unit: D.units.find(function(u){return u.id === menu.unitId;}) ? D.units.find(function(u){return u.id === menu.unitId;}).abbr : 'ea'
        });
    });

    // ========== SECTION 2: Recipe Prep Status ==========
    var prepNeeds = {}; // recId -> {name, totalNeeded, unit, usedIn:[]}

    // Only process menus with includeInPrep checked
    D.menus.filter(function(m){return !m.archived && m.includeInPrep;}).forEach(function(menu){
        var target = menu.tgt || 0;

        // Subtract finished menu items from target
        var onHandMenu = 0;
        D.inv.forEach(function(inv){
            if(inv.menuId === menu.id) onHandMenu += inv.qty;
        });
        var menuNeeded = target - onHandMenu;
        if(menuNeeded <= 0) return; // Menu item fully stocked

        if(menu.recs && menu.recs.length){
            menu.recs.forEach(function(mr){
                var rec = D.recs.find(function(r){return r.id === mr.recId;});
                // Only include recipes that have includeInPrep checked
                if(rec && rec.includeInPrep){
                    if(!prepNeeds[mr.recId]){
                        prepNeeds[mr.recId] = {name: rec.name, totalNeeded: 0, unit: mr.unit || 'ea', usedIn: []};
                    }
                    var needed = menuNeeded * (mr.qty || 1);
                    prepNeeds[mr.recId].totalNeeded += needed;
                    prepNeeds[mr.recId].usedIn.push(menu.name + ' (' + menuNeeded + '√ó' + mr.qty + ')');
                }
            });
        }
    });

    // Convert to array and get on-hand from inventory
    var prepList = [];
    Object.keys(prepNeeds).forEach(function(recIdStr){
        var recId = +recIdStr;
        var need = prepNeeds[recId];
        // Find on-hand in inventory (items with recId)
        var onHand = 0;
        D.inv.forEach(function(inv){
            if(inv.recId === recId){
                onHand += inv.qty;
            }
        });
        prepList.push({
            recId: recId,
            name: need.name,
            target: need.totalNeeded,
            unit: need.unit,
            onHand: onHand,
            usedIn: need.usedIn
        });
    });

    // Sort by difference (most critical first)
    prepList.sort(function(a,b){
        return (a.onHand - a.target) - (b.onHand - b.target);
    });
    menuPrepList.sort(function(a,b){
        return (a.onHand - a.target) - (b.onHand - b.target);
    });

    s.textContent = (menuPrepList.length + prepList.length) + ' prep items';

    var html = '';

    // ========== Render Menu Prep Section (grouped by category) ==========
    if(menuPrepList.length){
        html += '<div class="sec" style="color:#74b9ff">üçΩÔ∏è Menu Items (' + menuPrepList.length + ')</div>';

        // Group menu prep items by category
        D.menuCats.forEach(function(cat){
            var catItems = menuPrepList.filter(function(item){
                var menu = D.menus.find(function(m){ return m.id === item.menuId; });
                return menu && menu.catId === cat.id;
            });
            if(!catItems.length) return;

            html += '<div style="color:#74b9ff;font-size:calc(12px * var(--font-scale));font-weight:600;margin:12px 0 8px;padding-left:4px">' + cat.name + ' (' + catItems.length + ')</div>';

            catItems.forEach(function(item){
                var diff = item.onHand - item.target;
                var status = getStatusTxt(item.onHand, item.target);
                var color = getStatusColor(item.onHand, item.target);
                html += '<div class="card">';
                html += '<div class="card-h"><div><div class="card-t">' + item.name + '</div>';
                html += '<div class="card-s">Target: ' + item.target + ' ' + item.unit + '</div></div>';
                html += '<span class="status-badge status-' + status.toLowerCase() + '">' + status + '</span></div>';
                html += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px">';
                html += '<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">Finished:</span>';
                html += '<span style="padding:6px 12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#e0e6ed;font-size:calc(14px * var(--font-scale))">' + item.onHand + ' ' + item.unit + '</span>';
                html += '<span style="margin-left:auto;font-weight:600;color:' + (color === 'green' ? '#00b894' : color === 'yellow' ? '#fdcb6e' : '#d63031') + '">' + (diff >= 0 ? '+' : '') + diff + '</span>';
                html += '</div>';
                html += '</div>';
            });
        });

        // Handle uncategorized items
        var uncatItems = menuPrepList.filter(function(item){
            var menu = D.menus.find(function(m){ return m.id === item.menuId; });
            return !menu || !menu.catId;
        });
        if(uncatItems.length){
            html += '<div style="color:#74b9ff;font-size:calc(12px * var(--font-scale));font-weight:600;margin:12px 0 8px;padding-left:4px">Uncategorized (' + uncatItems.length + ')</div>';
            uncatItems.forEach(function(item){
                var diff = item.onHand - item.target;
                var status = getStatusTxt(item.onHand, item.target);
                var color = getStatusColor(item.onHand, item.target);
                html += '<div class="card">';
                html += '<div class="card-h"><div><div class="card-t">' + item.name + '</div>';
                html += '<div class="card-s">Target: ' + item.target + ' ' + item.unit + '</div></div>';
                html += '<span class="status-badge status-' + status.toLowerCase() + '">' + status + '</span></div>';
                html += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px">';
                html += '<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">Finished:</span>';
                html += '<span style="padding:6px 12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#e0e6ed;font-size:calc(14px * var(--font-scale))">' + item.onHand + ' ' + item.unit + '</span>';
                html += '<span style="margin-left:auto;font-weight:600;color:' + (color === 'green' ? '#00b894' : color === 'yellow' ? '#fdcb6e' : '#d63031') + '">' + (diff >= 0 ? '+' : '') + diff + '</span>';
                html += '</div>';
                html += '</div>';
            });
        }
    }

    // ========== Render Recipe Prep Section ==========
    if(prepList.length){
        html += '<div class="sec" style="color:#fdcb6e;margin-top:16px">üç≥ Recipe Prep (' + prepList.length + ')</div>';
        prepList.forEach(function(prep){
            var diff = prep.onHand - prep.target;
            var status = getStatusTxt(prep.onHand, prep.target);
            var color = getStatusColor(prep.onHand, prep.target);
            html += '<div class="card">';
            html += '<div class="card-h"><div><div class="card-t">' + prep.name + '</div>';
            html += '<div class="card-s">Target: ' + prep.target + ' ' + prep.unit + ' ‚Ä¢ Used in: ' + prep.usedIn.length + ' menu items</div></div>';
            html += '<span class="status-badge status-' + status.toLowerCase() + '">' + status + '</span></div>';
            html += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px">';
            html += '<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">On Hand:</span>';
            html += '<span style="padding:6px 12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:#e0e6ed;font-size:calc(14px * var(--font-scale))">' + prep.onHand + ' ' + prep.unit + '</span>';
            html += '<span style="margin-left:auto;font-weight:600;color:' + (color === 'green' ? '#00b894' : color === 'yellow' ? '#fdcb6e' : '#d63031') + '">' + (diff >= 0 ? '+' : '') + diff + '</span>';
            html += '</div>';
            html += '<div style="margin-top:8px;font-size:calc(10px * var(--font-scale));color:#636e72">' + prep.usedIn.join(', ') + '</div>';
            html += '</div>';
        });
    }

    if(!menuPrepList.length && !prepList.length){
        html += '<div class="card" style="text-align:center;color:#a0aec0">';
        html += '<div style="font-size:calc(14px * var(--font-scale));margin-bottom:8px">No prep items yet</div>';
        html += '<div style="font-size:calc(11px * var(--font-scale))">Enable "Include in Prep" on menu items and their recipes to see requirements here.</div>';
        html += '</div>';
    } else {
        html += '<div style="text-align:center;margin-top:16px;padding:12px;background:rgba(108,92,231,.1);border-radius:8px;font-size:calc(11px * var(--font-scale));color:#a29bfe">';
        html += 'üí° Update on-hand quantities in the <strong>Inventory</strong> tab';
        html += '</div>';
    }
    c.innerHTML = html;
}

// updPrep no longer needed - prep is calculated, not manual

// ==================== INGREDIENTS ====================
var ingSearchTerm = '';

function renderIngs(c,s){
    var activeIngs=D.ings.filter(function(i){return !i.archived;});
    var archivedIngs=D.ings.filter(function(i){return i.archived;});
    var standaloneIngs=activeIngs.filter(function(i){return i.standalone;});
    s.textContent=activeIngs.length+' ingredients';
    var html='';

    // Search bar
    html+='<div style="margin-bottom:16px"><input type="text" id="ing-search" class="form-i" placeholder="üîç Search ingredients..." value="'+ingSearchTerm+'" oninput="filterIngredients(this.value)" style="width:100%"></div>';

    // Filter by search term
    var searchLower = ingSearchTerm.toLowerCase();
    if(ingSearchTerm){
        activeIngs = activeIngs.filter(function(i){return i.name.toLowerCase().indexOf(searchLower) !== -1;});
        standaloneIngs = standaloneIngs.filter(function(i){return i.name.toLowerCase().indexOf(searchLower) !== -1;});
        archivedIngs = archivedIngs.filter(function(i){return i.name.toLowerCase().indexOf(searchLower) !== -1;});
    }
    
    // Standalone ingredients section
    if(standaloneIngs.length){
        html+='<div class="sec" style="color:#fdcb6e">‚≠ê Standalone Items ('+standaloneIngs.length+')</div>';
        standaloneIngs.forEach(function(ing){
            // Check if this standalone ingredient is linked to a menu item
            var linkedMenus=D.menus.filter(function(m){
                return !m.archived && m.ings && m.ings.some(function(mi){return mi.ingId===ing.id;});
            });
            var isLinkedToMenu=linkedMenus.length>0;

            var invItem=D.inv.find(function(x){return x.ingId===ing.id;});
            var onHand=invItem?invItem.qty:0;
            var diff=onHand-ing.minQty;
            var status=diff>=0?'stocked':diff>-3?'low':'critical';

            // Build the info line - if linked to menu, don't show inventory qty
            var infoLine='üìç '+getAreaName(ing.areaId,ing.subArea);
            if(isLinkedToMenu){
                infoLine+=' ‚Ä¢ üçΩÔ∏è Menu Item: '+linkedMenus.map(function(m){return m.name;}).join(', ');
            }else{
                infoLine+=' ‚Ä¢ On hand: '+onHand+' '+ing.defUnit;
            }

            var autoShopIcon=ing.autoShop?'<span style="color:#00b894;font-size:calc(10px * var(--font-scale));margin-left:4px" title="Auto-add to Shopping List">üõí</span>':'<span style="color:#636e72;font-size:calc(10px * var(--font-scale));margin-left:4px" title="Not auto-added to Shopping">‚óã</span>';
            html+='<div class="card" style="border-left:3px solid #fdcb6e"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t">'+ing.name+' <span class="standalone-badge">Standalone</span><span class="min-qty-badge">Min: '+ing.minQty+'</span>'+autoShopIcon+'</div><div class="card-s">'+infoLine+'</div></div><div style="display:flex;gap:4px;align-items:center">'+(isLinkedToMenu?'':'<span class="status-badge status-'+status+'">'+(diff>=0?'+':'')+diff+'</span>')+'<button class="btn btn-s btn-sm" onclick="editIng('+ing.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="deleteIngredient('+ing.id+')" title="Delete">üóëÔ∏è</button></div></div></div>';
        });
    }
    
    // Regular ingredients by category
    D.cats.forEach(function(cat){
        var catIngs=activeIngs.filter(function(i){return i.catId===cat.id&&!i.standalone;});
        if(!catIngs.length)return;
        
        html+='<div class="sec ing">'+cat.name+'</div>';
        catIngs.forEach(function(ing){
            html+='<div class="card" style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t">'+ing.name+'</div><div class="card-s">üìç '+getAreaName(ing.areaId,ing.subArea)+' ‚Ä¢ Default: '+ing.defUnit+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editIng('+ing.id+')">‚úèÔ∏è</button><button class="btn btn-s btn-sm" onclick="archiveItem(\'ings\','+ing.id+')" title="Archive">üì•</button><button class="del-btn" onclick="deleteIngredient('+ing.id+')" title="Delete">üóëÔ∏è</button></div></div>';
        });
    });
    
    // Standalone ingredients summary section - grouped by category
    if(standaloneIngs.length){
        html+='<div class="sec" style="color:#fdcb6e;margin-top:24px">‚≠ê Standalone Summary ('+standaloneIngs.length+')</div>';
        html+='<div style="background:rgba(253,203,110,.1);border:1px solid rgba(253,203,110,.2);border-radius:12px;padding:12px">';

        // Group by category
        D.cats.forEach(function(cat){
            var catStandalone = standaloneIngs.filter(function(i){return i.catId === cat.id;});
            if(catStandalone.length){
                html+='<div style="padding:4px 0;color:#fdcb6e;font-size:calc(10px * var(--font-scale));font-weight:600;margin-top:8px;border-bottom:1px solid rgba(253,203,110,.3)">'+cat.name.toUpperCase()+'</div>';
                catStandalone.forEach(function(ing){
                    var invItem=D.inv.find(function(x){return x.ingId===ing.id;});
                    var onHand=invItem?invItem.qty:0;
                    var diff=onHand-ing.minQty;
                    var statusColor=diff>=0?'#00b894':diff>-3?'#fdcb6e':'#ff7675';
                    var autoShopStatus=ing.autoShop?'<span style="color:#00b894" title="Auto-shop enabled">üõí</span>':'<span style="color:#636e72" title="Auto-shop disabled">‚óã</span>';
                    html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)">';
                    html+='<div style="flex:1"><span style="color:#e0e6ed;font-size:calc(13px * var(--font-scale))">'+ing.name+'</span> '+autoShopStatus+'</div>';
                    html+='<div style="display:flex;gap:12px;align-items:center">';
                    html+='<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">Min: '+ing.minQty+' '+ing.defUnit+'</span>';
                    html+='<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">On Hand: '+onHand+'</span>';
                    html+='<span style="color:'+statusColor+';font-size:calc(11px * var(--font-scale));font-weight:600;min-width:40px;text-align:right">'+(diff>=0?'+':'')+diff+'</span>';
                    html+='<button class="btn btn-s btn-sm" onclick="editIng('+ing.id+')">‚úèÔ∏è</button>';
                    html+='</div></div>';
                });
            }
        });
        // Uncategorized standalone
        var uncatStandalone = standaloneIngs.filter(function(i){return !i.catId;});
        if(uncatStandalone.length){
            html+='<div style="padding:4px 0;color:#fdcb6e;font-size:calc(10px * var(--font-scale));font-weight:600;margin-top:8px;border-bottom:1px solid rgba(253,203,110,.3)">UNCATEGORIZED</div>';
            uncatStandalone.forEach(function(ing){
                var invItem=D.inv.find(function(x){return x.ingId===ing.id;});
                var onHand=invItem?invItem.qty:0;
                var diff=onHand-ing.minQty;
                var statusColor=diff>=0?'#00b894':diff>-3?'#fdcb6e':'#ff7675';
                var autoShopStatus=ing.autoShop?'<span style="color:#00b894" title="Auto-shop enabled">üõí</span>':'<span style="color:#636e72" title="Auto-shop disabled">‚óã</span>';
                html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)">';
                html+='<div style="flex:1"><span style="color:#e0e6ed;font-size:calc(13px * var(--font-scale))">'+ing.name+'</span> '+autoShopStatus+'</div>';
                html+='<div style="display:flex;gap:12px;align-items:center">';
                html+='<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">Min: '+ing.minQty+' '+ing.defUnit+'</span>';
                html+='<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">On Hand: '+onHand+'</span>';
                html+='<span style="color:'+statusColor+';font-size:calc(11px * var(--font-scale));font-weight:600;min-width:40px;text-align:right">'+(diff>=0?'+':'')+diff+'</span>';
                html+='<button class="btn btn-s btn-sm" onclick="editIng('+ing.id+')">‚úèÔ∏è</button>';
                html+='</div></div>';
            });
        }
        html+='</div>';
    }

    // Find ingredients not used in any recipe (exclude standalone items)
    var usedIngIds=[];
    D.recs.forEach(function(rec){
        if(rec.ings && rec.ings.length){
            rec.ings.forEach(function(ri){
                if(usedIngIds.indexOf(ri.ingId)===-1)usedIngIds.push(ri.ingId);
            });
        }
    });
    var unusedIngs=activeIngs.filter(function(i){return usedIngIds.indexOf(i.id)===-1 && !i.standalone;});

    // Unused ingredients section
    if(unusedIngs.length){
        html+='<div class="sec" style="color:#ff7675;margin-top:24px">‚ö†Ô∏è Not Used in Any Recipe ('+unusedIngs.length+')</div>';
        html+='<div style="background:rgba(255,118,117,.1);border:1px solid rgba(255,118,117,.2);border-radius:12px;padding:12px">';
        unusedIngs.forEach(function(ing){
            var cat=D.cats.find(function(c){return c.id===ing.catId;});
            var catName=cat?cat.name:'Uncategorized';
            html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)"><div><span style="color:#e0e6ed;font-size:calc(13px * var(--font-scale))">'+ing.name+'</span><span style="color:#636e72;font-size:calc(11px * var(--font-scale));margin-left:8px">'+catName+'</span></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editIng('+ing.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="deleteIngredient('+ing.id+')" title="Delete">üóëÔ∏è</button></div></div>';
        });
        html+='</div>';
    }
    
    // Archive section
    html+='<div class="archive-header" onclick="toggleArchive(\'ings\')"><span>üì• Archived ('+archivedIngs.length+')</span><span>'+(archiveOpen.ings?'‚ñ≤':'‚ñº')+'</span></div>';
    if(archiveOpen.ings&&archivedIngs.length){
        html+='<div style="margin-top:8px;opacity:.7">';
        archivedIngs.forEach(function(ing){
            html+='<div class="card" style="display:flex;justify-content:space-between;align-items:center;border-left:3px solid #636e72"><div><div class="card-t" style="color:#a0aec0">'+ing.name+'</div><div class="card-s">Default: '+ing.defUnit+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="reviveItem(\'ings\','+ing.id+')" title="Restore">üì§</button><button class="del-btn" onclick="delItem(\'ings\','+ing.id+')">üóëÔ∏è</button></div></div>';
        });
        html+='</div>';
    }
    
    c.innerHTML=html;
}

function deleteIngredient(id){
    id=Number(id); // Ensure id is a number
    console.log('deleteIngredient called with id:', id);
    
    var ing=D.ings.find(function(x){return Number(x.id)===id;});
    if(!ing){
        console.error('Ingredient not found:', id, 'Available IDs:', D.ings.map(function(i){return i.id;}));
        alert('Ingredient not found!');
        return;
    }
    
    console.log('Found ingredient:', ing.name);
    
    // Check if ingredient is used in any recipes
    var recipesUsingIng=[];
    D.recs.forEach(function(rec){
        if(rec.ings && rec.ings.length){
            var usesIng=rec.ings.some(function(ri){return Number(ri.ingId)===id;});
            if(usesIng)recipesUsingIng.push(rec.name);
        }
    });
    
    // Check if ingredient is used in any menu items
    var menusUsingIng=[];
    D.menus.forEach(function(menu){
        if(menu.ings && menu.ings.length){
            var usesIng=menu.ings.some(function(mi){return Number(mi.ingId)===id;});
            if(usesIng)menusUsingIng.push(menu.name);
        }
    });
    
    // Build warning message
    var warningMsg='';
    if(recipesUsingIng.length>0){
        warningMsg+='‚ö†Ô∏è This ingredient is used in '+recipesUsingIng.length+' recipe(s):\n‚Ä¢ '+recipesUsingIng.slice(0,5).join('\n‚Ä¢ ');
        if(recipesUsingIng.length>5)warningMsg+='\n‚Ä¢ ...and '+(recipesUsingIng.length-5)+' more';
        warningMsg+='\n\n';
    }
    if(menusUsingIng.length>0){
        warningMsg+='‚ö†Ô∏è This ingredient is used in '+menusUsingIng.length+' menu item(s):\n‚Ä¢ '+menusUsingIng.slice(0,5).join('\n‚Ä¢ ');
        if(menusUsingIng.length>5)warningMsg+='\n‚Ä¢ ...and '+(menusUsingIng.length-5)+' more';
        warningMsg+='\n\n';
    }
    
    warningMsg+='Are you sure you want to permanently delete "'+ing.name+'"?';
    if(recipesUsingIng.length>0||menusUsingIng.length>0){
        warningMsg+='\n\nThis will remove it from all recipes and menu items.';
    }
    
    if(!confirm(warningMsg))return;
    
    console.log('User confirmed deletion of:', ing.name);
    var ingName=ing.name;
    
    saveState('Delete ingredient: '+ingName);
    
    // Remove from recipes
    D.recs.forEach(function(rec){
        if(rec.ings){
            rec.ings=rec.ings.filter(function(ri){return Number(ri.ingId)!==id;});
        }
    });
    
    // Remove from menu items
    D.menus.forEach(function(menu){
        if(menu.ings){
            menu.ings=menu.ings.filter(function(mi){return Number(mi.ingId)!==id;});
        }
    });
    
    // Remove from inventory
    D.inv=D.inv.filter(function(i){return Number(i.ingId)!==id;});
    
    // Remove from shopping list
    D.shopping=D.shopping.filter(function(s){return Number(s.ingId)!==id;});
    
    // Remove the ingredient itself
    var beforeCount=D.ings.length;
    D.ings=D.ings.filter(function(i){return Number(i.id)!==id;});
    console.log('Ingredients: '+beforeCount+' -> '+D.ings.length);

    // Delete from Supabase if connected
    if(supabase && currentAuthUser){
        console.log('Deleting from Supabase...');
        supabase.from('ings').delete().eq('id', id).then(function(res){
            console.log('Supabase ings delete result:', res);
        });
        supabase.from('inv').delete().eq('ing_id', id).then(function(res){
            console.log('Supabase inv delete result:', res);
        });
        supabase.from('shopping').delete().eq('ing_id', id).then(function(res){
            console.log('Supabase shopping delete result:', res);
        });
    }
    
    render();
}

function filterIngredients(term){
    ingSearchTerm = term;
    render();
    // Refocus search input and restore cursor position
    setTimeout(function(){
        var input = document.getElementById('ing-search');
        if(input){
            input.focus();
            input.setSelectionRange(term.length, term.length);
        }
    }, 0);
}

function editIng(id){
    var ing=D.ings.find(function(x){return x.id===id;});
    if(!ing)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit '+ing.name+'</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="edit-name" class="form-i" value="'+ing.name+'"></div>';
    html+='<div class="form-g"><label class="form-l">Category</label><select id="edit-cat" class="form-i">';
    D.cats.forEach(function(cat){html+='<option value="'+cat.id+'"'+(cat.id===ing.catId?' selected':'')+'>'+cat.name+'</option>';});
    html+='</select></div>';
    html+='<div class="form-g"><label class="form-l">Default Storage</label><select id="edit-area" class="form-i" onchange="updateEditSubArea()">';
    html+='<option value="">No default</option>';
    D.areas.forEach(function(a){html+='<option value="'+a.id+'"'+(a.id===ing.areaId?' selected':'')+'>'+a.name+'</option>';});
    html+='</select></div>';
    html+='<div class="form-g" id="edit-sub-wrap"><label class="form-l">Section</label><select id="edit-sub" class="form-i"><option value="">Main Area</option></select></div>';
    html+='<div class="form-g"><label class="form-l">Default Unit</label><select id="edit-unit" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'"'+(u.abbr===ing.defUnit?' selected':'')+'>'+u.name+' ('+u.abbr+')</option>';});
    html+='</select></div>';
    html+='<div class="form-g" style="padding:12px;background:rgba(253,203,110,.1);border-radius:8px;border:1px solid rgba(253,203,110,.3)"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="edit-standalone"'+(ing.standalone?' checked':'')+' onchange="toggleStandaloneFields()"><span style="font-size:calc(12px * var(--font-scale));color:#fdcb6e;font-weight:600">‚≠ê Standalone Item</span></label><div class="card-s" style="margin-top:4px">Track this item independently with its own minimum quantity</div></div>';
    html+='<div class="form-g" id="min-qty-wrap" style="display:'+(ing.standalone?'block':'none')+'"><label class="form-l">Minimum Required Quantity</label><input type="number" id="edit-minqty" class="form-i" value="'+(ing.minQty||0)+'" placeholder="0"></div>';
    html+='<div class="form-g" id="auto-shop-wrap" style="display:'+(ing.standalone?'block':'none')+'"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="edit-autoshop"'+(ing.autoShop?' checked':'')+'><span style="font-size:calc(11px * var(--font-scale));color:#00b894">üõí Auto-add to Shopping List when below minimum</span></label></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveIng('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    updateEditSubArea();
}

function toggleStandaloneFields(){
    var cb=document.getElementById('edit-standalone');
    var minWrap=document.getElementById('min-qty-wrap');
    var autoShopWrap=document.getElementById('auto-shop-wrap');
    minWrap.style.display=cb.checked?'block':'none';
    if(autoShopWrap) autoShopWrap.style.display=cb.checked?'block':'none';
}

function updateEditSubArea(){
    var areaId=+document.getElementById('edit-area').value;
    var area=D.areas.find(function(a){return a.id===areaId;});
    var wrap=document.getElementById('edit-sub-wrap');
    var sel=document.getElementById('edit-sub');
    if(area&&area.sections.length){
        wrap.style.display='block';
        sel.innerHTML='<option value="">Main Area</option>';
        area.sections.forEach(function(sec){sel.innerHTML+='<option value="'+sec+'">'+sec+'</option>';});
    }else{
        wrap.style.display='none';
    }
}

function saveIng(id){
    var ing=D.ings.find(function(x){return x.id===id;});
    if(!ing)return;
    saveState('Edit ingredient');
    ing.name=document.getElementById('edit-name').value;
    ing.catId=+document.getElementById('edit-cat').value;
    ing.areaId=+document.getElementById('edit-area').value||0;
    ing.subArea=document.getElementById('edit-sub').value;
    ing.defUnit=document.getElementById('edit-unit').value;
    ing.standalone=document.getElementById('edit-standalone').checked?1:0;
    ing.minQty=+document.getElementById('edit-minqty').value||0;
    ing.autoShop=document.getElementById('edit-autoshop').checked?1:0;
    closeModal();
    render();
}

// ==================== RECIPES ====================
function renderRecs(c,s){
    var activeRecs=D.recs.filter(function(r){return !r.archived;});
    var archivedRecs=D.recs.filter(function(r){return r.archived;});
    s.textContent=activeRecs.length+' recipes';
    var html='';
    
    // Group by recipe category
    var recCats = D.recCats || [];
    recCats.forEach(function(cat){
        var catRecs=activeRecs.filter(function(r){return r.catId===cat.id;});
        if(!catRecs.length)return;
        
        html+='<div class="sec" style="color:#fdcb6e">'+cat.name+' ('+catRecs.length+')</div>';
        catRecs.forEach(function(rec){
            var isExp=exp['rec-'+rec.id];
            var outputDisplay = getRecipeOutputDisplay(rec);
            var yieldInfo = rec.outputMode === 'manual' ? '(manual)' : '('+rec.yield+'% yield)';
            html+='<div class="card"><div class="card-h" onclick="tog(\'rec-'+rec.id+'\')" style="cursor:pointer"><div><div class="card-t">'+rec.name+'</div><div class="card-s">'+rec.group+' ‚Ä¢ <span style="color:#00b894">Produces: '+outputDisplay+'</span> <span style="color:#a0aec0">'+yieldInfo+'</span></div></div><span style="color:#a0aec0">'+(isExp?'‚ñ≤':'‚ñº')+'</span></div>';
            
            if(isExp){
                html+='<div style="margin-top:12px">';
                // Ingredients
                html+='<div class="sec ing" style="font-size:calc(11px * var(--font-scale))">Ingredients</div>';
                if(rec.ings&&rec.ings.length){
                    rec.ings.forEach(function(ri,idx){
                        html+='<div class="rec-ing"><span class="rec-ing-name">'+getIngName(ri.ingId)+'</span><div style="display:flex;align-items:center;gap:4px"><input type="number" value="'+ri.qty+'" onchange="updRecIng('+rec.id+','+idx+',this.value)" style="width:50px;padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#e0e6ed;text-align:center;font-size:calc(11px * var(--font-scale))"><select onchange="updRecIngUnit('+rec.id+','+idx+',this.value)" style="padding:4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#a0aec0;font-size:calc(10px * var(--font-scale))">';
                        getSortedUnits().forEach(function(u){
                            html+='<option value="'+u.abbr+'"'+(u.abbr===ri.unit?' selected':'')+'>'+u.abbr+'</option>';
                        });
                        html+='</select><button class="del-btn" onclick="delRecIng('+rec.id+','+idx+')">√ó</button></div></div>';
                    });
                }
                html+='<button class="btn btn-s btn-sm" onclick="addRecIng('+rec.id+')" style="margin-top:4px">+ Add Ingredient</button>';
                
                // Sub-recipes
                if(rec.subRecs&&rec.subRecs.length){
                    html+='<div class="sec" style="font-size:calc(11px * var(--font-scale));color:#fdcb6e;margin-top:12px">Sub-Recipes (√ó'+rec.subRecs[0].qty+' servings)</div>';
                    rec.subRecs.forEach(function(sr,idx){
                        var subRec=D.recs.find(function(r){return r.id===sr.recId;});
                        html+='<div class="rec-ing" style="border-left:2px solid #fdcb6e"><span class="rec-ing-name">üìñ '+getRecName(sr.recId)+' √ó'+sr.qty+'</span><button class="del-btn" onclick="delRecSubRec('+rec.id+','+idx+')">√ó</button></div>';
                        // Show expanded ingredients from sub-recipe with edit link
                        if(subRec&&subRec.ings&&subRec.ings.length){
                            html+='<div style="margin-left:16px;border-left:1px solid rgba(253,203,110,.3);padding-left:8px">';
                            subRec.ings.forEach(function(ing){
                                var scaledQty=(ing.qty*sr.qty).toFixed(2).replace(/\.?0+$/,'');
                                html+='<div style="font-size:calc(10px * var(--font-scale));color:#a0aec0;padding:2px 0">‚Ä¢ '+getIngName(ing.ingId)+': <b style="color:#fdcb6e">'+scaledQty+' '+ing.unit+'</b></div>';
                            });
                            html+='<button class="btn btn-s btn-sm" onclick="tog(\'rec-'+subRec.id+'\');scrollToRec('+subRec.id+')" style="margin-top:4px;font-size:calc(9px * var(--font-scale))">‚úèÔ∏è Edit '+subRec.name+' ingredients</button>';
                            html+='</div>';
                        }
                    });
                }
                html+='<button class="btn btn-s btn-sm" onclick="addRecSubRec('+rec.id+')" style="margin-top:4px">+ Add Sub-Recipe</button>';
                
                // Notes
                if(rec.notes){
                    html+='<div class="sec" style="font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-top:12px">Notes</div><p style="font-size:calc(11px * var(--font-scale));color:#a0aec0;padding:8px;background:rgba(0,0,0,.2);border-radius:6px">'+rec.notes+'</p>';
                }
                
                html+='<div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-s btn-sm" onclick="editRec('+rec.id+')" style="flex:1">‚úèÔ∏è Edit</button><button class="btn btn-s btn-sm" onclick="archiveItem(\'recs\','+rec.id+')">üì• Archive</button><button class="del-btn" onclick="deleteRecipe('+rec.id+')" title="Delete">üóëÔ∏è</button></div>';
                html+='</div>';
            }
            html+='</div>';
        });
    });
    
    // Uncategorized
    var uncatRecs=activeRecs.filter(function(r){return !r.catId;});
    if(uncatRecs.length){
        html+='<div class="sec" style="color:#636e72">Uncategorized ('+uncatRecs.length+')</div>';
        uncatRecs.forEach(function(rec){
            html+='<div class="card"><div class="card-t">'+rec.name+'</div><div class="card-s">'+rec.group+'</div></div>';
        });
    }
    
    // Archive
    html+='<div class="archive-header" onclick="toggleArchive(\'recs\')"><span>üì• Archived ('+archivedRecs.length+')</span><span>'+(archiveOpen.recs?'‚ñ≤':'‚ñº')+'</span></div>';
    if(archiveOpen.recs&&archivedRecs.length){
        html+='<div style="margin-top:8px;opacity:.7">';
        archivedRecs.forEach(function(rec){
            html+='<div class="card" style="border-left:3px solid #636e72"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t" style="color:#a0aec0">'+rec.name+'</div><div class="card-s">'+rec.group+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="reviveItem(\'recs\','+rec.id+')">üì§</button><button class="del-btn" onclick="delItem(\'recs\','+rec.id+')">üóëÔ∏è</button></div></div></div>';
        });
        html+='</div>';
    }
    
    c.innerHTML=html;
}

function updRecIng(recId,idx,val){
    var rec=D.recs.find(function(r){return r.id===recId;});
    if(rec&&rec.ings[idx]){
        saveState('Update recipe qty');
        rec.ings[idx].qty=+val||0;
        render();
    }
}

function updRecIngUnit(recId,idx,unit){
    var rec=D.recs.find(function(r){return r.id===recId;});
    if(rec&&rec.ings[idx]){
        saveState('Update recipe ingredient unit');
        rec.ings[idx].unit=unit;
        render();
    }
}

function delRecIng(recId,idx){
    var rec=D.recs.find(function(r){return r.id===recId;});
    if(rec){
        saveState('Remove recipe ingredient');
        rec.ings.splice(idx,1);
        render();
    }
}

function scrollToRec(recId){
    setTimeout(function(){
        var el=document.querySelector('[onclick*="tog(\'rec-'+recId+'\')"]');
        if(el){
            el.scrollIntoView({behavior:'smooth',block:'center'});
        }
    },100);
}

function delRecSubRec(recId,idx){
    var rec=D.recs.find(function(r){return r.id===recId;});
    if(rec&&rec.subRecs){
        saveState('Remove sub-recipe');
        rec.subRecs.splice(idx,1);
        render();
    }
}

var recIngSearchSelected = null;

function addRecIng(recId){
    recIngSearchSelected = null;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Ingredient to Recipe</div>';
    html+='<div class="form-g"><label class="form-l">Ingredient</label>';
    html+='<input type="text" id="rec-ing-search" class="form-i" placeholder="üîç Search ingredients..." oninput="filterRecIngSearch(this.value)" autocomplete="off">';
    html+='<input type="hidden" id="new-ri-ing" value="">';
    html+='<div id="rec-ing-results" style="max-height:200px;overflow-y:auto;margin-top:8px"></div>';
    html+='</div>';
    html+='<div class="form-g"><label class="form-l">Quantity</label><input type="number" id="new-ri-qty" class="form-i" placeholder="0"></div>';
    html+='<div class="form-g"><label class="form-l">Unit</label><select id="new-ri-unit" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveRecIng('+recId+')" style="flex:1">Add</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    document.getElementById('rec-ing-search').focus();
    filterRecIngSearch('');
}

function filterRecIngSearch(term){
    var resultsDiv = document.getElementById('rec-ing-results');
    var searchLower = term.toLowerCase();
    var activeIngs = D.ings.filter(function(i){return !i.archived;});

    if(term){
        activeIngs = activeIngs.filter(function(i){return i.name.toLowerCase().indexOf(searchLower) !== -1;});
    }

    var html = '';
    if(activeIngs.length === 0){
        html = '<div style="padding:8px;color:#888;font-style:italic">No ingredients found</div>';
    } else {
        // Group by category
        D.cats.forEach(function(cat){
            var catIngs = activeIngs.filter(function(i){return i.catId === cat.id;});
            if(catIngs.length){
                html += '<div style="padding:6px 10px;color:#a29bfe;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3)">‚îÄ‚îÄ '+cat.name.toUpperCase()+' ‚îÄ‚îÄ</div>';
                catIngs.forEach(function(ing){
                    var selected = recIngSearchSelected === ing.id ? 'background:var(--accent);color:#fff;' : '';
                    html += '<div class="search-result-item" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.1);'+selected+'" onclick="selectRecIng('+ing.id+',\''+ing.name.replace(/'/g,"\\'")+'\',\''+ing.defUnit+'\')">'+ing.name+'</div>';
                });
            }
        });
        var uncatIngs = activeIngs.filter(function(i){return !i.catId;});
        if(uncatIngs.length){
            html += '<div style="padding:6px 10px;color:#a29bfe;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3)">‚îÄ‚îÄ OTHER ‚îÄ‚îÄ</div>';
            uncatIngs.forEach(function(ing){
                var selected = recIngSearchSelected === ing.id ? 'background:var(--accent);color:#fff;' : '';
                html += '<div class="search-result-item" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.1);'+selected+'" onclick="selectRecIng('+ing.id+',\''+ing.name.replace(/'/g,"\\'")+'\',\''+ing.defUnit+'\')">'+ing.name+'</div>';
            });
        }
    }
    resultsDiv.innerHTML = html;
}

function selectRecIng(ingId, ingName, defUnit){
    recIngSearchSelected = ingId;
    document.getElementById('new-ri-ing').value = ingId;
    document.getElementById('rec-ing-search').value = ingName;
    document.getElementById('rec-ing-results').innerHTML = '<div style="padding:8px;color:#6c5ce7">‚úì Selected: <strong>'+ingName+'</strong></div>';
    // Set default unit
    var unitSelect = document.getElementById('new-ri-unit');
    if(defUnit){
        for(var i=0; i<unitSelect.options.length; i++){
            if(unitSelect.options[i].value === defUnit){
                unitSelect.selectedIndex = i;
                break;
            }
        }
    }
    document.getElementById('new-ri-qty').focus();
}

function saveRecIng(recId){
    var rec=D.recs.find(function(r){return r.id===recId;});
    if(!rec)return;
    if(!rec.ings)rec.ings=[];
    saveState('Add recipe ingredient');
    rec.ings.push({
        ingId:+document.getElementById('new-ri-ing').value,
        qty:+document.getElementById('new-ri-qty').value||0,
        unit:document.getElementById('new-ri-unit').value
    });
    closeModal();
    render();
}

function addRecSubRec(recId){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Sub-Recipe</div>';
    html+='<div class="form-g"><label class="form-l">Recipe</label><select id="new-sr-rec" class="form-i">';
    D.recs.filter(function(r){return !r.archived&&r.id!==recId;}).forEach(function(r){html+='<option value="'+r.id+'">'+r.name+'</option>';});
    html+='</select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveRecSubRec('+recId+')" style="flex:1">Add</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveRecSubRec(recId){
    var rec=D.recs.find(function(r){return r.id===recId;});
    if(!rec)return;
    if(!rec.subRecs)rec.subRecs=[];
    saveState('Add sub-recipe');
    rec.subRecs.push({recId:+document.getElementById('new-sr-rec').value});
    closeModal();
    render();
}

function deleteRecipe(id){
    id=Number(id);
    var rec=D.recs.find(function(r){return Number(r.id)===id;});
    if(!rec){
        console.error('Recipe not found:', id);
        alert('Recipe not found!');
        return;
    }
    
    // Check if recipe is used in any menu items (new recs structure)
    var menusUsingRec=[];
    D.menus.forEach(function(menu){
        // Check new recs array
        if(menu.recs && menu.recs.length){
            var usesRec=menu.recs.some(function(mr){return Number(mr.recId)===id;});
            if(usesRec)menusUsingRec.push(menu.name);
        }
        // Check legacy recIds array
        if(menu.recIds && menu.recIds.length){
            var usesRecLegacy=menu.recIds.some(function(rid){return Number(rid)===id;});
            if(usesRecLegacy && menusUsingRec.indexOf(menu.name)===-1)menusUsingRec.push(menu.name);
        }
    });
    
    // Check if recipe is used as sub-recipe in other recipes
    var recipesUsingAsSubRec=[];
    D.recs.forEach(function(r){
        if(r.subRecs && r.subRecs.length){
            var usesRec=r.subRecs.some(function(sr){return Number(sr.recId)===id;});
            if(usesRec)recipesUsingAsSubRec.push(r.name);
        }
    });
    
    // Build warning message
    var warningMsg='';
    if(menusUsingRec.length>0){
        warningMsg+='‚ö†Ô∏è This recipe is used in '+menusUsingRec.length+' menu item(s):\n‚Ä¢ '+menusUsingRec.slice(0,5).join('\n‚Ä¢ ');
        if(menusUsingRec.length>5)warningMsg+='\n‚Ä¢ ...and '+(menusUsingRec.length-5)+' more';
        warningMsg+='\n\n';
    }
    if(recipesUsingAsSubRec.length>0){
        warningMsg+='‚ö†Ô∏è This recipe is used as a sub-recipe in '+recipesUsingAsSubRec.length+' recipe(s):\n‚Ä¢ '+recipesUsingAsSubRec.slice(0,5).join('\n‚Ä¢ ');
        if(recipesUsingAsSubRec.length>5)warningMsg+='\n‚Ä¢ ...and '+(recipesUsingAsSubRec.length-5)+' more';
        warningMsg+='\n\n';
    }
    
    warningMsg+='Are you sure you want to permanently delete "'+rec.name+'"?';
    if(menusUsingRec.length>0||recipesUsingAsSubRec.length>0){
        warningMsg+='\n\nThis will remove it from all menu items and recipes.';
    }
    
    if(!confirm(warningMsg))return;
    
    var recName=rec.name;
    saveState('Delete recipe: '+recName);
    
    // Remove from menu items that use this recipe (new recs structure)
    D.menus.forEach(function(menu){
        if(menu.recs){
            menu.recs=menu.recs.filter(function(mr){return Number(mr.recId)!==id;});
        }
        // Also remove from legacy recIds
        if(menu.recIds){
            menu.recIds=menu.recIds.filter(function(rid){return Number(rid)!==id;});
        }
    });
    
    // Remove from other recipes that use this as sub-recipe
    D.recs.forEach(function(r){
        if(r.subRecs){
            r.subRecs=r.subRecs.filter(function(sr){return Number(sr.recId)!==id;});
        }
    });
    
    // Remove the recipe itself
    D.recs=D.recs.filter(function(r){return Number(r.id)!==id;});

    // Delete from Supabase if connected
    if(supabase && currentAuthUser){
        supabase.from('recs').delete().eq('id', id).then(function(res){
            console.log('Supabase recs delete result:', res);
        });
    }
    
    render();
}

function editRec(id){
    var rec=D.recs.find(function(r){return r.id===id;});
    if(!rec)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var output = calcRecipeOutput(rec);
    var isManual = rec.outputMode === 'manual';
    var html='<div class="modal-t">Edit '+rec.name+'</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-rec-name" class="form-i" value="'+rec.name+'"></div>';
    html+='<div class="form-g"><label class="form-l">Group</label><input type="text" id="ed-rec-group" class="form-i" value="'+rec.group+'"></div>';
    html+='<div class="form-g"><label class="form-l">Category</label><select id="ed-rec-cat" class="form-i"><option value="">Uncategorized</option>';
    if(D.recCats){ D.recCats.forEach(function(cat){html+='<option value="'+cat.id+'"'+(cat.id===rec.catId?' selected':'')+'>'+cat.name+'</option>';}); }
    html+='</select></div>';
    
    // Output Mode Toggle
    html+='<div class="form-g"><label class="form-l">Output Mode</label><div style="display:flex;gap:4px">';
    html+='<button type="button" id="btn-mode-auto" class="btn btn-sm '+(isManual?'btn-s':'btn-p')+'" onclick="toggleOutputMode(\'auto\')" style="flex:1;padding:8px">üîÑ Yield Calc</button>';
    html+='<button type="button" id="btn-mode-manual" class="btn btn-sm '+(isManual?'btn-p':'btn-s')+'" onclick="toggleOutputMode(\'manual\')" style="flex:1;padding:8px">‚úèÔ∏è Manual</button>';
    html+='</div></div>';
    
    // Yield % row (for auto mode)
    html+='<div id="yield-row" style="display:'+(isManual?'none':'flex')+';gap:8px">';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Yield %</label><input type="number" id="ed-rec-yield" class="form-i" value="'+rec.yield+'" min="1" max="100"></div>';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Output Unit</label><select id="ed-rec-yieldunit" class="form-i">';
    html+='<option value=""'+((!rec.yieldUnit)?' selected':'')+'>Auto ('+output.unit+')</option>';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'"'+(rec.yieldUnit===u.abbr?' selected':'')+'>'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';
    
    // Manual qty row (for manual mode)
    html+='<div id="manual-row" style="display:'+(isManual?'flex':'none')+';gap:8px">';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Output Quantity</label><input type="number" id="ed-rec-manualqty" class="form-i" value="'+(rec.manualQty||'')+'" step="0.1" placeholder="e.g. 100" oninput="updateOutputDisplay()"></div>';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Output Unit</label><select id="ed-rec-manualunit" class="form-i" onchange="updateOutputDisplay()">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'"'+((rec.yieldUnit===u.abbr||(isManual && !rec.yieldUnit && u.abbr==='ea'))?' selected':'')+'>'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';
    
    // Output display - shows current production output based on mode
    var displayQty = isManual ? (rec.manualQty || 0) : output.qty;
    var displayUnit = rec.yieldUnit || (isManual ? 'ea' : output.unit);
    html+='<div id="output-display" style="padding:10px;background:rgba(0,184,148,.1);border-radius:8px;margin-bottom:12px"><div style="font-size:calc(11px * var(--font-scale));color:#a0aec0">Production Output:</div><div id="output-value" style="font-size:calc(16px * var(--font-scale));color:#00b894;font-weight:600">'+displayQty+' '+displayUnit+'</div></div>';
    
    html+='<div class="form-g"><label class="form-l">Shelf Life</label><input type="text" id="ed-rec-shelf" class="form-i" value="'+rec.shelfLife+'"></div>';
    html+='<div class="form-g"><label class="form-l">Notes</label><textarea id="ed-rec-notes" class="form-i" rows="3">'+rec.notes+'</textarea></div>';
    // Include in Prep checkbox (default checked)
    var prepChecked = rec.includeInPrep === undefined ? true : rec.includeInPrep;
    html+='<div class="form-g" style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(0,184,148,.1);border-radius:8px"><input type="checkbox" id="ed-rec-prep" '+(prepChecked?'checked':'')+'><label for="ed-rec-prep" style="font-size:calc(13px * var(--font-scale));color:#e0e6ed;cursor:pointer">üç≥ Include in Prep calculations</label></div>';
    html+='<input type="hidden" id="ed-rec-outputmode" value="'+(rec.outputMode||'auto')+'">';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveRecEdit('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function toggleOutputMode(mode){
    var isManual = mode === 'manual';
    document.getElementById('ed-rec-outputmode').value = mode;
    document.getElementById('btn-mode-auto').className = 'btn btn-sm ' + (isManual ? 'btn-s' : 'btn-p');
    document.getElementById('btn-mode-manual').className = 'btn btn-sm ' + (isManual ? 'btn-p' : 'btn-s');
    document.getElementById('yield-row').style.display = isManual ? 'none' : 'flex';
    document.getElementById('manual-row').style.display = isManual ? 'flex' : 'none';

    // Update output display value based on mode
    updateOutputDisplay();
}

function updateOutputDisplay(){
    var isManual = document.getElementById('ed-rec-outputmode').value === 'manual';
    var outputValue = document.getElementById('output-value');
    if(!outputValue) return;

    if(isManual){
        var qty = document.getElementById('ed-rec-manualqty').value || 0;
        var unit = document.getElementById('ed-rec-manualunit').value || 'ea';
        outputValue.textContent = qty + ' ' + unit;
    } else {
        var yieldPct = document.getElementById('ed-rec-yield').value || 98;
        var unit = document.getElementById('ed-rec-yieldunit').value || '';
        // Note: We'd need the recipe's ingredient totals to recalculate, so just show a placeholder
        // The actual value will be correct when saved and re-opened
        outputValue.textContent = '(save to recalculate)';
    }
}

function saveRecEdit(id){
    var rec=D.recs.find(function(r){return r.id===id;});
    if(!rec)return;
    saveState('Edit recipe');
    rec.name=document.getElementById('ed-rec-name').value;
    rec.group=document.getElementById('ed-rec-group').value;
    rec.catId=+document.getElementById('ed-rec-cat').value||0;
    rec.outputMode=document.getElementById('ed-rec-outputmode').value||'auto';
    
    if(rec.outputMode === 'manual'){
        rec.manualQty=+document.getElementById('ed-rec-manualqty').value||0;
        rec.yieldUnit=document.getElementById('ed-rec-manualunit').value||'ea';
    } else {
        rec.yield=+document.getElementById('ed-rec-yield').value||98;
        rec.yieldUnit=document.getElementById('ed-rec-yieldunit').value||'';
    }
    
    rec.shelfLife=document.getElementById('ed-rec-shelf').value;
    rec.notes=document.getElementById('ed-rec-notes').value;
    rec.includeInPrep=document.getElementById('ed-rec-prep').checked?1:0;
    closeModal();
    render();
}

// ==================== MENU ====================
function renderMenu(c,s){
    var activeMenus=D.menus.filter(function(m){return !m.archived;});
    var archivedMenus=D.menus.filter(function(m){return m.archived;});
    s.textContent=activeMenus.length+' menu items';
    var html='';
    
    D.menuCats.forEach(function(cat){
        var catItems=activeMenus.filter(function(m){return m.catId===cat.id;});
        if(!catItems.length)return;
        
        html+='<div class="sec menu">'+cat.name+' ('+catItems.length+')</div>';
        catItems.forEach(function(m){
            var isExp=exp['menu-'+m.id];
            var shopIcon=m.includeInShop?'<span style="color:#00b894;font-size:calc(10px * var(--font-scale));margin-left:6px" title="Included in Shopping">üõí</span>':'<span style="color:#636e72;font-size:calc(10px * var(--font-scale));margin-left:6px" title="Not in Shopping">‚óã</span>';
            html+='<div class="card"><div class="card-h" onclick="tog(\'menu-'+m.id+'\')" style="cursor:pointer"><div><div class="card-t">'+m.name+shopIcon+'</div><div class="card-s">Target: '+m.tgt+'</div></div><span style="color:#a0aec0">'+(isExp?'‚ñ≤':'‚ñº')+'</span></div>';
            
            if(isExp){
                html+='<div style="margin-top:12px">';
                
                // Direct ingredients
                html+='<div style="display:flex;justify-content:space-between;align-items:center"><div class="sec ing" style="margin:0;font-size:calc(11px * var(--font-scale))">Ingredients</div><button class="btn btn-s btn-sm" onclick="addMenuIng('+m.id+')" style="padding:4px 8px;font-size:calc(10px * var(--font-scale))">+ Add</button></div>';
                if(m.ings&&m.ings.length){
                    m.ings.forEach(function(mi,idx){
                        html+='<div class="recipe-comp ing"><span class="rec-ing-name">ü•¨ '+getIngName(mi.ingId)+': '+mi.qty+' '+mi.unit+'</span><button class="del-btn" onclick="delMenuIng('+m.id+','+idx+')">√ó</button></div>';
                    });
                }

                // Recipes
                html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><div class="sec" style="margin:0;font-size:calc(11px * var(--font-scale));color:#fdcb6e">Recipes</div><button class="btn btn-s btn-sm" onclick="addMenuRec('+m.id+')" style="padding:4px 8px;font-size:calc(10px * var(--font-scale))">+ Add</button></div>';
                if(m.recs&&m.recs.length){
                    m.recs.forEach(function(mr,idx){
                        var r=D.recs.find(function(x){return x.id===mr.recId;});
                        if(r){
                            html+='<div class="recipe-comp rec"><span class="rec-ing-name">üìñ '+r.name+': '+mr.qty+' '+mr.unit+'</span><button class="del-btn" onclick="delMenuRec('+m.id+','+idx+')">√ó</button></div>';
                        }
                    });
                }
                
                html+='<div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-s btn-sm" onclick="editMenuItem('+m.id+')" style="flex:1">‚úèÔ∏è Edit</button><button class="btn btn-s btn-sm" onclick="archiveItem(\'menus\','+m.id+')">üì• Archive</button></div>';
                html+='</div>';
            }
            html+='</div>';
        });
    });
    
    // Archive
    html+='<div class="archive-header" onclick="toggleArchive(\'menus\')"><span>üì• Archived ('+archivedMenus.length+')</span><span>'+(archiveOpen.menus?'‚ñ≤':'‚ñº')+'</span></div>';
    if(archiveOpen.menus&&archivedMenus.length){
        html+='<div style="margin-top:8px;opacity:.7">';
        archivedMenus.forEach(function(m){
            html+='<div class="card" style="border-left:3px solid #636e72"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t" style="color:#a0aec0">'+m.name+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="reviveItem(\'menus\','+m.id+')">üì§</button><button class="del-btn" onclick="delItem(\'menus\','+m.id+')">üóëÔ∏è</button></div></div></div>';
        });
        html+='</div>';
    }
    
    c.innerHTML=html;
}

var menuIngSearchSelected = null;

function addMenuIng(menuId){
    menuIngSearchSelected = null;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Ingredient to Menu Item</div>';
    html+='<div class="form-g"><label class="form-l">Ingredient</label>';
    html+='<input type="text" id="menu-ing-search" class="form-i" placeholder="üîç Search ingredients..." oninput="filterMenuIngSearch(this.value)" autocomplete="off">';
    html+='<input type="hidden" id="new-mi-ing" value="">';
    html+='<div id="menu-ing-results" style="max-height:200px;overflow-y:auto;margin-top:8px"></div>';
    html+='</div>';
    html+='<div class="form-g"><label class="form-l">Quantity</label><input type="number" id="new-mi-qty" class="form-i" placeholder="0"></div>';
    html+='<div class="form-g"><label class="form-l">Unit</label><select id="new-mi-unit" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveMenuIng('+menuId+')" style="flex:1">Add</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    document.getElementById('menu-ing-search').focus();
    filterMenuIngSearch('');
}

function filterMenuIngSearch(term){
    var resultsDiv = document.getElementById('menu-ing-results');
    var searchLower = term.toLowerCase();
    var activeIngs = D.ings.filter(function(i){return !i.archived;});

    if(term){
        activeIngs = activeIngs.filter(function(i){return i.name.toLowerCase().indexOf(searchLower) !== -1;});
    }

    var html = '';
    if(activeIngs.length === 0){
        html = '<div style="padding:8px;color:#888;font-style:italic">No ingredients found</div>';
    } else {
        D.cats.forEach(function(cat){
            var catIngs = activeIngs.filter(function(i){return i.catId === cat.id;});
            if(catIngs.length){
                html += '<div style="padding:6px 10px;color:#a29bfe;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3)">‚îÄ‚îÄ '+cat.name.toUpperCase()+' ‚îÄ‚îÄ</div>';
                catIngs.forEach(function(ing){
                    var selected = menuIngSearchSelected === ing.id ? 'background:var(--accent);color:#fff;' : '';
                    html += '<div class="search-result-item" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.1);'+selected+'" onclick="selectMenuIng('+ing.id+',\''+ing.name.replace(/'/g,"\\'")+'\',\''+ing.defUnit+'\')">'+ing.name+'</div>';
                });
            }
        });
        var uncatIngs = activeIngs.filter(function(i){return !i.catId;});
        if(uncatIngs.length){
            html += '<div style="padding:6px 10px;color:#a29bfe;font-weight:700;font-size:calc(10px * var(--font-scale));background:rgba(0,0,0,.3)">‚îÄ‚îÄ OTHER ‚îÄ‚îÄ</div>';
            uncatIngs.forEach(function(ing){
                var selected = menuIngSearchSelected === ing.id ? 'background:var(--accent);color:#fff;' : '';
                html += '<div class="search-result-item" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.1);'+selected+'" onclick="selectMenuIng('+ing.id+',\''+ing.name.replace(/'/g,"\\'")+'\',\''+ing.defUnit+'\')">'+ing.name+'</div>';
            });
        }
    }
    resultsDiv.innerHTML = html;
}

function selectMenuIng(ingId, ingName, defUnit){
    menuIngSearchSelected = ingId;
    document.getElementById('new-mi-ing').value = ingId;
    document.getElementById('menu-ing-search').value = ingName;
    document.getElementById('menu-ing-results').innerHTML = '<div style="padding:8px;color:#6c5ce7">‚úì Selected: <strong>'+ingName+'</strong></div>';
    var unitSelect = document.getElementById('new-mi-unit');
    if(defUnit){
        for(var i=0; i<unitSelect.options.length; i++){
            if(unitSelect.options[i].value === defUnit){
                unitSelect.selectedIndex = i;
                break;
            }
        }
    }
    document.getElementById('new-mi-qty').focus();
}

function saveMenuIng(menuId){
    var menu=D.menus.find(function(m){return m.id===menuId;});
    if(!menu)return;
    if(!menu.ings)menu.ings=[];
    saveState('Add menu ingredient');
    menu.ings.push({
        ingId:+document.getElementById('new-mi-ing').value,
        qty:+document.getElementById('new-mi-qty').value||0,
        unit:document.getElementById('new-mi-unit').value
    });
    closeModal();
    render();
}

function delMenuIng(menuId,idx){
    var menu=D.menus.find(function(m){return m.id===menuId;});
    if(menu&&menu.ings){saveState('Remove menu ingredient');menu.ings.splice(idx,1);render();}
}

function addMenuPrep(menuId){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Prep Item to Menu Item</div>';
    html+='<div class="form-g"><label class="form-l">Prep Item</label><select id="new-mp-prep" class="form-i">';
    D.preps.forEach(function(p){html+='<option value="'+p.id+'" data-unit="'+p.unit+'">'+p.name+' ('+p.unit+')</option>';});
    html+='</select></div>';
    html+='<div style="display:flex;gap:8px">';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Quantity</label><input type="number" id="new-mp-qty" class="form-i" placeholder="1" value="1" step="0.1"></div>';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Unit</label><select id="new-mp-unit" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveMenuPrep('+menuId+')" style="flex:1">Add</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveMenuPrep(menuId){
    var menu=D.menus.find(function(m){return m.id===menuId;});
    if(!menu)return;
    if(!menu.preps)menu.preps=[];
    saveState('Add menu prep');
    menu.preps.push({
        prepId:+document.getElementById('new-mp-prep').value,
        qty:+document.getElementById('new-mp-qty').value||1,
        unit:document.getElementById('new-mp-unit').value||'ea'
    });
    closeModal();
    render();
}

function delMenuPrep(menuId,idx){
    var menu=D.menus.find(function(m){return m.id===menuId;});
    if(menu&&menu.preps){saveState('Remove menu prep');menu.preps.splice(idx,1);render();}
}

function addMenuRec(menuId){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Recipe to Menu Item</div>';
    html+='<div class="form-g"><label class="form-l">Recipe</label><select id="new-mr-rec" class="form-i" onchange="updateMenuRecHint()">';

    // Group recipes by category
    var activeRecs = D.recs.filter(function(r){return !r.archived;});
    D.recCats.forEach(function(cat){
        var catRecs = activeRecs.filter(function(r){return r.catId === cat.id;});
        if(catRecs.length){
            html+='<optgroup label="'+cat.name+'">';
            catRecs.forEach(function(r){
                var output = calcRecipeOutput(r);
                var modeIcon = r.outputMode === 'manual' ? '‚úèÔ∏è' : 'üîÑ';
                html+='<option value="'+r.id+'">'+r.name+' ('+output.qty+' '+(r.yieldUnit||output.unit)+') '+modeIcon+'</option>';
            });
            html+='</optgroup>';
        }
    });
    // Uncategorized recipes
    var uncatRecs = activeRecs.filter(function(r){return !r.catId;});
    if(uncatRecs.length){
        html+='<optgroup label="Uncategorized">';
        uncatRecs.forEach(function(r){
            var output = calcRecipeOutput(r);
            var modeIcon = r.outputMode === 'manual' ? '‚úèÔ∏è' : 'üîÑ';
            html+='<option value="'+r.id+'">'+r.name+' ('+output.qty+' '+(r.yieldUnit||output.unit)+') '+modeIcon+'</option>';
        });
        html+='</optgroup>';
    }
    html+='</select></div>';
    html+='<div id="rec-output-hint" style="padding:8px;background:rgba(253,203,110,.1);border-radius:6px;margin-bottom:12px;font-size:calc(11px * var(--font-scale));color:#fdcb6e"></div>';

    // Quantity and unit
    html+='<div style="display:flex;gap:8px">';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Quantity Needed</label><input type="number" id="new-mr-qty" class="form-i" placeholder="1" value="1" step="0.1"></div>';
    html+='<div class="form-g" style="flex:1"><label class="form-l">Unit</label><select id="new-mr-unit" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';

    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveMenuRec('+menuId+')" style="flex:1">Add</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
    updateMenuRecHint();
    // Set default unit to recipe's output unit
    setTimeout(function(){
        var sel = document.getElementById('new-mr-rec');
        if(sel){
            var recId = +sel.value;
            var rec = D.recs.find(function(r){return r.id===recId;});
            if(rec){
                var output = calcRecipeOutput(rec);
                var unitSel = document.getElementById('new-mr-unit');
                if(unitSel) unitSel.value = rec.yieldUnit || output.unit || 'ea';
            }
        }
    }, 0);
}

function updateMenuRecHint(){
    var sel=document.getElementById('new-mr-rec');
    if(!sel)return;
    var recId=+sel.value;
    var rec=D.recs.find(function(r){return r.id===recId;});
    var hint=document.getElementById('rec-output-hint');
    if(rec && hint){
        var output = calcRecipeOutput(rec);
        var modeLabel = rec.outputMode === 'manual' ? '‚úèÔ∏è Manual output' : 'üîÑ Yield calculation';
        hint.innerHTML='üìñ <b>'+rec.name+'</b> produces <b>'+output.qty+' '+(rec.yieldUnit||output.unit)+'</b> per batch<br><span style="color:#a0aec0;font-size:calc(10px * var(--font-scale))">'+modeLabel+'</span>';
        // Update default unit to match recipe output
        var unitSel = document.getElementById('new-mr-unit');
        if(unitSel) unitSel.value = rec.yieldUnit || output.unit || 'ea';
    }
}

function saveMenuRec(menuId){
    var menu=D.menus.find(function(m){return m.id===menuId;});
    if(!menu)return;
    if(!menu.recs)menu.recs=[];
    saveState('Add menu recipe');

    var recId = +document.getElementById('new-mr-rec').value;
    var qty = +document.getElementById('new-mr-qty').value || 1;
    var unit = document.getElementById('new-mr-unit').value || 'ea';

    menu.recs.push({
        recId: recId,
        qty: qty,
        unit: unit
    });
    closeModal();
    render();
}

function delMenuRec(menuId,idx){
    var menu=D.menus.find(function(m){return m.id===menuId;});
    if(menu&&menu.recs){saveState('Remove menu recipe');menu.recs.splice(idx,1);render();}
}

function editMenuItem(id){
    var menu=D.menus.find(function(m){return m.id===id;});
    if(!menu)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit '+menu.name+'</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-menu-name" class="form-i" value="'+menu.name+'"></div>';
    html+='<div class="form-g"><label class="form-l">Category</label><select id="ed-menu-cat" class="form-i">';
    D.menuCats.forEach(function(cat){html+='<option value="'+cat.id+'"'+(cat.id===menu.catId?' selected':'')+'>'+cat.name+'</option>';});
    html+='</select></div>';
    html+='<div class="form-g"><label class="form-l">Target Quantity</label><div style="display:flex;gap:8px"><input type="number" id="ed-menu-tgt" class="form-i" value="'+menu.tgt+'" style="flex:1"><select id="ed-menu-unit" class="form-i" style="flex:1">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.id+'"'+(u.id===menu.unitId?' selected':'')+'>'+u.abbr+'</option>';});
    html+='</select></div></div>';
    html+='<div class="form-g" style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(108,92,231,.1);border-radius:8px"><input type="checkbox" id="ed-menu-shop" '+(menu.includeInShop?'checked':'')+'><label for="ed-menu-shop" style="font-size:calc(13px * var(--font-scale));color:#e0e6ed;cursor:pointer">üõí Include in Shopping List</label></div>';
    html+='<div class="form-g" style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(255,107,107,.1);border-radius:8px"><input type="checkbox" id="ed-menu-prep" '+(menu.includeInPrep?'checked':'')+'><label for="ed-menu-prep" style="font-size:calc(13px * var(--font-scale));color:#e0e6ed;cursor:pointer">üì¶ Include in Prep (can be added to Inventory)</label></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveMenuEdit('+id+')" style="flex:1">Save</button></div>';
    html+='<div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,.1)"><button class="btn" style="width:100%;background:#e74c3c;color:#fff" onclick="delMenuItem('+id+')">Delete Menu Item</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveMenuEdit(id){
    var menu=D.menus.find(function(m){return m.id===id;});
    if(!menu)return;
    saveState('Edit menu item');
    var oldTgt = menu.tgt;
    var oldShop = menu.includeInShop;
    menu.name=document.getElementById('ed-menu-name').value;
    menu.catId=+document.getElementById('ed-menu-cat').value;
    menu.tgt=+document.getElementById('ed-menu-tgt').value||0;
    menu.unitId=+document.getElementById('ed-menu-unit').value;
    menu.includeInShop=document.getElementById('ed-menu-shop').checked?1:0;
    menu.includeInPrep=document.getElementById('ed-menu-prep').checked?1:0;
    closeModal();
    // Auto-recalculate shopping if target or includeInShop changed
    if(menu.tgt !== oldTgt || menu.includeInShop !== oldShop){
        calculateShoppingList(true); // silent mode
    } else {
        render();
    }
}

function delMenuItem(id){
    if(!confirm('Delete this menu item? This cannot be undone.'))return;
    saveState('Delete menu item');
    var menu=D.menus.find(function(m){return m.id===id;});
    if(!D.deleteLog)D.deleteLog={};
    if(!D.deleteLog.menus)D.deleteLog.menus=[];
    D.deleteLog.menus.push(id);
    D.menus=D.menus.filter(function(m){return m.id!==id;});
    closeModal();
    render();
}

// ==================== LOG ====================
function renderLog(c,s){
    s.textContent='Inventory Changes';
    var html='<div class="sec log">Inventory Log</div>';

    if(!D.log.length){
        html+='<div style="color:#636e72;font-size:calc(12px * var(--font-scale));padding:20px;text-align:center">No inventory changes logged yet.<br>Changes will appear here as you update inventory.</div>';
    }else{
        // Group by date
        var byDate={};
        D.log.forEach(function(l){
            if(!byDate[l.date])byDate[l.date]=[];
            byDate[l.date].push(l);
        });

        Object.keys(byDate).forEach(function(date){
            html+='<div class="section-label" style="margin-top:16px">'+date+'</div>';
            byDate[date].forEach(function(l){
                html+='<div class="log-item"><div class="log-action">'+l.item+'</div><div class="log-meta">'+l.oldQty+' '+l.oldUnit+' ‚Üí '+l.newQty+' '+l.newUnit+'</div><div class="log-meta" style="color:#81ecec">üë§ '+l.user+' ‚Ä¢ üïê '+l.time+'</div></div>';
            });
        });
    }

    c.innerHTML=html;
}

// ==================== ADMIN ====================
function renderAdmin(c,s){
    s.textContent='Settings';
    var html='';
    
    // Data Management Section (collapsed by default)
    html+='<div class="archive-header" onclick="toggleAdminSection(\'dataManagement\')" style="margin-bottom:8px"><span>üíæ Data Management</span><span>'+(adminSectionsOpen.dataManagement?'‚ñ≤':'‚ñº')+'</span></div>';
    if(adminSectionsOpen.dataManagement){
        html+='<div class="card" style="padding:12px;margin-bottom:16px"><div style="display:flex;gap:8px;flex-wrap:wrap">';
        html+='<button class="btn btn-p btn-sm" onclick="exportData()">üì§ Export Data</button>';
        html+='<button class="btn btn-s btn-sm" onclick="importData()">üì• Import Data</button>';
        html+='<button class="btn btn-sm" style="background:#e74c3c;color:#fff" onclick="resetData()">üóëÔ∏è Reset All</button>';
        html+='</div><div style="margin-top:8px;font-size:calc(10px * var(--font-scale));color:#a0aec0">Data auto-saves to browser. Export for backup.</div>';
        // Excel import drop zone
        html+='<div id="excel-drop-zone" style="margin-top:12px;padding:20px;border:2px dashed rgba(108,92,231,.5);border-radius:10px;text-align:center;cursor:pointer" onclick="document.getElementById(\'excel-file-input\').click()">';
        html+='<div style="font-size:calc(24px * var(--font-scale))">üìä</div>';
        html+='<div style="font-size:calc(12px * var(--font-scale));color:#a29bfe;margin-top:4px">Drop Excel Template Here</div>';
        html+='<div style="font-size:calc(10px * var(--font-scale));color:#636e72;margin-top:4px">or click to browse (.xlsx)</div>';
        html+='<input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display:none" onchange="handleExcelImport(this.files[0])">';
        html+='</div>';
        html+='<a href="Restaurant_Oracle_Template.xlsx" download style="display:block;margin-top:8px;text-align:center;font-size:calc(10px * var(--font-scale));color:#74b9ff;text-decoration:none">‚¨áÔ∏è Download blank template</a>';
        html+='</div>';
    }
    
    // Users
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üë• Users ('+D.users.length+')<button class="btn btn-p btn-sm" onclick="addUser()">+ Add</button></div>';
    D.users.forEach(function(u){
        html+='<div class="card user-card'+(u.role==='employee'?' employee':'')+'"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t">'+u.name+'</div><div class="card-s">'+u.role+' ‚Ä¢ '+u.email+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editUser('+u.id+')">‚úèÔ∏è</button>'+(u.id!==1?'<button class="del-btn" onclick="delUser('+u.id+')">üóëÔ∏è</button>':'')+'</div></div></div>';
    });
    
    // Storage Locations
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üìç Storage Locations ('+D.areas.length+')<button class="btn btn-p btn-sm" onclick="addArea()">+ Add</button></div>';
    D.areas.forEach(function(a){
        html+='<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t">'+a.name+'</div><div class="card-s">'+(a.sections.length?a.sections.join(', '):'No sections')+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editArea('+a.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="delArea('+a.id+')">üóëÔ∏è</button></div></div></div>';
    });
    
    // Ingredient Categories
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üè∑Ô∏è Ingredient Categories ('+D.cats.length+')<button class="btn btn-p btn-sm" onclick="addCat()">+ Add</button></div>';
    D.cats.forEach(function(cat){
        html+='<div class="card" style="padding:10px"><div style="display:flex;justify-content:space-between;align-items:center"><span class="card-t" style="font-size:calc(13px * var(--font-scale))">'+cat.name+'</span><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editCat('+cat.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="delCat('+cat.id+')">üóëÔ∏è</button></div></div></div>';
    });
    
    // Menu Categories
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üçΩÔ∏è Menu Categories ('+D.menuCats.length+')<button class="btn btn-p btn-sm" onclick="addMenuCat()">+ Add</button></div>';
    D.menuCats.forEach(function(cat){
        html+='<div class="card" style="padding:10px"><div style="display:flex;justify-content:space-between;align-items:center"><span class="card-t" style="font-size:calc(13px * var(--font-scale))">'+cat.name+'</span><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editMenuCat('+cat.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="delMenuCat('+cat.id+')">üóëÔ∏è</button></div></div></div>';
    });
    
    // Recipe Categories
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üìñ Recipe Categories ('+(D.recCats?D.recCats.length:0)+')<button class="btn btn-p btn-sm" onclick="addRecCat()">+ Add</button></div>';
    if(D.recCats){
        D.recCats.forEach(function(cat){
            html+='<div class="card" style="padding:10px"><div style="display:flex;justify-content:space-between;align-items:center"><span class="card-t" style="font-size:calc(13px * var(--font-scale))">'+cat.name+'</span><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editRecCat('+cat.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="delRecCat('+cat.id+')">üóëÔ∏è</button></div></div></div>';
        });
    }
    
    // Unit Conversions
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üîÑ Unit Conversions ('+(D.conversions?D.conversions.length:0)+')<button class="btn btn-p btn-sm" onclick="addConversion()">+ Add</button></div>';
    html+='<div style="font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-bottom:8px">Convert between storage units (how you buy) and recipe units (how you use)</div>';
    if(D.conversions && D.conversions.length){
        D.conversions.forEach(function(conv){
            var ing=D.ings.find(function(i){return i.id===conv.ingId;});
            var ingName=ing?ing.name:'Unknown';
            html+='<div class="card" style="padding:10px;border-left:3px solid #6c5ce7"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="card-t" style="font-size:calc(13px * var(--font-scale))">'+ingName+'</div><div class="card-s">1 '+conv.storageUnit+' = '+conv.factor+' '+conv.recipeUnit+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-s btn-sm" onclick="editConversion('+conv.id+')">‚úèÔ∏è</button><button class="del-btn" onclick="delConversion('+conv.id+')">üóëÔ∏è</button></div></div></div>';
        });
    }else{
        html+='<div style="color:#636e72;font-size:calc(11px * var(--font-scale));padding:12px;text-align:center">No conversions set. Add conversions for items where storage and recipe units differ.<br><em>Example: Pancake Mix: 1 box = 18 cups</em></div>';
    }
    
    // Units
    html+='<div class="sec" style="display:flex;justify-content:space-between;align-items:center">üìè Recipe Units ('+D.units.length+')<button class="btn btn-p btn-sm" onclick="addUnit()">+ Add</button></div>';
    html+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    getSortedUnits().forEach(function(u){
        html+='<span style="background:rgba(255,255,255,.1);padding:4px 8px;border-radius:6px;font-size:calc(11px * var(--font-scale));color:#a0aec0;display:flex;align-items:center;gap:4px">'+u.abbr+' <button style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:10px;padding:0" onclick="delUnit('+u.id+')">‚úï</button></span>';
    });
    html+='</div>';

    c.innerHTML=html;

    // Setup drag and drop after rendering
    setTimeout(setupExcelDropZone, 0);
}

function editUser(id){
    var user=D.users.find(function(u){return u.id===id;});
    if(!user)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit User</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-user-name" class="form-i" value="'+user.name+'"></div>';
    html+='<div class="form-g"><label class="form-l">Email</label><input type="email" id="ed-user-email" class="form-i" value="'+user.email+'"></div>';
    html+='<div class="form-g"><label class="form-l">Role</label><select id="ed-user-role" class="form-i"><option value="owner"'+(user.role==='owner'?' selected':'')+'>Owner</option><option value="employee"'+(user.role==='employee'?' selected':'')+'>Employee</option></select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveUser('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveUser(id){
    var user=D.users.find(function(u){return u.id===id;});
    if(!user)return;
    saveState('Edit user');
    user.name=document.getElementById('ed-user-name').value;
    user.email=document.getElementById('ed-user-email').value;
    user.role=document.getElementById('ed-user-role').value;
    closeModal();
    render();
}

function delUser(id){
    if(confirm('Delete this user?')){
        saveState('Delete user');
        D.users=D.users.filter(function(u){return u.id!==id;});
        if(!deleteLog.users)deleteLog.users=new Set();
        deleteLog.users.add(id);
        render();
    }
}

function editArea(id){
    var area=D.areas.find(function(a){return a.id===id;});
    if(!area)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit Storage Location</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-area-name" class="form-i" value="'+area.name+'"></div>';
    html+='<div class="form-g"><label class="form-l">Sections (comma separated)</label><input type="text" id="ed-area-sec" class="form-i" value="'+area.sections.join(', ')+'"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveArea('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveArea(id){
    var area=D.areas.find(function(a){return a.id===id;});
    if(!area)return;
    saveState('Edit storage location');
    area.name=document.getElementById('ed-area-name').value;
    var secStr=document.getElementById('ed-area-sec').value;
    area.sections=secStr?secStr.split(',').map(function(s){return s.trim();}).filter(function(s){return s;})  :[];
    closeModal();
    render();
}

function editCat(id){
    var cat=D.cats.find(function(c){return c.id===id;});
    if(!cat)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit Category</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-cat-name" class="form-i" value="'+cat.name+'"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveCat('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveCat(id){
    var cat=D.cats.find(function(c){return c.id===id;});
    if(!cat)return;
    saveState('Edit ingredient category');
    cat.name=document.getElementById('ed-cat-name').value;
    closeModal();
    render();
}

function editMenuCat(id){
    var cat=D.menuCats.find(function(c){return c.id===id;});
    if(!cat)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit Menu Category</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-mcat-name" class="form-i" value="'+cat.name+'"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveMenuCatEdit('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveMenuCatEdit(id){
    var cat=D.menuCats.find(function(c){return c.id===id;});
    if(!cat)return;
    saveState('Edit menu category');
    cat.name=document.getElementById('ed-mcat-name').value;
    closeModal();
    render();
}

// ==================== ADD FUNCTIONS ====================
function addUser(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add User</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="new-user-name" class="form-i" placeholder="Enter name"></div>';
    html+='<div class="form-g"><label class="form-l">Email</label><input type="email" id="new-user-email" class="form-i" placeholder="email@lachona.com"></div>';
    html+='<div class="form-g"><label class="form-l">Role</label><select id="new-user-role" class="form-i"><option value="employee">Employee</option><option value="owner">Owner</option></select></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewUser()" style="flex:1">Add User</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewUser(){
    var name=document.getElementById('new-user-name').value.trim();
    var email=document.getElementById('new-user-email').value.trim();
    var role=document.getElementById('new-user-role').value;
    if(!name){alert('Enter a name');return;}
    saveState('Add user');
    var maxId=Math.max.apply(null,D.users.map(function(u){return u.id;}))||0;
    D.users.push({id:maxId+1,name:name,role:role,email:email,phone:''});
    closeModal();
    render();
}

function addArea(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Storage Location</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="new-area-name" class="form-i" placeholder="e.g. Walk-in Cooler"></div>';
    html+='<div class="form-g"><label class="form-l">Sections (comma separated, optional)</label><input type="text" id="new-area-sec" class="form-i" placeholder="e.g. Left, Middle, Right"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewArea()" style="flex:1">Add Location</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewArea(){
    var name=document.getElementById('new-area-name').value.trim();
    if(!name){alert('Enter a name');return;}
    saveState('Add storage location');
    var secStr=document.getElementById('new-area-sec').value;
    var sections=secStr?secStr.split(',').map(function(s){return s.trim();}).filter(function(s){return s;}):[];
    var maxId=Math.max.apply(null,D.areas.map(function(a){return a.id;}))||0;
    D.areas.push({id:maxId+1,name:name,sections:sections});
    closeModal();
    render();
}

function addCat(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Ingredient Category</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="new-cat-name" class="form-i" placeholder="e.g. Seafood"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewCat()" style="flex:1">Add Category</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewCat(){
    var name=document.getElementById('new-cat-name').value.trim();
    if(!name){alert('Enter a name');return;}
    saveState('Add ingredient category');
    var maxId=Math.max.apply(null,D.cats.map(function(c){return c.id;}))||0;
    D.cats.push({id:maxId+1,name:name});
    closeModal();
    render();
}

function addMenuCat(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Menu Category</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="new-mcat-name" class="form-i" placeholder="e.g. Specials"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewMenuCat()" style="flex:1">Add Category</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewMenuCat(){
    var name=document.getElementById('new-mcat-name').value.trim();
    if(!name){alert('Enter a name');return;}
    saveState('Add menu category');
    var maxId=Math.max.apply(null,D.menuCats.map(function(c){return c.id;}))||0;
    D.menuCats.push({id:maxId+1,name:name});
    closeModal();
    render();
}

// Unit Conversions
function addConversion(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Unit Conversion</div>';
    html+='<div class="form-g"><label class="form-l">Ingredient</label><select id="conv-ing" class="form-i"><option value="">Select ingredient...</option>';
    D.ings.filter(function(i){return !i.archived;}).forEach(function(ing){
        html+='<option value="'+ing.id+'">'+ing.name+'</option>';
    });
    html+='</select></div>';
    html+='<div style="display:flex;gap:8px;align-items:center;margin:16px 0">';
    html+='<div style="flex:1"><label class="form-l">Storage Unit</label><input type="text" id="conv-storage" class="form-i" placeholder="e.g. box"></div>';
    html+='<span style="color:#a0aec0;padding-top:20px">=</span>';
    html+='<div style="flex:1"><label class="form-l">Factor</label><input type="number" id="conv-factor" class="form-i" placeholder="e.g. 18"></div>';
    html+='<div style="flex:1"><label class="form-l">Recipe Unit</label><select id="conv-recipe" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';
    html+='<div style="font-size:calc(11px * var(--font-scale));color:#a0aec0;padding:8px;background:rgba(0,0,0,.2);border-radius:6px;margin-bottom:12px">Example: 1 box = 18 cups means you buy boxes but recipes use cups</div>';
    html+='<div style="display:flex;gap:8px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewConversion()" style="flex:1">Add</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewConversion(){
    var ingId=+document.getElementById('conv-ing').value;
    var storageUnit=document.getElementById('conv-storage').value.trim();
    var factor=+document.getElementById('conv-factor').value;
    var recipeUnit=document.getElementById('conv-recipe').value;
    if(!ingId||!storageUnit||!factor||!recipeUnit){alert('Fill in all fields');return;}
    
    // Check if conversion already exists for this ingredient
    var existing=D.conversions.find(function(c){return c.ingId===ingId;});
    if(existing){alert('Conversion already exists for this ingredient. Edit or delete the existing one.');return;}
    
    saveState('Add unit conversion');
    var maxId=D.conversions.length?Math.max.apply(null,D.conversions.map(function(c){return c.id;})):0;
    D.conversions.push({id:maxId+1,ingId:ingId,storageUnit:storageUnit,factor:factor,recipeUnit:recipeUnit});
    if(!changeLog.conversions)changeLog.conversions=new Set();
    changeLog.conversions.add(maxId+1);
    closeModal();
    render();
}

function editConversion(id){
    var conv=D.conversions.find(function(c){return c.id===id;});
    if(!conv)return;
    var ing=D.ings.find(function(i){return i.id===conv.ingId;});
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit Conversion for '+(ing?ing.name:'Unknown')+'</div>';
    html+='<div style="display:flex;gap:8px;align-items:center;margin:16px 0">';
    html+='<div style="flex:1"><label class="form-l">Storage Unit</label><input type="text" id="conv-storage" class="form-i" value="'+conv.storageUnit+'"></div>';
    html+='<span style="color:#a0aec0;padding-top:20px">=</span>';
    html+='<div style="flex:1"><label class="form-l">Factor</label><input type="number" id="conv-factor" class="form-i" value="'+conv.factor+'"></div>';
    html+='<div style="flex:1"><label class="form-l">Recipe Unit</label><select id="conv-recipe" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'"'+(u.abbr===conv.recipeUnit?' selected':'')+'>'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';
    html+='<div style="display:flex;gap:8px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveConversionEdit('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveConversionEdit(id){
    var conv=D.conversions.find(function(c){return c.id===id;});
    if(!conv)return;
    saveState('Edit unit conversion');
    conv.storageUnit=document.getElementById('conv-storage').value.trim();
    conv.factor=+document.getElementById('conv-factor').value;
    conv.recipeUnit=document.getElementById('conv-recipe').value;
    if(!changeLog.conversions)changeLog.conversions=new Set();
    changeLog.conversions.add(id);
    closeModal();
    render();
}

function delConversion(id){
    if(!confirm('Delete this conversion?'))return;
    saveState('Delete unit conversion');
    D.conversions=D.conversions.filter(function(c){return c.id!==id;});
    if(!deleteLog.conversions)deleteLog.conversions=new Set();
    deleteLog.conversions.add(id);
    render();
}

// Add conversion directly for a specific ingredient (from inventory view)
function addConversionForIng(ingId){
    var ing=D.ings.find(function(i){return i.id===ingId;});
    if(!ing)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Conversion for '+ing.name+'</div>';
    html+='<div style="font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-bottom:12px">Define how you buy this item vs how recipes use it</div>';
    html+='<input type="hidden" id="conv-ing" value="'+ingId+'">';
    html+='<div style="display:flex;gap:8px;align-items:center;margin:16px 0;flex-wrap:wrap">';
    html+='<div style="flex:1;min-width:80px"><label class="form-l">Storage Unit</label><input type="text" id="conv-storage" class="form-i" placeholder="bottle, box, bag..."></div>';
    html+='<span style="color:#a0aec0;padding-top:20px">=</span>';
    html+='<div style="flex:1;min-width:60px"><label class="form-l">Qty</label><input type="number" id="conv-factor" class="form-i" placeholder="25"></div>';
    html+='<div style="flex:1;min-width:70px"><label class="form-l">Recipe Unit</label><select id="conv-recipe" class="form-i">';
    getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'"'+(u.abbr===ing.defUnit?' selected':'')+'>'+u.abbr+'</option>';});
    html+='</select></div>';
    html+='</div>';
    html+='<div style="font-size:calc(10px * var(--font-scale));color:#6c5ce7;padding:8px;background:rgba(108,92,231,.1);border-radius:6px;margin-bottom:12px">Example: 1 bottle = 25 fl oz means you buy bottles but recipes use fluid ounces</div>';
    html+='<div style="display:flex;gap:8px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewConversion()" style="flex:1">Add Conversion</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function addUnit(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Recipe Unit</div>';
    html+='<div class="form-g"><label class="form-l">Full Name</label><input type="text" id="new-unit-name" class="form-i" placeholder="e.g. milliliter"></div>';
    html+='<div class="form-g"><label class="form-l">Abbreviation</label><input type="text" id="new-unit-abbr" class="form-i" placeholder="e.g. ml"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewUnit()" style="flex:1">Add Unit</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewUnit(){
    var name=document.getElementById('new-unit-name').value.trim();
    var abbr=document.getElementById('new-unit-abbr').value.trim();
    if(!name||!abbr){alert('Enter both name and abbreviation');return;}
    saveState('Add unit');
    var maxId=Math.max.apply(null,D.units.map(function(u){return u.id;}))||0;
    D.units.push({id:maxId+1,name:name,abbr:abbr});
    closeModal();
    render();
}

// ==================== DELETE FUNCTIONS ====================
function delArea(id){
    // Check if area is in use
    var inUse=D.ings.some(function(i){return i.areaId===id;})||D.inv.some(function(i){return i.areaId===id;});
    if(inUse){
        alert('Cannot delete: This location is used by ingredients or inventory items.');
        return;
    }
    if(confirm('Delete this storage location?')){
        saveState('Delete storage location');
        D.areas=D.areas.filter(function(a){return a.id!==id;});
        if(!deleteLog.areas)deleteLog.areas=new Set();
        deleteLog.areas.add(id);
        render();
    }
}

function delCat(id){
    var inUse=D.ings.some(function(i){return i.catId===id;});
    if(inUse){
        alert('Cannot delete: This category is used by ingredients.');
        return;
    }
    if(confirm('Delete this ingredient category?')){
        saveState('Delete ingredient category');
        D.cats=D.cats.filter(function(c){return c.id!==id;});
        if(!deleteLog.cats)deleteLog.cats=new Set();
        deleteLog.cats.add(id);
        render();
    }
}

function delMenuCat(id){
    var inUse=D.menus.some(function(m){return m.catId===id;});
    if(inUse){
        alert('Cannot delete: This category is used by menu items.');
        return;
    }
    if(confirm('Delete this menu category?')){
        saveState('Delete menu category');
        D.menuCats=D.menuCats.filter(function(c){return c.id!==id;});
        if(!deleteLog.menuCats)deleteLog.menuCats=new Set();
        deleteLog.menuCats.add(id);
        render();
    }
}

function addRecCat(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add Recipe Category</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="new-rcat-name" class="form-i" placeholder="e.g. Sauces"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveNewRecCat()" style="flex:1">Add Category</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveNewRecCat(){
    var name=document.getElementById('new-rcat-name').value.trim();
    if(!name){alert('Enter a name');return;}
    saveState('Add recipe category');
    if(!D.recCats) D.recCats = [];
    var maxId=D.recCats.length ? Math.max.apply(null,D.recCats.map(function(c){return c.id;})) : 0;
    D.recCats.push({id:maxId+1,name:name});
    closeModal();
    render();
}

function editRecCat(id){
    var cat=D.recCats.find(function(c){return c.id===id;});
    if(!cat)return;
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Edit Recipe Category</div>';
    html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="ed-rcat-name" class="form-i" value="'+cat.name+'"></div>';
    html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="saveRecCatEdit('+id+')" style="flex:1">Save</button></div>';
    m.innerHTML=html;
    mo.classList.add('open');
}

function saveRecCatEdit(id){
    var cat=D.recCats.find(function(c){return c.id===id;});
    if(!cat)return;
    saveState('Edit recipe category');
    cat.name=document.getElementById('ed-rcat-name').value;
    closeModal();
    render();
}

function delRecCat(id){
    var inUse=D.recs.some(function(r){return r.catId===id;});
    if(inUse){
        alert('Cannot delete: This category is used by recipes.');
        return;
    }
    if(confirm('Delete this recipe category?')){
        saveState('Delete recipe category');
        D.recCats=D.recCats.filter(function(c){return c.id!==id;});
        if(!deleteLog.recCats)deleteLog.recCats=new Set();
        deleteLog.recCats.add(id);
        render();
    }
}

function delUnit(id){
    // Check if unit is in use in recipes
    var inUse=D.recs.some(function(r){
        return r.ings.some(function(i){return i.unit===D.units.find(function(u){return u.id===id;})?.abbr;});
    });
    if(inUse){
        alert('Cannot delete: This unit is used in recipes.');
        return;
    }
    if(confirm('Delete this unit?')){
        saveState('Delete unit');
        D.units=D.units.filter(function(u){return u.id!==id;});
        if(!deleteLog.units)deleteLog.units=new Set();
        deleteLog.units.add(id);
        render();
    }
}

// ==================== DATA MANAGEMENT ====================
function exportData(){
    var dataToExport={
        version:DATA_VERSION,
        exportDate:new Date().toISOString(),
        data:{
            users:D.users,
            areas:D.areas,
            cats:D.cats,
            menuCats:D.menuCats,
            recCats:D.recCats,
            units:D.units,
            ings:D.ings,
            inv:D.inv,
            shopping:D.shopping,
            preps:D.preps,
            recs:D.recs,
            menus:D.menus,
            log:D.log
        }
    };
    var json=JSON.stringify(dataToExport,null,2);
    var blob=new Blob([json],{type:'application/json'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='restaurant-oracle-backup-'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showDebugInfo(){
    toggleUserMenu(); // Close menu
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');

    // Get localStorage data
    var localData = null;
    var localInvCount = 0;
    try {
        var savedData = localStorage.getItem('ro_allData');
        if(savedData){
            localData = JSON.parse(savedData);
            localInvCount = localData.inv ? localData.inv.length : 0;
        }
    } catch(e){}

    var html = '<div class="modal-t">üîß Debug Info</div>';
    html += '<div style="background:rgba(0,0,0,.3);padding:12px;border-radius:8px;margin-bottom:12px">';
    html += '<div style="font-size:calc(12px * var(--font-scale));color:#a0aec0;margin-bottom:8px">Current App Data:</div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">üì¶ Inventory: <strong>'+D.inv.length+'</strong> items</div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">ü•¨ Ingredients: <strong>'+D.ings.length+'</strong></div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">üìñ Recipes: <strong>'+D.recs.length+'</strong></div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">üçΩÔ∏è Menu Items: <strong>'+D.menus.length+'</strong></div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">üõí Shopping: <strong>'+D.shopping.length+'</strong></div>';
    html += '</div>';

    html += '<div style="background:rgba(0,0,0,.3);padding:12px;border-radius:8px;margin-bottom:12px">';
    html += '<div style="font-size:calc(12px * var(--font-scale));color:#a0aec0;margin-bottom:8px">Local Storage (Device Backup):</div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">üì¶ Inventory: <strong>'+localInvCount+'</strong> items</div>';
    if(localData && localData.lastSaved){
        var savedTime = new Date(localData.lastSaved);
        html += '<div style="font-size:calc(11px * var(--font-scale));color:#a0aec0;margin-top:4px">Last saved: '+savedTime.toLocaleString()+'</div>';
    }
    if(localInvCount > D.inv.length){
        html += '<div style="color:#00b894;margin-top:8px;font-size:calc(11px * var(--font-scale))">‚úì Local storage has MORE inventory than current app!</div>';
        html += '<button class="btn btn-p" onclick="restoreFromLocalStorage()" style="margin-top:8px;width:100%">üîÑ Restore from Local Storage</button>';
    } else if(localInvCount > 0 && localInvCount < D.inv.length){
        html += '<div style="color:#fdcb6e;margin-top:8px;font-size:calc(11px * var(--font-scale))">‚ö† Local storage has less inventory than current app</div>';
    }
    html += '</div>';

    html += '<div style="background:rgba(0,0,0,.3);padding:12px;border-radius:8px;margin-bottom:12px">';
    html += '<div style="font-size:calc(12px * var(--font-scale));color:#a0aec0;margin-bottom:8px">Connection Status:</div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">Supabase: <strong>'+(supabase?'‚úì Connected':'‚úó Not connected')+'</strong></div>';
    html += '<div style="font-size:calc(13px * var(--font-scale));color:#e0e6ed">User: <strong>'+(currentAuthUser?currentAuthUser.email:'Not signed in')+'</strong></div>';
    html += '</div>';

    html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
    html += '<button class="btn btn-s" onclick="closeModal()" style="flex:1">Close</button>';
    html += '<button class="btn btn-s" onclick="exportData();closeModal()" style="flex:1">üì§ Export</button>';
    html += '<button class="btn btn-p" onclick="forceFullSync()" style="flex:1">üîÑ Force Sync</button>';
    html += '</div>';

    m.innerHTML = html;
    mo.classList.add('open');
}

function restoreFromLocalStorage(){
    if(!confirm('This will replace current app data with data from local storage. Continue?')) return;
    try {
        var savedData = localStorage.getItem('ro_allData');
        if(savedData){
            var localData = JSON.parse(savedData);
            if(localData.inv && localData.inv.length > 0){
                D.inv = localData.inv;
                alert('Restored '+D.inv.length+' inventory items from local storage. Click "Force Sync" to save to cloud.');
                closeModal();
                render();
            }
        }
    } catch(e){
        alert('Error restoring: '+e.message);
    }
}

async function forceFullSync(){
    if(!supabase || !currentAuthUser){
        alert('Not connected to cloud. Please sign in.');
        return;
    }
    if(!confirm('This will upload ALL current app data to the cloud, overwriting what is there. Continue?')) return;

    closeModal();
    showSyncStatus('syncing');

    try {
        // Upload everything
        await Promise.all([
            supabase.from('areas').upsert(D.areas.map(mapAreaToDb)),
            supabase.from('cats').upsert(D.cats),
            supabase.from('menu_cats').upsert(D.menuCats.map(function(c){return{id:c.id,name:c.name};})),
            supabase.from('units').upsert(D.units),
            supabase.from('ings').upsert(D.ings.map(mapIngToDb)),
            supabase.from('inv').upsert(D.inv.map(mapInvToDb)),
            supabase.from('shopping').upsert(D.shopping.map(mapShoppingToDb)),
            supabase.from('preps').upsert(D.preps.map(mapPrepToDb)),
            supabase.from('recs').upsert(D.recs.map(mapRecToDb)),
            supabase.from('menus').upsert(D.menus.map(mapMenuToDb))
        ]);

        // Also save to localStorage
        saveAllDataLocal();
        takeSyncSnapshot();
        clearChangeLog();

        showSyncStatus('synced');
        alert('Full sync complete! '+D.inv.length+' inventory items uploaded.');
    } catch(err) {
        console.error('Force sync error:', err);
        showSyncStatus('offline');
        alert('Sync failed: '+err.message);
    }
}

function importData(){
    var input=document.createElement('input');
    input.type='file';
    input.accept='.json';
    input.onchange=function(e){
        var file=e.target.files[0];
        if(!file)return;
        var reader=new FileReader();
        reader.onload=function(evt){
            try{
                var imported=JSON.parse(evt.target.result);
                if(!imported.data){
                    alert('Invalid backup file format');
                    return;
                }
                if(confirm('This will replace ALL your current data with the imported backup. Continue?')){
                    Object.keys(imported.data).forEach(function(key){
                        if(D.hasOwnProperty(key)){
                            D[key]=imported.data[key];
                        }
                    });
                    saveAllData();
                    render();
                    alert('Data imported successfully!');
                }
            }catch(err){
                alert('Error reading backup file: '+err.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// Excel Template Import Handler
function handleExcelImport(file){
    if(!file) return;
    if(!window.XLSX){
        alert('Excel library not loaded. Please refresh the page and try again.');
        return;
    }

    var reader = new FileReader();
    reader.onload = function(e){
        try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            var sheet = workbook.Sheets[workbook.SheetNames[0]];
            var rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ''});

            // Parse sections from the template
            var sections = {};
            var currentSection = null;
            var headers = [];

            for(var i = 0; i < rows.length; i++){
                var row = rows[i];
                if(!row || !row.length) continue;

                var firstCell = String(row[0] || '').trim();

                // Detect section headers
                if(firstCell.includes('STORAGE LOCATIONS')){
                    currentSection = 'areas'; headers = []; continue;
                } else if(firstCell.includes('INGREDIENT CATEGORIES')){
                    currentSection = 'cats'; headers = []; continue;
                } else if(firstCell.includes('INGREDIENTS') && !firstCell.includes('RECIPE')){
                    currentSection = 'ings'; headers = []; continue;
                } else if(firstCell.includes('RECIPE CATEGORIES')){
                    currentSection = 'recCats'; headers = []; continue;
                } else if(firstCell.includes('RECIPES') && !firstCell.includes('MENU') && !firstCell.includes('INGREDIENTS')){
                    currentSection = 'recs'; headers = []; continue;
                } else if(firstCell.includes('RECIPE INGREDIENTS')){
                    currentSection = 'recIngs'; headers = []; continue;
                } else if(firstCell.includes('MENU CATEGORIES')){
                    currentSection = 'menuCats'; headers = []; continue;
                } else if(firstCell.includes('MENU ITEMS')){
                    currentSection = 'menus'; headers = []; continue;
                } else if(firstCell.includes('MENU RECIPES')){
                    currentSection = 'menuRecs'; headers = []; continue;
                } else if(firstCell.includes('UNIT CONVERSIONS')){
                    currentSection = 'conversions'; headers = []; continue;
                } else if(firstCell.includes('NOTES:')){
                    currentSection = null; continue;
                }

                if(!currentSection) continue;

                // First row after section header is column headers
                if(headers.length === 0){
                    headers = row.map(function(h){ return String(h || '').trim().toLowerCase(); });
                    if(!sections[currentSection]) sections[currentSection] = [];
                    continue;
                }

                // Parse data row
                var obj = {};
                var hasData = false;
                for(var j = 0; j < headers.length; j++){
                    if(headers[j] && row[j] !== undefined && row[j] !== ''){
                        obj[headers[j]] = row[j];
                        hasData = true;
                    }
                }
                if(hasData && obj.id !== undefined){
                    sections[currentSection].push(obj);
                }
            }

            // Validate and import
            if(!sections.areas && !sections.ings && !sections.recs && !sections.menus){
                alert('No valid data found in the Excel file. Make sure you are using the correct template format.');
                return;
            }

            var summary = [];
            if(sections.areas) summary.push('Storage Locations: ' + sections.areas.length);
            if(sections.cats) summary.push('Ingredient Categories: ' + sections.cats.length);
            if(sections.ings) summary.push('Ingredients: ' + sections.ings.length);
            if(sections.recCats) summary.push('Recipe Categories: ' + sections.recCats.length);
            if(sections.recs) summary.push('Recipes: ' + sections.recs.length);
            if(sections.recIngs) summary.push('Recipe Ingredients: ' + sections.recIngs.length);
            if(sections.menuCats) summary.push('Menu Categories: ' + sections.menuCats.length);
            if(sections.menus) summary.push('Menu Items: ' + sections.menus.length);
            if(sections.menuRecs) summary.push('Menu Recipes: ' + sections.menuRecs.length);
            if(sections.conversions) summary.push('Unit Conversions: ' + sections.conversions.length);

            if(!confirm('Import the following data?\n\n' + summary.join('\n') + '\n\nThis will ADD to your existing data.')){
                return;
            }

            saveState('Import Excel template');

            // Import Storage Locations
            if(sections.areas){
                sections.areas.forEach(function(a){
                    var secs = a.sections ? String(a.sections).split(',').map(function(s){return s.trim();}).filter(Boolean) : [];
                    D.areas.push({
                        id: +a.id,
                        name: String(a.name || ''),
                        sections: secs,
                        prep: a.is_prep_area ? 1 : 0
                    });
                });
            }

            // Import Ingredient Categories
            if(sections.cats){
                sections.cats.forEach(function(c){
                    D.cats.push({id: +c.id, name: String(c.name || '')});
                });
            }

            // Import Ingredients
            if(sections.ings){
                sections.ings.forEach(function(ing){
                    D.ings.push({
                        id: +ing.id,
                        name: String(ing.name || ''),
                        catId: +ing.cat_id || 0,
                        areaId: +ing.area_id || 0,
                        subArea: String(ing.sub_area || ''),
                        defUnit: String(ing.unit || 'ea'),
                        minQty: +ing.par || 0,
                        archived: 0
                    });
                });
            }

            // Import Recipe Categories
            if(sections.recCats){
                sections.recCats.forEach(function(c){
                    D.recCats.push({id: +c.id, name: String(c.name || '')});
                });
            }

            // Import Recipes (without ingredients first)
            if(sections.recs){
                sections.recs.forEach(function(r){
                    D.recs.push({
                        id: +r.id,
                        name: String(r.name || ''),
                        catId: +r.cat_id || 0,
                        yield: +r.yield || 98,
                        yieldUnit: String(r.yield_unit || ''),
                        outputMode: String(r.output_mode || 'auto'),
                        manualQty: +r.manual_qty || 0,
                        includeInPrep: r.include_in_prep ? 1 : 0,
                        ings: [],
                        subRecs: [],
                        archived: 0
                    });
                });
            }

            // Link ingredients to recipes
            if(sections.recIngs){
                sections.recIngs.forEach(function(ri){
                    var rec = D.recs.find(function(r){return r.id === +ri.recipe_id;});
                    if(rec){
                        if(!rec.ings) rec.ings = [];
                        rec.ings.push({
                            ingId: +ri.ingredient_id,
                            qty: +ri.qty || 0,
                            unit: String(ri.unit || 'ea')
                        });
                    }
                });
            }

            // Import Menu Categories
            if(sections.menuCats){
                sections.menuCats.forEach(function(c){
                    D.menuCats.push({id: +c.id, name: String(c.name || '')});
                });
            }

            // Import Menu Items (without recipes first)
            if(sections.menus){
                sections.menus.forEach(function(m){
                    D.menus.push({
                        id: +m.id,
                        name: String(m.name || ''),
                        catId: +m.cat_id || 0,
                        tgt: +m.target_qty || 0,
                        unitId: 1, // Default to 'ea'
                        includeInShop: m.include_in_shop ? 1 : 0,
                        includeInPrep: 1,
                        ings: [],
                        recs: [],
                        archived: 0
                    });
                });
            }

            // Link recipes to menu items
            if(sections.menuRecs){
                sections.menuRecs.forEach(function(mr){
                    var menu = D.menus.find(function(m){return m.id === +mr.menu_id;});
                    if(menu){
                        if(!menu.recs) menu.recs = [];
                        menu.recs.push({
                            recId: +mr.recipe_id,
                            qty: +mr.qty_per_menu || 1,
                            unit: String(mr.unit || 'ea')
                        });
                    }
                });
            }

            // Import Unit Conversions
            if(sections.conversions){
                if(!D.conversions) D.conversions = [];
                sections.conversions.forEach(function(c){
                    D.conversions.push({
                        id: +c.id,
                        ingId: +c.ingredient_id,
                        storageUnit: String(c.storage_unit || ''),
                        recipeUnit: String(c.recipe_unit || ''),
                        factor: +c.factor || 1
                    });
                });
            }

            saveAllData();
            render();
            alert('Import complete!\n\n' + summary.join('\n'));

        } catch(err){
            console.error('Excel import error:', err);
            alert('Error importing Excel file: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

// Setup drag and drop for Excel import
function setupExcelDropZone(){
    var zone = document.getElementById('excel-drop-zone');
    if(!zone) return;

    zone.addEventListener('dragover', function(e){
        e.preventDefault();
        zone.style.borderColor = '#a29bfe';
        zone.style.background = 'rgba(108,92,231,.1)';
    });

    zone.addEventListener('dragleave', function(e){
        e.preventDefault();
        zone.style.borderColor = 'rgba(108,92,231,.5)';
        zone.style.background = 'transparent';
    });

    zone.addEventListener('drop', function(e){
        e.preventDefault();
        zone.style.borderColor = 'rgba(108,92,231,.5)';
        zone.style.background = 'transparent';
        var files = e.dataTransfer.files;
        if(files.length > 0){
            handleExcelImport(files[0]);
        }
    });
}

function resetData(){
    if(confirm('‚ö†Ô∏è WARNING: This will DELETE ALL your data and restore defaults.\n\nThis cannot be undone!\n\nAre you sure?')){
        if(confirm('Final confirmation: Delete everything and reset to defaults?')){
            localStorage.removeItem('ro_allData');
            localStorage.removeItem('ro_dataVersion');
            location.reload();
        }
    }
}

// ==================== COMMON FUNCTIONS ====================
function tog(id){exp[id]=!exp[id];render();}
function togAdd(id){addOpen[id]=!addOpen[id];render();}
function toggleArchive(type){archiveOpen[type]=!archiveOpen[type];render();}
function toggleAdminSection(section){adminSectionsOpen[section]=!adminSectionsOpen[section];render();}

function archiveItem(col,id){
    saveState('Archive item');
    if(col==='ings'){var item=D.ings.find(function(x){return x.id===id;});if(item)item.archived=1;}
    else if(col==='recs'){var item=D.recs.find(function(x){return x.id===id;});if(item)item.archived=1;}
    else if(col==='menus'){var item=D.menus.find(function(x){return x.id===id;});if(item)item.archived=1;}
    render();
}

function reviveItem(col,id){
    saveState('Restore item');
    if(col==='ings'){var item=D.ings.find(function(x){return x.id===id;});if(item)item.archived=0;}
    else if(col==='recs'){var item=D.recs.find(function(x){return x.id===id;});if(item)item.archived=0;}
    else if(col==='menus'){var item=D.menus.find(function(x){return x.id===id;});if(item)item.archived=0;}
    render();
}

function delItem(col,id){
    if(!confirm('Permanently delete this item?'))return;
    saveState('Delete item');
    if(col==='ings')D.ings=D.ings.filter(function(x){return x.id!==id;});
    else if(col==='recs')D.recs=D.recs.filter(function(x){return x.id!==id;});
    else if(col==='menus')D.menus=D.menus.filter(function(x){return x.id!==id;});
    render();
}

function closeModal(){document.getElementById('modal-o').classList.remove('open');}

function openAdd(){
    var m=document.getElementById('modal'),mo=document.getElementById('modal-o');
    var html='<div class="modal-t">Add New</div>';
    
    if(tab==='inventory'){
        html+='<p style="color:#a0aec0;font-size:calc(12px * var(--font-scale))">Expand a storage area and use the "+ Add Item" button inside.</p>';
        html+='<button class="btn btn-s" onclick="closeModal()" style="width:100%;margin-top:12px">Got it</button>';
    }else if(tab==='shopping'){
        html+='<div class="form-g"><label class="form-l">Ingredient</label><select id="add-shop-ing" class="form-i">';
        html+='<option value="">Select ingredient...</option>';
        D.cats.forEach(function(cat){
            var catIngs=D.ings.filter(function(i){return !i.archived && i.catId===cat.id;});
            if(catIngs.length){
                html+='<optgroup label="'+cat.name+'">';
                catIngs.forEach(function(ing){html+='<option value="'+ing.id+'">'+ing.name+'</option>';});
                html+='</optgroup>';
            }
        });
        var uncatIngs=D.ings.filter(function(i){return !i.archived && !i.catId;});
        if(uncatIngs.length){
            html+='<optgroup label="Other">';
            uncatIngs.forEach(function(ing){html+='<option value="'+ing.id+'">'+ing.name+'</option>';});
            html+='</optgroup>';
        }
        html+='</select></div>';
        html+='<div class="form-g"><label class="form-l">Quantity</label><input type="number" id="add-shop-qty" class="form-i" placeholder="0"></div>';
        html+='<div class="form-g"><label class="form-l">Unit</label><select id="add-shop-unit" class="form-i">';
        getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
        html+='</select></div>';
        html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="addShopItem()" style="flex:1">Add</button></div>';
    }else if(tab==='prep'){
        html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="add-prep-name" class="form-i" placeholder="Prep item name"></div>';
        html+='<div class="form-g"><label class="form-l">Recipe (optional)</label><select id="add-prep-rec" class="form-i"><option value="">None</option>';
        D.recs.filter(function(r){return !r.archived;}).forEach(function(r){html+='<option value="'+r.id+'">'+r.name+'</option>';});
        html+='</select></div>';
        html+='<div class="form-g"><label class="form-l">Target Quantity</label><input type="number" id="add-prep-tgt" class="form-i" placeholder="0"></div>';
        html+='<div class="form-g"><label class="form-l">Unit</label><select id="add-prep-unit" class="form-i">';
        getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
        html+='</select></div>';
        html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="addPrepItem()" style="flex:1">Add</button></div>';
    }else if(tab==='ingredients'){
        html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="add-name" class="form-i" placeholder="Ingredient name"></div>';
        html+='<div class="form-g"><label class="form-l">Category</label><select id="add-cat" class="form-i">';
        D.cats.forEach(function(cat){html+='<option value="'+cat.id+'">'+cat.name+'</option>';});
        html+='</select></div>';
        html+='<div class="form-g"><label class="form-l">Storage Area</label><select id="add-area" class="form-i" onchange="updateSubAreaOptions()">';
        html+='<option value="0">-- Not assigned --</option>';
        D.areas.forEach(function(area){html+='<option value="'+area.id+'">'+area.name+'</option>';});
        html+='</select></div>';
        html+='<div class="form-g" id="sub-area-group" style="display:none"><label class="form-l">Sub-Area / Section</label><select id="add-sub-area" class="form-i"><option value="">-- None --</option></select></div>';
        html+='<div class="form-g"><label class="form-l">Recipe Unit (used in recipes)</label><select id="add-unit" class="form-i" onchange="updateAddConvRecipeUnit()">';
        getSortedUnits().forEach(function(u){html+='<option value="'+u.abbr+'">'+u.abbr+'</option>';});
        html+='</select></div>';
        // Storage to Recipe unit conversion
        html+='<div class="form-g" style="padding:12px;background:rgba(108,92,231,.1);border-radius:8px;border:1px solid rgba(108,92,231,.3)"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="add-has-conversion" onchange="toggleAddConversionFields()"><span style="font-size:calc(12px * var(--font-scale));color:#6c5ce7;font-weight:600">üìê Storage ‚Üí Recipe Conversion</span></label><div class="card-s" style="margin-top:4px">Define how storage units convert to recipe units (e.g., 1 bottle = 25 fl oz)</div></div>';
        html+='<div id="add-conversion-wrap" style="display:none;margin-top:8px;padding:12px;background:rgba(0,0,0,.2);border-radius:8px">';
        html+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">';
        html+='<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">1</span>';
        html+='<input type="text" id="add-storage-unit" class="form-i" placeholder="bottle" style="width:80px;font-size:calc(11px * var(--font-scale))">';
        html+='<span style="color:#a0aec0;font-size:calc(11px * var(--font-scale))">=</span>';
        html+='<input type="number" id="add-conv-factor" class="form-i" placeholder="25" style="width:60px;font-size:calc(11px * var(--font-scale))">';
        html+='<span id="add-conv-recipe-unit" style="color:#6c5ce7;font-size:calc(11px * var(--font-scale));font-weight:600">ea</span>';
        html+='</div></div>';
        // Stand Alone option
        html+='<div class="form-g" style="padding:12px;background:rgba(253,203,110,.1);border-radius:8px;border:1px solid rgba(253,203,110,.3);margin-top:12px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="add-standalone" onchange="toggleAddStandaloneFields()"><span style="font-size:calc(12px * var(--font-scale));color:#fdcb6e;font-weight:600">‚≠ê Standalone Item</span></label><div class="card-s" style="margin-top:4px">Track this item independently with its own minimum quantity</div></div>';
        html+='<div class="form-g" id="add-min-qty-wrap" style="display:none"><label class="form-l">Minimum Required Quantity</label><input type="number" id="add-minqty" class="form-i" value="0" placeholder="0"></div>';
        html+='<div class="form-g" id="add-auto-shop-wrap" style="display:none"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="add-autoshop" checked><span style="font-size:calc(11px * var(--font-scale));color:#00b894">üõí Auto-add to Shopping List when below minimum</span></label></div>';
        html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="addIng()" style="flex:1">Add</button></div>';
    }else if(tab==='recipes'){
        html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="add-rec-name" class="form-i" placeholder="Recipe name"></div>';
        html+='<div class="form-g"><label class="form-l">Group</label><input type="text" id="add-rec-group" class="form-i" placeholder="e.g. Mix, Filling, Dough"></div>';
        html+='<div class="form-g"><label class="form-l">Category</label><select id="add-rec-cat" class="form-i"><option value="">Uncategorized</option>';
        D.menuCats.forEach(function(cat){html+='<option value="'+cat.id+'">'+cat.name+'</option>';});
        html+='</select></div>';
        html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="addRec()" style="flex:1">Add</button></div>';
    }else if(tab==='menu'){
        html+='<div class="form-g"><label class="form-l">Name</label><input type="text" id="add-menu-name" class="form-i" placeholder="Menu item name"></div>';
        html+='<div class="form-g"><label class="form-l">Category</label><select id="add-menu-cat" class="form-i">';
        D.menuCats.forEach(function(cat){html+='<option value="'+cat.id+'">'+cat.name+'</option>';});
        html+='</select></div>';
        html+='<div class="form-g"><label class="form-l">Target Quantity</label><input type="number" id="add-menu-tgt" class="form-i" placeholder="0"></div>';
        html+='<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-s" onclick="closeModal()" style="flex:1">Cancel</button><button class="btn btn-p" onclick="addMenuItem()" style="flex:1">Add</button></div>';
    }
    
    m.innerHTML=html;
    mo.classList.add('open');
}

function addShopItem(){
    var ingId=+document.getElementById('add-shop-ing').value;
    var qty=+document.getElementById('add-shop-qty').value;
    var unit=document.getElementById('add-shop-unit').value;
    if(!ingId||!qty){alert('Fill all fields');return;}
    saveState('Add to shopping list');
    D.shopping.push({id:nid++,ingId:ingId,qty:qty,unit:unit,checked:0,savedForLater:0});
    closeModal();
    render();
}

function addPrepItem(){
    var name=document.getElementById('add-prep-name').value;
    var recId=+document.getElementById('add-prep-rec').value||0;
    var tgt=+document.getElementById('add-prep-tgt').value||0;
    var unit=document.getElementById('add-prep-unit').value;
    if(!name){alert('Enter a name');return;}
    saveState('Add prep item');
    D.preps.push({id:nid++,name:name,recId:recId,onHand:0,tgt:tgt,unit:unit});
    closeModal();
    render();
}

function updateSubAreaOptions(){
    var areaId=+document.getElementById('add-area').value;
    var subAreaGroup=document.getElementById('sub-area-group');
    var subAreaSelect=document.getElementById('add-sub-area');

    if(!areaId){
        subAreaGroup.style.display='none';
        return;
    }

    var area=D.areas.find(function(a){return a.id===areaId;});
    if(area && area.sections && area.sections.length > 0){
        subAreaGroup.style.display='block';
        var opts='<option value="">-- None --</option>';
        area.sections.forEach(function(s){opts+='<option value="'+s+'">'+s+'</option>';});
        subAreaSelect.innerHTML=opts;
    }else{
        subAreaGroup.style.display='none';
    }
}

function toggleAddStandaloneFields(){
    var cb=document.getElementById('add-standalone');
    var minWrap=document.getElementById('add-min-qty-wrap');
    var autoShopWrap=document.getElementById('add-auto-shop-wrap');
    if(minWrap&&cb)minWrap.style.display=cb.checked?'block':'none';
    if(autoShopWrap&&cb)autoShopWrap.style.display=cb.checked?'block':'none';
}

function toggleAddConversionFields(){
    var wrap=document.getElementById('add-conversion-wrap');
    var cb=document.getElementById('add-has-conversion');
    if(wrap&&cb)wrap.style.display=cb.checked?'block':'none';
    // Update the recipe unit display when unit changes
    updateAddConvRecipeUnit();
}

function updateAddConvRecipeUnit(){
    var recipeUnit=document.getElementById('add-unit');
    var display=document.getElementById('add-conv-recipe-unit');
    if(recipeUnit&&display)display.textContent=recipeUnit.value;
}

function addIng(){
    var name=document.getElementById('add-name').value;
    var catId=+document.getElementById('add-cat').value;
    var areaId=+document.getElementById('add-area').value||0;
    var subAreaEl=document.getElementById('add-sub-area');
    var subArea=subAreaEl ? subAreaEl.value : '';
    var defUnit=document.getElementById('add-unit').value;
    var standaloneEl=document.getElementById('add-standalone');
    var standalone=standaloneEl && standaloneEl.checked ? 1 : 0;
    var minQtyEl=document.getElementById('add-minqty');
    var minQty=minQtyEl ? +minQtyEl.value || 0 : 0;
    var autoShopEl=document.getElementById('add-autoshop');
    var autoShop=autoShopEl && autoShopEl.checked ? 1 : 0;
    if(!name){alert('Enter a name');return;}
    saveState('Add ingredient');
    var ingId=nid++;
    D.ings.push({id:ingId,name:name,catId:catId,areaId:areaId,subArea:subArea,defUnit:defUnit,archived:0,standalone:standalone,minQty:minQty,autoShop:autoShop});

    // Check if conversion was specified
    var hasConvEl=document.getElementById('add-has-conversion');
    if(hasConvEl && hasConvEl.checked){
        var storageUnit=document.getElementById('add-storage-unit').value.trim();
        var factor=+document.getElementById('add-conv-factor').value||0;
        if(storageUnit && factor > 0){
            // Create conversion
            var convId=nid++;
            if(!D.conversions)D.conversions=[];
            D.conversions.push({
                id:convId,
                ingId:ingId,
                storageUnit:storageUnit,
                recipeUnit:defUnit,
                factor:factor
            });
            // Track change for sync
            if(typeof changeLog !== 'undefined' && changeLog.conversions){
                changeLog.conversions.add(convId);
            }
        }
    }

    closeModal();
    render();
}

function addRec(){
    var name=document.getElementById('add-rec-name').value;
    var group=document.getElementById('add-rec-group').value;
    var catId=+document.getElementById('add-rec-cat').value||0;
    if(!name){alert('Enter a name');return;}
    saveState('Add recipe');
    D.recs.push({id:nid++,name:name,group:group,catId:catId,yield:98,yieldUnit:'',shelfLife:'',notes:'',ings:[],preps:[],subRecs:[],photos:[],videos:[],archived:0});
    closeModal();
    render();
}

function addMenuItem(){
    var name=document.getElementById('add-menu-name').value;
    var catId=+document.getElementById('add-menu-cat').value;
    var tgt=+document.getElementById('add-menu-tgt').value||0;
    if(!name){alert('Enter a name');return;}
    saveState('Add menu item');
    D.menus.push({id:nid++,name:name,catId:catId,tgt:tgt,unitId:1,ings:[],recs:[],archived:0,includeInShop:1,includeInPrep:0});
    closeModal();
    render();
}

// Initialize
var DATA_VERSION=3; // Increment when default data structure changes

document.addEventListener('DOMContentLoaded',async function(){
    // Load font scale from localStorage
    try{
        var savedScale=localStorage.getItem('ro_fontScale');
        if(savedScale){D.fontScale=+savedScale;}
    }catch(e){}
    
    // Check URL for password recovery tokens BEFORE initializing auth
    // Also check sessionStorage (set by early script before Supabase clears URL)
    var hashParams = new URLSearchParams(window.location.hash.substring(1));
    var queryParams = new URLSearchParams(window.location.search);
    var isRecoveryInSession = sessionStorage.getItem('ro_password_recovery') === 'true';
    if(hashParams.get('type') === 'recovery' || queryParams.get('type') === 'recovery' || isRecoveryInSession){
        window.isPasswordRecovery = true;
        console.log('Password recovery detected (URL or session)');
    }
    
    // Initialize Supabase (uses dynamic import)
    var supabaseReady = await initSupabase();
    
    // Check for existing Supabase session
    if(supabaseReady && supabase){
        // Listen for auth state changes
        supabase.auth.onAuthStateChange(onAuthStateChange);
        
        // Check current session
        var session = await supabase.auth.getSession();
        if(session.data.session){
            onAuthStateChange('SIGNED_IN', session.data.session);
        }else{
            // No session - show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        
        // Auto-sync every hour (3600000ms = 1 hour)
        setInterval(function(){
            if(currentAuthUser && supabase){
                console.log('Auto-sync triggered (hourly)');
                syncNow();
            }
        }, 3600000);
    }else{
        // Supabase not available - use local mode
        console.log('Supabase not available, using local mode');
        loadAllDataLocal();
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        render();
    }
    
    updateScrollHints();
    document.getElementById('tabs-wrap').addEventListener('scroll',updateScrollHints);
});

function loadAllDataLocal(){
    try{
        console.log('loadAllDataLocal called, D.recs before:', D.recs.length);
        var savedData=localStorage.getItem('ro_allData');
        var savedVersion=localStorage.getItem('ro_dataVersion');
        if(savedData){
            var parsed=JSON.parse(savedData);
            console.log('localStorage has recs:', parsed.recs ? parsed.recs.length : 'undefined');
            // Merge saved data with defaults (keeps new items from app updates)
            mergeData(parsed);
        }
        console.log('After mergeData, D.recs:', D.recs.length);
        var savedScale=localStorage.getItem('ro_fontScale');
        if(savedScale){D.fontScale=+savedScale;}
    }catch(e){console.error('Load error:',e);}
}

function mergeData(saved){
    // Merge saved data with defaults - saved data takes priority but defaults fill gaps

    if(saved.autoAddToInv!==undefined)D.autoAddToInv=saved.autoAddToInv;

    // For most arrays - use saved data if it has items, otherwise keep defaults
    ['users','areas','cats','menuCats','recCats','units','inv','shopping','preps','log'].forEach(function(key){
        if(saved[key] && saved[key].length > 0) D[key]=saved[key];
    });

    // For ings and recs - use saved data directly (don't re-add deleted defaults)
    // Defaults are only used for initial setup when no saved data exists
    if(saved.ings && saved.ings.length > 0){
        D.ings = saved.ings.slice();
    }

    if(saved.recs && saved.recs.length > 0){
        D.recs = saved.recs.slice();
    }

    if(saved.menus){
        if(saved.menus.length > 0){
            D.menus = saved.menus;
        }
    }

    // Initialize recCats if not present
    if(!D.recCats || !D.recCats.length) D.recCats = [{id:1,name:'Fillings'},{id:2,name:'Doughs'},{id:3,name:'Sauces'},{id:4,name:'Cocktails'},{id:5,name:'Desserts'},{id:6,name:'Brunch'}];

    // Migrate menu data to new format if needed
    migrateMenuData();
}

function saveAllData(){
    // Always save to localStorage as backup (fast)
    saveAllDataLocal();
}

function saveAllDataLocal(){
    try{
        var dataToSave={
            users:D.users,
            areas:D.areas,
            cats:D.cats,
            menuCats:D.menuCats,
            recCats:D.recCats,
            units:D.units,
            ings:D.ings,
            inv:D.inv,
            shopping:D.shopping,
            preps:D.preps,
            recs:D.recs,
            menus:D.menus,
            conversions:D.conversions||[],
            log:D.log,
            autoAddToInv:D.autoAddToInv,
            lastSaved:new Date().toISOString()
        };
        localStorage.setItem('ro_allData',JSON.stringify(dataToSave));
        localStorage.setItem('ro_dataVersion',DATA_VERSION);
    }catch(e){console.error('Local save error:',e);}
}

var saveDebounceTimer=null;
var pendingSupabaseSave=false;

// Change tracking - only sync what has changed
var changeLog = {
    areas: new Set(),
    cats: new Set(),
    menuCats: new Set(),
    recCats: new Set(),
    units: new Set(),
    ings: new Set(),
    inv: new Set(),
    shopping: new Set(),
    preps: new Set(),
    recs: new Set(),
    menus: new Set(),
    conversions: new Set(),
    settings: false,
    log: new Set()
};

// Deletion tracking
var deleteLog = {
    areas: new Set(),
    cats: new Set(),
    menuCats: new Set(),
    recCats: new Set(),
    units: new Set(),
    ings: new Set(),
    inv: new Set(),
    shopping: new Set(),
    preps: new Set(),
    recs: new Set(),
    menus: new Set(),
    conversions: new Set()
};

function markChanged(table, id){
    if(table === 'settings'){
        changeLog.settings = true;
    } else if(changeLog[table]){
        if(id !== undefined){
            changeLog[table].add(id);
        }
    }
}

function markDeleted(table, id){
    if(deleteLog[table] && id !== undefined){
        deleteLog[table].add(id);
        // Remove from change log if present
        if(changeLog[table]) changeLog[table].delete(id);
    }
}

function markTableChanged(table, ids){
    if(changeLog[table] && Array.isArray(ids)){
        ids.forEach(function(id){ changeLog[table].add(id); });
    }
}

function hasChanges(){
    if(changeLog.settings) return true;
    for(var table in changeLog){
        if(table !== 'settings' && changeLog[table].size > 0) return true;
    }
    for(var table in deleteLog){
        if(deleteLog[table].size > 0) return true;
    }
    return false;
}

function clearChangeLog(){
    for(var table in changeLog){
        if(table === 'settings'){
            changeLog.settings = false;
        } else {
            changeLog[table].clear();
        }
    }
    for(var table in deleteLog){
        deleteLog[table].clear();
    }
}

function getChangedItems(table, allItems, mapFn){
    var changedIds = changeLog[table];
    if(!changedIds || changedIds.size === 0) return [];
    var changed = allItems.filter(function(item){ return changedIds.has(item.id); });
    return mapFn ? changed.map(mapFn) : changed;
}

function getDeletedIds(table){
    return deleteLog[table] ? Array.from(deleteLog[table]) : [];
}

// Only call this when data actually changes (from saveState)
function queueSupabaseSave(){
    if(!supabase||!currentAuthUser){
        return;
    }
    if(!initialLoadComplete){
        return; // Don't try to sync until initial load is done
    }
    pendingSupabaseSave=true;
    showSyncStatus('unsaved');
    
    // Debounce - wait 2 seconds of inactivity before saving to cloud
    if(saveDebounceTimer)clearTimeout(saveDebounceTimer);
    saveDebounceTimer=setTimeout(async function(){
        if(!pendingSupabaseSave)return;
        pendingSupabaseSave=false;
        
        // Detect what actually changed since last sync
        detectAllChanges();
        
        if(!hasChanges()){
            console.log('No changes detected, showing synced');
            showSyncStatus('synced');
            return;
        }
        
        showSyncStatus('syncing');
        console.log('Syncing changes:', JSON.stringify({
            areas: changeLog.areas.size,
            cats: changeLog.cats.size,
            menuCats: changeLog.menuCats.size,
            recCats: changeLog.recCats.size,
            units: changeLog.units.size,
            ings: changeLog.ings.size,
            inv: changeLog.inv.size,
            shopping: changeLog.shopping.size,
            preps: changeLog.preps.size,
            recs: changeLog.recs.size,
            menus: changeLog.menus.size,
            settings: changeLog.settings
        }));
        
        try{
            var promises = [];
            
            // Only sync tables that have changes
            if(changeLog.areas.size > 0){
                var items = getChangedItems('areas', D.areas, mapAreaToDb);
                if(items.length) promises.push(supabase.from('areas').upsert(items));
            }
            if(deleteLog.areas.size > 0){
                promises.push(supabase.from('areas').delete().in('id', getDeletedIds('areas')));
            }
            
            if(changeLog.cats.size > 0){
                var items = getChangedItems('cats', D.cats);
                if(items.length) promises.push(supabase.from('cats').upsert(items));
            }
            if(deleteLog.cats.size > 0){
                promises.push(supabase.from('cats').delete().in('id', getDeletedIds('cats')));
            }
            
            if(changeLog.menuCats.size > 0){
                var items = getChangedItems('menuCats', D.menuCats, function(c){return{id:c.id,name:c.name};});
                if(items.length) promises.push(supabase.from('menu_cats').upsert(items));
            }
            if(deleteLog.menuCats.size > 0){
                promises.push(supabase.from('menu_cats').delete().in('id', getDeletedIds('menuCats')));
            }
            
            if(changeLog.recCats.size > 0){
                var items = getChangedItems('recCats', D.recCats, function(c){return{id:c.id,name:c.name};});
                if(items.length) promises.push(supabase.from('rec_cats').upsert(items));
            }
            if(deleteLog.recCats.size > 0){
                promises.push(supabase.from('rec_cats').delete().in('id', getDeletedIds('recCats')));
            }
            
            if(changeLog.units.size > 0){
                var items = getChangedItems('units', D.units);
                if(items.length) promises.push(supabase.from('units').upsert(items));
            }
            if(deleteLog.units.size > 0){
                promises.push(supabase.from('units').delete().in('id', getDeletedIds('units')));
            }
            
            if(changeLog.ings.size > 0){
                var items = getChangedItems('ings', D.ings, mapIngToDb);
                if(items.length) promises.push(supabase.from('ings').upsert(items));
            }
            if(deleteLog.ings.size > 0){
                promises.push(supabase.from('ings').delete().in('id', getDeletedIds('ings')));
            }
            
            if(changeLog.inv.size > 0){
                var items = getChangedItems('inv', D.inv, mapInvToDb);
                if(items.length) promises.push(supabase.from('inv').upsert(items));
            }
            if(deleteLog.inv.size > 0){
                promises.push(supabase.from('inv').delete().in('id', getDeletedIds('inv')));
            }
            
            if(changeLog.shopping.size > 0){
                var items = getChangedItems('shopping', D.shopping, mapShoppingToDb);
                if(items.length) promises.push(supabase.from('shopping').upsert(items));
            }
            if(deleteLog.shopping.size > 0){
                promises.push(supabase.from('shopping').delete().in('id', getDeletedIds('shopping')));
            }
            
            if(changeLog.preps.size > 0){
                var items = getChangedItems('preps', D.preps, mapPrepToDb);
                if(items.length) promises.push(supabase.from('preps').upsert(items));
            }
            if(deleteLog.preps.size > 0){
                promises.push(supabase.from('preps').delete().in('id', getDeletedIds('preps')));
            }
            
            if(changeLog.recs.size > 0){
                var items = getChangedItems('recs', D.recs, mapRecToDb);
                if(items.length) promises.push(supabase.from('recs').upsert(items));
            }
            if(deleteLog.recs.size > 0){
                promises.push(supabase.from('recs').delete().in('id', getDeletedIds('recs')));
            }
            
            if(changeLog.menus.size > 0){
                var items = getChangedItems('menus', D.menus, mapMenuToDb);
                if(items.length) promises.push(supabase.from('menus').upsert(items));
            }
            if(deleteLog.menus.size > 0){
                promises.push(supabase.from('menus').delete().in('id', getDeletedIds('menus')));
            }
            
            if(changeLog.settings){
                promises.push(supabase.from('settings').upsert({id:1,key:'autoAddToInv',value:D.autoAddToInv?true:false}));
            }
            
            if(promises.length > 0){
                await Promise.all(promises);
                console.log('Synced', promises.length, 'operations');
            }
            
            clearChangeLog();
            takeSyncSnapshot(); // Update snapshot after successful sync
            showSyncStatus('synced');
        }catch(err){
            console.error('Supabase save error:',err);
            showSyncStatus('offline');
        }
    },2000); // Wait 2 seconds of inactivity before cloud save
}

// Save to localStorage after render (fast), queue cloud save only on data changes
var origRender=render;
render=function(){
    origRender();
    saveAllDataLocal(); // Fast local save
    queueSupabaseSave(); // Queue cloud sync (debounced)
};

document.getElementById('modal-o').addEventListener('click',function(e){if(e.target.id==='modal-o')closeModal();});

function scrollTabs(dir){
    var wrap=document.getElementById('tabs-wrap');
    wrap.scrollBy({left:dir*120,behavior:'smooth'});
}

function updateScrollHints(){
    // Always keep arrows visible
    var wrap=document.getElementById('tabs-wrap');
    var left=document.getElementById('scroll-left');
    var right=document.getElementById('scroll-right');
    if(left)left.style.opacity='1';
    if(right)right.style.opacity='1';
}

function toggleFontControl(){
    var bar=document.getElementById('font-control-bar');
    bar.classList.toggle('open');
}

function setFontScale(val){
    D.fontScale=+val;
    document.documentElement.style.setProperty('--font-scale',val);
    document.getElementById('font-scale-val').textContent=Math.round(val*100)+'%';
    try{localStorage.setItem('ro_fontScale',val);}catch(e){}
}
</script>
</body>
</html>